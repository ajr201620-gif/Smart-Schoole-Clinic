<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุจูุงุจุฉ ููู ุงูุฃูุฑ โ ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</title>
  <link rel="stylesheet" href="app.css" />
</head>

<body data-page="parent">

  <!-- Topbar (matches app.css) -->
  <header class="topbar">
    <div class="inner">
      <div class="topbar_left">
        <a class="btn ghost" href="index.html">โฉ๏ธ ุงูุฑุฆูุณูุฉ</a>

        <div class="brand">
          <div class="brand__logo"></div>
          <div class="brand__txt">
            <div class="brand__name">ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</div>
            <div class="brand__sub">ุจูุงุจุฉ ููู ุงูุฃูุฑ โข ููุงููุงุช โข ูุชุงุจุนุฉ</div>
          </div>
        </div>

        <div class="pill">
          <small>ุงูุฏูุฑ</small>
          <b data-user-role>parent</b>
        </div>
      </div>

      <div class="topbar_right">
        <div class="pill">
          <small>ูุฑุญุจูุง</small>
          <b data-user-name>ููู ุฃูุฑ</b>
        </div>
        <button class="btn ghost" id="btnTheme" data-action="common:theme-toggle">๐</button>
        <button class="btn bad" id="btnLogout" data-action="common:logout">ุฎุฑูุฌ</button>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- Hero -->
    <section class="panel hero">
      <div class="heroRow">
        <div>
          <div class="heroTitle">ููุง ุชุฑุงูุจโฆ ูุชูุงููโฆ ูุชุทูู โ</div>
          <div class="heroDesc">
            ูุฐู ุงูุตูุญุฉ ุชุนุฑุถ ุขุฎุฑ ุญุงูุฉ ูุณุฌูุฉ ููุทุงูุจ (ุชุฌุฑูุจู ูุญูููุง)ุ ูุชุณูุญ ูู ุจุงูููุงููุฉ ุนูู ุงูุฒูุงุฑุฉ ุฃู ุทูุจ ุฒูุงุฑุฉ ุฅุถุงููุฉ.
            *ูุง ุชููู: ูุง ุฑุงุญ ูุฎูู ููู ุงูุฃูุฑ โุฒุฑ ููุงููุฉ ูุจุณโ ๐*
          </div>

          <div class="heroActions mt12">
            <button class="btn primary" id="btnApproveConsent" data-action="parent:approve-consent">โ ููุงููุฉ ููู ุงูุฃูุฑ</button>
            <button class="btn" id="btnRequestVisit" data-action="parent:request-visit">๐ ุทูุจ ุฒูุงุฑุฉ</button>
            <button class="btn ghost" id="btnReport" data-action="common:download-report">โฌ๏ธ ุชูุฒูู ุชูุฑูุฑ</button>
          </div>
        </div>

        <div class="kpiRow" style="min-width:320px;">
          <div class="kpi ok">
            <div class="kLabel">ุงูุญุงูุฉ</div>
            <div class="kVal" id="p_status">โ</div>
            <div class="kMeta">ุขุฎุฑ ุชุญุฏูุซ: <span id="p_updated">โ</span></div>
          </div>
          <div class="kpi">
            <div class="kLabel">ุงูุฃููููุฉ</div>
            <div class="kVal" id="p_priority">โ</div>
            <div class="kMeta">ูุณุชูู ุงููุฎุงุทุฑ: <span id="p_risk">โ</span></div>
          </div>
        </div>
      </div>
    </section>

    <div class="grid mt16">

      <!-- Summary -->
      <section class="panel card col-6">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">๐งพ</span> ููุฎุต ุงูุญุงูุฉ</div>
          <span class="chip" id="p_consentChip">Consent: โ</span>
        </div>

        <div class="cardBody">
          <div class="rowCard">
            <div class="rowTitle">ุดููู ุงูุทุงูุจ</div>
            <div class="rowMeta" id="p_symptoms">โ</div>
          </div>

          <div class="rowCard">
            <div class="rowTitle">ูุฑุงุฑ ุงููุฑุฒ / ุงูุทุจูุจ</div>
            <div class="rowMeta" id="p_decision">โ</div>
          </div>

          <div class="flex mt12">
            <a class="btn ghost" href="student.html">๐ ุตูุญุฉ ุงูุทุงูุจ</a>
            <a class="btn ghost" href="doctor.html">๐ฉบ ุตูุญุฉ ุงูุทุจูุจ</a>
            <a class="btn ghost" href="admin.html">๐ซ ููุญุฉ ุงูุฅุฏุงุฑุฉ</a>
            <a class="btn ghost" href="visit.html">๐ฅ ุบุฑูุฉ ุงูุฒูุงุฑุฉ</a>
          </div>
        </div>
      </section>

      <!-- Vitals -->
      <section class="panel card col-6">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">๐</span> ุงูููุงุณุงุช</div>
          <span class="chip warn">Demo</span>
        </div>

        <div class="cardBody">
          <div class="vitals">
            <div class="vital">
              <div class="vLabel">ูุจุถ ุงูููุจ</div>
              <div class="vVal" id="p_hr">โ</div>
            </div>
            <div class="vital">
              <div class="vLabel">ุงูุฃูุณุฌูู</div>
              <div class="vVal" id="p_spo2">โ</div>
            </div>
            <div class="vital">
              <div class="vLabel">ุงูุญุฑุงุฑุฉ</div>
              <div class="vVal" id="p_temp">โ</div>
            </div>
            <div class="vital">
              <div class="vLabel">ุงูุถุบุท</div>
              <div class="vVal" id="p_bp">โ</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="subtle">
            ุฅุฐุง ุงูููุงุณุงุช ุบูุฑ ูุฑูุญุฉโฆ ุงุทูุจ ุฒูุงุฑุฉ ุฃู ุชูุงุตู ูุน ุงููุฏุฑุณุฉ/ุงูุนูุงุฏุฉ ููุฑูุง.
          </div>
        </div>
      </section>

      <!-- Timeline -->
      <section class="panel card col-8">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">๐งญ</span> ุงูุณุฌู ุงูุฒููู</div>
          <span class="chip">Timeline</span>
        </div>

        <div class="cardBody">
          <div id="p_timeline">
            <div class="subtle">ูุง ููุฌุฏ ุณุฌู ุจุนุฏ.</div>
          </div>
        </div>
      </section>

      <!-- Notifications -->
      <section class="panel card col-4">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">๐</span> ุชูุจููุงุช ููู ุงูุฃูุฑ</div>
          <span class="chip ok">Live</span>
        </div>

        <div class="cardBody">
          <div id="p_notify">
            <div class="subtle">ูุง ููุฌุฏ ุชูุจููุงุช ุญุงููุงู.</div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Scripts -->
  <script src="./bus.js"></script>
  <script src="./auth.js"></script>
  <script src="./sensor-sim.js"></script>

  <!-- Firebase init (module) -->
  <script type="module" src="./firebase-init.js"></script>

  <!-- Actions -->
  <script src="./actions.js"></script>

  <!-- Parent binder -->
  <script>
    (function(){
      "use strict";
      const $ = (s,r=document)=>r.querySelector(s);
      const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

      function chipForConsent(consent){
        const el = $("#p_consentChip");
        if(!el) return;
        el.className = "chip";
        if(consent === "approved"){ el.classList.add("ok"); el.textContent = "Consent: Approved"; return; }
        if(consent === "rejected"){ el.classList.add("bad"); el.textContent = "Consent: Rejected"; return; }
        el.classList.add("warn");
        el.textContent = "Consent: Pending";
      }

      function getLatestCase(){
        const DB = window.SSC?.db;
        if(!DB) return null;
        return DB.cases?.[0] || null;
      }

      function render(){
        const DB = window.SSC?.db;
        const c = getLatestCase();

        if(!DB || !c){
          $("#p_status").textContent = "ูุง ุชูุฌุฏ ุญุงูุฉ";
          $("#p_priority").textContent = "โ";
          $("#p_risk").textContent = "โ";
          $("#p_updated").textContent = "โ";
          $("#p_symptoms").textContent = "โ";
          $("#p_decision").textContent = "โ";
          chipForConsent(null);
          return;
        }

        $("#p_status").textContent = c.status || "โ";
        $("#p_priority").textContent = c.priority || "โ";
        $("#p_risk").textContent = c.risk || "โ";
        $("#p_updated").textContent = (c.timeline && c.timeline[0] && c.timeline[0].at) ? c.timeline[0].at : c.at;

        $("#p_symptoms").textContent = c.symptoms || "โ";
        $("#p_decision").textContent = c.decision || "โ";

        $("#p_hr").textContent = c.vitals?.hr ?? "โ";
        $("#p_spo2").textContent = c.vitals?.spo2 ?? "โ";
        $("#p_temp").textContent = c.vitals?.temp ?? "โ";
        $("#p_bp").textContent = c.vitals?.bp ?? "โ";

        chipForConsent(c.consent);

        const tl = $("#p_timeline");
        if(tl){
          const items = (c.timeline || []).slice(0,8);
          tl.innerHTML = items.length
            ? items.map(x => `
              <div class="rowCard">
                <div class="rowTitle">${esc(x.msg || "ุชุญุฏูุซ")}</div>
                <div class="rowMeta">${esc(x.at || "")}</div>
              </div>
            `).join("")
            : `<div class="subtle">ูุง ููุฌุฏ ุณุฌู ุจุนุฏ.</div>`;
        }

        const box = $("#p_notify");
        if(box){
          const items = (DB.notifications || []).filter(n => n.toRole === "parent").slice(0,8);
          box.innerHTML = items.length
            ? items.map(n => `
              <div class="rowCard">
                <div class="rowTitle">${esc(n.title)}</div>
                <div class="rowMeta">${esc(n.message)} โข <span class="subtle">${esc(n.at)}</span></div>
              </div>
            `).join("")
            : `<div class="subtle">ูุง ููุฌุฏ ุชูุจููุงุช ุญุงููุงู.</div>`;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        render();
        window.bus?.on?.("case:update", render);
        window.bus?.on?.("notify:update", render);
      });
    })();
  </script>
<script type="module" src="./firebase-init.js"></script>
<script src="./rbac.js"></script>
<script src="./actions.js"></script>
</body>
</html>
