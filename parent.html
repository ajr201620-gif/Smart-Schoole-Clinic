<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± â€” Smart School Clinic OS</title>

  <link rel="stylesheet" href="assets/css/app.css"/>

  <script src="js/bus.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/parent-summary.js"></script>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="logo">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
    <div class="brandText">
      <div class="name">Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</div>
      <div class="tagline">Ù…Ù„Ø®Øµ â€¢ ØªÙ‚Ø±ÙŠØ± Ø±Ø³Ù…ÙŠ â€¢ Ù…ÙˆØ§ÙÙ‚Ø©/Ø±ÙØ¶</div>
    </div>
  </div>
  <div class="topActions">
    <button class="btn ghost" onclick="location.href='index.html'">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
  </div>
</header>

<main class="container">

  <section class="panel">
    <div class="h">
      <h2>ğŸ‘€ Ø¢Ø®Ø± Ø­Ø§Ù„Ø©</h2>
      <div class="muted" id="caseMeta">â€”</div>
    </div>

    <div class="kpiGrid" style="margin-top:12px">
      <div class="kpi"><div class="k">Status</div><div class="v" id="pStatus">â€”</div></div>
      <div class="kpi"><div class="k">Priority</div><div class="v" id="pPri">â€”</div></div>
      <div class="kpi"><div class="k">Risk</div><div class="v" id="pRisk">â€”</div></div>
      <div class="kpi"><div class="k">Decision</div><div class="v" id="pDec">â€”</div></div>
    </div>

    <div class="sep"></div>

    <div class="row">
      <button class="btn ghost" id="btnSummary">ğŸ“Œ Ù…Ù„Ø®Øµ Ù…Ø¨Ø³Ø·</button>
      <button class="btn ghost" id="btnReport">ğŸ§¾ ØªÙ‚Ø±ÙŠØ± Ø±Ø³Ù…ÙŠ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn" id="btnConsentJump" style="display:none">âœ… ÙØªØ­ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¢Ù†</button>
    </div>

    <div class="sep"></div>

    <pre id="summaryOut" style="white-space:pre-wrap;font-size:12px"></pre>
  </section>

</main>

<script>
(function(){
  SCAUTH.requireRole("parent");
  const $ = (s)=>document.querySelector(s);

  function latestCase(){
    const bus = SCBUS.load();
    return (bus.cases||[])[0] || null;
  }

  function render(){
    const c = latestCase();
    if(!c){
      $("#caseMeta").textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª";
      return;
    }

    $("#caseMeta").textContent = `Case ${c.id} â€¢ Ø§Ù„Ø·Ø§Ù„Ø¨: ${c.studentName || "â€”"}`;
    $("#pStatus").textContent = c.status || "â€”";
    $("#pPri").textContent = c.priority || c.ai?.priority || "â€”";
    $("#pRisk").textContent = (c.riskScore ?? c.ai?.risk ?? "â€”") + "/100";
    $("#pDec").textContent = c.decision || c.ai?.recommendation || "â€”";

    $("#btnConsentJump").style.display = (c.status === "CONSENT_REQUIRED") ? "" : "none";
  }

  $("#btnSummary").addEventListener("click", ()=>{
    const c = latestCase();
    if(!c) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø©");
    $("#summaryOut").textContent = window.SCPARENT.sum(c);
  });

  $("#btnReport").addEventListener("click", ()=>{
    const c = latestCase();
    if(!c) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø©");
    location.href = `report-view.html?case=${encodeURIComponent(c.id)}&role=parent&autoprint=1`;
  });

  $("#btnConsentJump").addEventListener("click", ()=>{
    const c = latestCase();
    if(!c) return;
    location.href = `report-view.html?case=${encodeURIComponent(c.id)}&role=parent`;
  });

  render();
  setInterval(render, 1500);
})();
</script>
</body>
</html>
