<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Smart Clinic OS â€” Parent</title>
  <link rel="stylesheet" href="ar.css"/>
  <link rel="stylesheet" href="shell.css"/>
  <script src="bus.js"></script>
  <script src="rbac.js"></script>
</head>
<body>

<div class="sc-top">
  <div class="left">
    <span class="sc-chip">Parent</span>
    <div class="sc-title">
      <b>Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</b>
      <small>Ù…ÙˆØ§ÙÙ‚Ø§Øª + ØªÙ†Ø¨ÙŠÙ‡Ø§Øª + ØªÙ‚Ø§Ø±ÙŠØ±</small>
    </div>
  </div>
  <div class="sc-actions">
    <span class="sc-status" id="st">ğŸŸ¢ Ready</span>
    <a class="sc-primary" href="report.html#parent">ğŸ§¾ ØªÙ‚Ø±ÙŠØ±</a>
  </div>
</div>

<div class="sc-shell">
  <aside class="sc-side">
    <div class="sc-chip">Ø§Ù„ØªÙ†Ù‚Ù‘Ù„</div>
    <nav class="sc-nav">
      <a class="sc-nav-item" href="index.html">ğŸ  Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</a>
      <a class="sc-nav-item" href="#consent">âœ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª</a>
      <a class="sc-nav-item" href="#cases">ğŸ©º Ø§Ù„Ø­Ø§Ù„Ø§Øª</a>
      <a class="sc-nav-item" href="report.html#parent">ğŸ§¾ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
    </nav>
    <div style="margin-top:14px" class="sc-chip">Quick</div>
    <div class="sc-quick">
      <button class="sc-qa" id="btnRefresh">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </div>
  </aside>

  <main class="sc-main">
    <div style="padding:16px">

      <div class="panel" id="consent">
        <div class="h"><h2>Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù…Ø¹Ù„Ù‘Ù‚Ø©</h2><div class="muted">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¥Ø¬Ø±Ø§Ø¡/Ø²ÙŠØ§Ø±Ø©/Ø¥Ø­Ø§Ù„Ø©</div></div>
        <div id="consentList"></div>
      </div>

      <div class="panel" id="cases" style="margin-top:16px">
        <div class="h"><h2>Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø§Ø¨Ù† (Demo)</h2><div class="muted">Ø¹Ø±Ø¶ Ù…Ø¨Ø³Ø·</div></div>
        <div id="caseList"></div>
      </div>

    </div>
  </main>
</div>

<script>
localStorage.setItem("SC_ROLE","parent");
const $=(s)=>document.querySelector(s);

function saveCase(caseId, patch){
  const bus = window.SCBUS.load();
  const idx = (bus.cases||[]).findIndex(c=>c.id===caseId);
  if(idx<0) return;
  bus.cases[idx] = Object.assign({}, bus.cases[idx], patch);
  window.SCBUS.save(bus);
}

function refresh(){
  const bus = window.SCBUS?.load?.() || {cases:[]};
  const cases = bus.cases || [];

  const pending = cases.filter(c=>c.status==="CONSENT_REQUIRED" || c.parentJoinRequested);
  $("#consentList").innerHTML = pending.map(c=>{
    return `<div class="sc-nav-item" style="display:block">
      <div style="display:flex; justify-content:space-between; gap:10px">
        <b>Case ${c.id}</b>
        <span class="sc-chip">${c.status || (c.parentJoinRequested?"JOIN_REQ":"â€”")}</span>
      </div>
      <div class="muted small" style="margin-top:6px">${(c.plan||c.decision||"â€”")}</div>
      <div class="row" style="margin-top:10px">
        <button class="btn" data-yes="${c.id}">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
        <button class="btn ghost" data-no="${c.id}">â›” Ø±ÙØ¶</button>
      </div>
    </div>`;
  }).join("") || `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§ÙÙ‚Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;

  $("#caseList").innerHTML = cases.slice(0,8).map(c=>{
    return `<div class="sc-nav-item" style="justify-content:space-between">
      <span>Case ${c.id} â€¢ ${c.priority||"â€”"}</span>
      <span class="sc-chip">${c.status||"OPEN"}</span>
    </div>`;
  }).join("") || `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>`;
}

document.addEventListener("click",(e)=>{
  const y = e.target.closest("[data-yes]");
  const n = e.target.closest("[data-no]");
  if(y){
    const id = y.getAttribute("data-yes");
    saveCase(id, { consent:"APPROVED", status:"APPROVED_BY_PARENT" });
    alert("ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© âœ…");
    return refresh();
  }
  if(n){
    const id = n.getAttribute("data-no");
    saveCase(id, { consent:"REJECTED", status:"REJECTED_BY_PARENT" });
    alert("ØªÙ… Ø§Ù„Ø±ÙØ¶ â›”");
    return refresh();
  }
});

$("#btnRefresh").addEventListener("click", refresh);
refresh();
</script>
</body>
</html>
