<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุจูุงุจุฉ ููู ุงูุฃูุฑ โ Smart School Clinic OS</title>

  <link rel="stylesheet" href="app.css" />

<script src="bus.js"></script>
<script src="auth.js"></script>
<script src="protocols.js"></script>
<script src="parent-summary.js"></script>

<script src="actions.js"></script>
<script src="app-init.js"></script>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="logo">๐จโ๐ฉโ๐ง</div>
    <div class="brandText">
      <div class="name">ุจูุงุจุฉ ููู ุงูุฃูุฑ</div>
      <div class="tagline">ููุฎุต โข ุชูุฑูุฑ ุฑุณูู โข ููุงููุฉ/ุฑูุถ</div>
    </div>
  </div>
  <div class="topActions">
    <button class="btn ghost" onclick="location.href='index.html'">โฌ๏ธ ุฑุฌูุน</button>
  </div>
</header>
  <main class="page parent-page">

  <section class="card">
    <div class="row between">
      <h3>๐จโ๐ฉโ๐ฆ ุจูุงุจุฉ ููู ุงูุฃูุฑ</h3>
      <button class="btn ghost" data-action="parent.refresh">๐ ุชุญุฏูุซ</button>
    </div>

    <div class="grid-3" style="margin-top:10px;">
      <div><div class="label">ุขุฎุฑ ุญุงูุฉ</div><div class="value" id="pCaseId">โ</div></div>
      <div><div class="label">ุงูุญุงูุฉ</div><div class="value" id="pStatus">โ</div></div>
      <div><div class="label">ุงูุฃููููุฉ</div><div class="value" id="pPriority">โ</div></div>
    </div>
  </section>

  <section class="card">
    <h3>๐งพ ููุฎุต ุงูุทุจูุจ + AI</h3>
    <div class="label">ุงูุชูุตูุฉ</div>
    <div class="box" id="pRecommendation">โ</div>

    <div class="label" style="margin-top:10px;">ุงูุชุดุฎูุต/ุงูุฎุทุฉ</div>
    <div class="box" id="pDxPlan">โ</div>
  </section>

  <section class="card">
    <h3>โ ุงูููุงููุงุช</h3>
    <div class="row" style="gap:10px; flex-wrap:wrap;">
      <button class="btn success" data-action="parent.approveConsent">โ ููุงููุฉ ุนูู ุงูุฒูุงุฑุฉ</button>
      <button class="btn warn" data-action="parent.approveProcedure">๐ฉน ููุงููุฉ ุฅุฌุฑุงุก ุจุณูุท</button>
      <button class="btn danger" data-action="parent.decline">โ ุฑูุถ</button>
    </div>

    <div class="row" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
      <button class="btn primary" data-action="parent.joinVisit">๐ฅ ุงูุงูุถูุงู ููุฒูุงุฑุฉ ุงูุงูุชุฑุงุถูุฉ</button>
      <button class="btn ghost" data-action="parent.messageDoctor">๐ฌ ุฑุณุงูุฉ ููุทุจูุจ</button>
      <button class="btn ghost" data-action="parent.downloadReport">๐ ุชุญููู ุชูุฑูุฑ</button>
    </div>

    <div class="muted" id="pResult" style="margin-top:10px;"></div>
  </section>

</main>

<main class="container">

  <section class="panel">
    <div class="h">
      <h2>๐ ุขุฎุฑ ุญุงูุฉ</h2>
      <div class="muted" id="caseMeta">โ</div>
    </div>

    <div class="kpiGrid" style="margin-top:12px">
      <div class="kpi"><div class="k">Status</div><div class="v" id="pStatus">โ</div></div>
      <div class="kpi"><div class="k">Priority</div><div class="v" id="pPri">โ</div></div>
      <div class="kpi"><div class="k">Risk</div><div class="v" id="pRisk">โ</div></div>
      <div class="kpi"><div class="k">Decision</div><div class="v" id="pDec">โ</div></div>
    </div>

    <div class="sep"></div>

    <div class="row">
      <button class="btn ghost" id="btnSummary">๐ ููุฎุต ูุจุณุท</button>
      <button class="btn ghost" id="btnReport">๐งพ ุชูุฑูุฑ ุฑุณูู ููุทุจุงุนุฉ</button>
      <button class="btn" id="btnConsentJump" style="display:none">โ ูุชุญ ุงูููุงููุฉ ุงูุขู</button>
    </div>

    <div class="sep"></div>

    <pre id="summaryOut" style="white-space:pre-wrap;font-size:12px"></pre>
  </section>

</main>

<script>
(function(){
  SCAUTH.requireRole("parent");
  const $ = (s)=>document.querySelector(s);

  function latestCase(){
    const bus = SCBUS.load();
    return (bus.cases||[])[0] || null;
  }

  function render(){
    const c = latestCase();
    if(!c){
      $("#caseMeta").textContent = "ูุง ุชูุฌุฏ ุญุงูุงุช";
      return;
    }

    $("#caseMeta").textContent = `Case ${c.id} โข ุงูุทุงูุจ: ${c.studentName || "โ"}`;
    $("#pStatus").textContent = c.status || "โ";
    $("#pPri").textContent = c.priority || c.ai?.priority || "โ";
    $("#pRisk").textContent = (c.riskScore ?? c.ai?.risk ?? "โ") + "/100";
    $("#pDec").textContent = c.decision || c.ai?.recommendation || "โ";

    $("#btnConsentJump").style.display = (c.status === "CONSENT_REQUIRED") ? "" : "none";
  }

  $("#btnSummary").addEventListener("click", ()=>{
    const c = latestCase();
    if(!c) return alert("ูุง ุชูุฌุฏ ุญุงูุฉ");
    $("#summaryOut").textContent = window.SCPARENT.sum(c);
  });

  $("#btnReport").addEventListener("click", ()=>{
    const c = latestCase();
    if(!c) return alert("ูุง ุชูุฌุฏ ุญุงูุฉ");
    location.href = `report-view.html?case=${encodeURIComponent(c.id)}&role=parent&autoprint=1`;
  });

  $("#btnConsentJump").addEventListener("click", ()=>{
    const c = latestCase();
    if(!c) return;
    location.href = `report-view.html?case=${encodeURIComponent(c.id)}&role=parent`;
  });

  render();
  setInterval(render, 1500);
})();
</script>
</body>
</html>
