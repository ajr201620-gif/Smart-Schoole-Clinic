<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Clinic OS โ ุจูุงุจุฉ ููู ุงูุฃูุฑ</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <div class="logo">SC</div>
      <div>
        <div class="brand-title">Smart Clinic OS</div>
        <div class="brand-sub">Parent Portal โ ุจูุงุจุฉ ููู ุงูุฃูุฑ</div>
      </div>
    </div>

    <div class="top-actions">
      <button class="btn ghost" id="btnTheme" title="ุชุจุฏูู ุงููุถุน">๐</button>
      <button class="btn ghost" id="btnLinkChild">ุฑุจุท ุงูุงุจู/ุงูุงุจูุฉ (Demo)</button>
      <button class="btn" id="btnExportAll">ุชุตุฏูุฑ ููุฎุต</button>
    </div>
  </header>

  <div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="nav-title">ุงููุงุฆูุฉ</div>
      <nav class="nav" id="parNav">
        <button class="nav-item active" data-view="home"><span class="ico">๐</span><span>ุงูุฑุฆูุณูุฉ</span></button>
        <button class="nav-item" data-view="alerts"><span class="ico">๐</span><span>ุงูุชูุจููุงุช</span></button>
        <button class="nav-item" data-view="consent"><span class="ico">โ</span><span>ุงูููุงููุงุช</span></button>
        <button class="nav-item" data-view="report"><span class="ico">๐งพ</span><span>ุชูุงุฑูุฑ ุงูุงุจู</span></button>
        <button class="nav-item" data-view="profile"><span class="ico">๐งฌ</span><span>ููู ุตุญู</span></button>
        <button class="nav-item" data-view="history"><span class="ico">๐๏ธ</span><span>ุงูุณุฌู</span></button>
      </nav>

      <div class="sidebar-foot">
        <div class="pill">
          <span class="dot" id="dotLive"></span>
          <div>
            <div style="font-weight:1000;">System</div>
            <div class="muted small" id="sysStatus">System: Ready</div>
          </div>
        </div>

        <button class="btn ghost" id="btnRequestCall">ุทูุจ ุชูุงุตู ูู ุงูุนูุงุฏุฉ</button>

        <div class="divider"></div>
        <div class="muted small">
          * ูุณุฎุฉ ุชุฌุฑูุจูุฉ ููุนุฑุถ. ูู ุงููุณุฎุฉ ุงูุญููููุฉ: ุชูุซูู ููู ุงูุฃูุฑ ูุฑุจุท ุงูุทุงูุจ ุนุจุฑ ููุงุฐ/ุฃุจุดุฑ.
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">

      <!-- Hero -->
      <section class="hero">
        <div class="hero-left">
          <div class="kicker">๐จโ๐ฉโ๐ง Parent</div>
          <h1>ุจูุงุจุฉ ููู ุงูุฃูุฑ</h1>
          <p class="hero-desc">
            ุชูุจููุงุช ููุฑูุฉุ ููุงููุงุชุ ุชูุงุฑูุฑ ูุฎุชุตุฑุฉุ ูุชุญุฏูุซุงุช ุตุญูุฉ ูููุฉ ููุงุจู/ุงูุงุจูุฉ.
          </p>

          <div class="hero-cta">
            <button class="btn" id="btnOpenAlerts">ูุชุญ ุงูุชูุจููุงุช</button>
            <button class="btn ghost" id="btnOpenConsent">ูุชุญ ุงูููุงููุงุช</button>
          </div>

          <div class="hero-badges">
            <span class="badge">RBAC: Parent</span>
            <span class="badge ghost">Consent Workflow</span>
            <span class="badge">Audit Enabled</span>
          </div>
        </div>

        <div class="hero-right">
          <div class="scorecard">
            <div class="scorecard-head">
              <div>
                <div class="score-title">ุญุงูุฉ ุงูุงุจู ุงูููู</div>
                <div class="score-sub">Demo summary</div>
              </div>
              <div class="ring">
                <div class="ring-inner">
                  <div class="ring-num" id="kidState">OK</div>
                  <div class="ring-lbl">โ</div>
                </div>
              </div>
            </div>

            <div class="scorecard-grid">
              <div class="mini">
                <div class="mini-k">ุขุฎุฑ ุชูุจูู</div>
                <div class="mini-v" id="lastAlert">โ</div>
              </div>
              <div class="mini">
                <div class="mini-k">ููุงููุฉ ูุทููุจุฉ</div>
                <div class="mini-v" id="pendingConsent">1</div>
              </div>
              <div class="mini">
                <div class="mini-k">ุขุฎุฑ ุฒูุงุฑุฉ</div>
                <div class="mini-v" id="lastVisit">ุงูููู</div>
              </div>
              <div class="mini">
                <div class="mini-k">ุงููุชุงุจุนุฉ</div>
                <div class="mini-v" id="followUp">ุฅู ูุฒู</div>
              </div>
            </div>

            <div class="scorecard-foot muted small">* ุจูุงูุงุช ุชุฌุฑูุจูุฉ.</div>
          </div>
        </div>
      </section>

      <!-- Views -->
      <section class="views">

        <!-- HOME -->
        <section class="view show" id="view-home">
          <div class="section-head">
            <div>
              <h2>ุงูุฑุฆูุณูุฉ</h2>
              <div class="muted">ููุฎุต + ุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnRefresh">ุชุญุฏูุซ</button>
              <button class="btn" id="btnSimAlert">ูุญุงูุงุฉ ุชูุจูู (Demo)</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-head">
                <h3>ุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ</h3>
                <div class="muted small">Quick actions</div>
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn ghost" id="qAck">โ ุชุฃููุฏ ุงุณุชูุงู</button>
                <button class="btn ghost" id="qConsent">๐งพ ููุงููุฉ ุณุฑูุนุฉ</button>
                <button class="btn ghost" id="qReport">๐งพ ูุชุญ ุงูุชูุฑูุฑ</button>
                <button class="btn ghost" id="qProfile">๐งฌ ุชุญุฏูุซ ุงูููู ุงูุตุญู</button>
              </div>

              <div class="divider"></div>
              <div class="muted small">
                ูู ุฅุฌุฑุงุก ูุชู ุชุณุฌููู ูู Audit Log (Demo).
              </div>
            </div>

            <div class="card">
              <div class="card-head">
                <h3>ุฑุณุงูุฉ ุงูุนูุงุฏุฉ</h3>
                <div class="muted small">Clinic message</div>
              </div>

              <div class="tip" style="line-height:1.9;">
                ูู ุญุงู ูุฌูุฏ ุฃุนุฑุงุถ ูุณุชูุฑุฉ ุฃู ูุคุดุฑุงุช ุฎุทูุฑุฉุ ุณูุชู ุฅุดุนุงุฑู ูุฅุนุทุงุคู ุฎูุงุฑุงุช ุงูููุงููุฉ/ุงูุชุญููู.
              </div>

              <div class="card-actions">
                <button class="btn" id="btnRequestCall2">ุทูุจ ุชูุงุตู</button>
                <button class="btn ghost" id="btnOpenAlerts2">ุนุฑุถ ุงูุชูุจููุงุช</button>
              </div>
            </div>
          </div>
        </section>

        <!-- ALERTS -->
        <section class="view" id="view-alerts">
          <div class="section-head">
            <div>
              <h2>ุงูุชูุจููุงุช</h2>
              <div class="muted">ุฅุดุนุงุฑุงุช ุงูุนูุงุฏุฉ/ุงูุฅุฏุงุฑุฉ (Demo)</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnClearAlerts">ูุณุญ</button>
              <button class="btn" id="btnAckAll">ุชุฃููุฏ ุงููู</button>
            </div>
          </div>

          <div class="card">
            <div class="card-head">
              <h3>ูุงุฆูุฉ ุงูุชูุจููุงุช</h3>
              <div class="muted small">Local demo</div>
            </div>
            <div class="alerts" id="alertsList">
              <div class="empty">ูุง ุชูุฌุฏ ุชูุจููุงุช ุจุนุฏ</div>
            </div>
          </div>
        </section>

        <!-- CONSENT -->
        <section class="view" id="view-consent">
          <div class="section-head">
            <div>
              <h2>ุงูููุงููุงุช</h2>
              <div class="muted">Consent workflow (Demo)</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnGenConsent">ุฅูุดุงุก ููุงููุฉ (Demo)</button>
              <button class="btn" id="btnApprove">ููุงููุฉ</button>
              <button class="btn ghost" id="btnReject">ุฑูุถ</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-head">
                <h3>ุทูุจ ููุงููุฉ</h3>
                <div class="muted small" id="consentId">Consent: โ</div>
              </div>

              <div class="form">
                <label>ููุน ุงูููุงููุฉ</label>
                <select id="consentType">
                  <option value="clinic_visit">ุฒูุงุฑุฉ ุงูุนูุงุฏุฉ</option>
                  <option value="med_admin">ุฅุนุทุงุก ุฏูุงุก (ุญุณุจ ุณูุงุณุฉ ุงููุฏุฑุณุฉ)</option>
                  <option value="referral">ุฅุญุงูุฉ ููุฑูุฒ ุตุญู/ูุณุชุดูู</option>
                  <option value="emergency">ุฅุฌุฑุงุก ุนุงุฌู / ุทูุงุฑุฆ</option>
                </select>

                <label>ููุฎุต</label>
                <textarea id="consentSummary" rows="5" placeholder="ููุฎุต ุงูุญุงูุฉ + ุณุจุจ ุงูููุงููุฉ ุงููุทููุจุฉ..."></textarea>

                <label>ููุงุญุธุฉ ููู ุงูุฃูุฑ (ุงุฎุชูุงุฑู)</label>
                <input id="parentNote" placeholder="ูุซุงู: ูุฏูู ุญุณุงุณูุฉ ูู..." />
              </div>

              <div class="divider"></div>

              <div class="kvrow"><span class="muted">ุงูุญุงูุฉ:</span><b id="consentStatus">PENDING</b></div>
              <div class="kvrow"><span class="muted">ุงูููุช:</span><b id="consentTime">โ</b></div>
            </div>

            <div class="card">
              <div class="card-head">
                <h3>ุฅุฑุดุงุฏ</h3>
                <div class="muted small">Guidance</div>
              </div>

              <ul class="bullets">
                <li>ุงูุฑุฃ ุงูููุฎุต ุซู ูุงูู/ุงุฑูุถ.</li>
                <li>ูู ุงูุฅุญุงูุฉ: ุณูุชู ุชุฒููุฏู ุจุฎูุงุฑุงุช ุชูุงุตู (Demo).</li>
                <li>ูู ุฎุทูุฉ ุชูุณุฌู ูู Audit Log.</li>
              </ul>

              <div class="divider"></div>
              <div class="tip">๐ก ุชูุฏุฑ ุชุถูู โุญุณุงุณูุฉ/ูุฑุถ ูุฒููโ ูู ุงูููู ุงูุตุญู ูุชุธูุฑ ููุนูุงุฏุฉ ูุงุญููุง.</div>
            </div>
          </div>
        </section>

        <!-- REPORT -->
        <section class="view" id="view-report">
          <div class="section-head">
            <div>
              <h2>ุชูุงุฑูุฑ ุงูุงุจู</h2>
              <div class="muted">ููุฎุต ูุงุจู ููุชุตุฏูุฑ (Demo)</div>
            </div>
            <div class="section-actions">
              <button class="btn" id="btnExportTxt">ุชุตุฏูุฑ TXT</button>
              <button class="btn ghost" id="btnExportJson">ุชุตุฏูุฑ JSON</button>
            </div>
          </div>

          <div class="card report">
            <div class="report-title">Parent Summary Report โ Demo</div>
            <div class="report-meta">
              <span id="repChild">Child: โ</span> โข <span id="repDate">Date: โ</span>
            </div>
            <div class="report-body" id="repBody" style="line-height:1.95;"></div>
            <div class="report-foot muted small">* ุชูุฑูุฑ ุชุฌุฑูุจู ููุนุฑุถ.</div>
          </div>
        </section>

        <!-- PROFILE -->
        <section class="view" id="view-profile">
          <div class="section-head">
            <div>
              <h2>ููู ุตุญู</h2>
              <div class="muted">ูุนูููุงุช ูููุฉ ุชุธูุฑ ููุนูุงุฏุฉ (Demo)</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnSaveProfile">ุญูุธ</button>
              <button class="btn" id="btnClearProfile">ุชูุฑูุบ</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-head">
                <h3>ุจูุงูุงุช ุตุญูุฉ ุฃุณุงุณูุฉ</h3>
                <div class="muted small">Allergy / chronic</div>
              </div>

              <div class="form">
                <label>ุญุณุงุณูุฉ</label>
                <input id="allergy" placeholder="ูุซุงู: ุญุณุงุณูุฉ ุงูููู ุงูุณูุฏุงูู" />

                <label>ูุฑุถ ูุฒูู (ุฅู ูุฌุฏ)</label>
                <input id="chronic" placeholder="ูุซุงู: ุฑุจู" />

                <label>ุฃุฏููุฉ ุฏุงุฆูุฉ (ุงุฎุชูุงุฑู)</label>
                <input id="longMeds" placeholder="ูุซุงู: ุจุฎุงุฎ..." />

                <label>ููุงุญุธุงุช ูููุฉ</label>
                <textarea id="healthNotes" rows="4" placeholder="ุฃู ุดูุก ูุงุฒู ุงูุนูุงุฏุฉ ุชุนุฑูู..."></textarea>
              </div>

              <div class="divider"></div>
              <div class="muted small">* ูุชู ุญูุธ ุงููุนูููุงุช ูุญูููุง ููุนุฑุถ ููุท.</div>
            </div>

            <div class="card">
              <div class="card-head">
                <h3>ุงูุทูู/ุงูุทููุฉ</h3>
                <div class="muted small">Link child (demo)</div>
              </div>

              <div class="form">
                <label>Child ID (Demo)</label>
                <input id="childId" placeholder="STD-23" />
                <label>ุงูุงุณู</label>
                <input id="childName" placeholder="ุทุงูุจ #23" />
                <label>ุงููุฏุฑุณุฉ</label>
                <input id="schoolName" placeholder="ูุฏุฑุณุฉ A" />
              </div>

              <div class="card-actions">
                <button class="btn" id="btnAutoChild">ุชุนุจุฆุฉ</button>
                <button class="btn ghost" id="btnOpenReport">ูุชุญ ุงูุชูุฑูุฑ</button>
              </div>
            </div>
          </div>
        </section>

        <!-- HISTORY -->
        <section class="view" id="view-history">
          <div class="section-head">
            <div>
              <h2>ุงูุณุฌู</h2>
              <div class="muted">Alerts + Consents + Actions (local)</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnClearHistory">ูุณุญ</button>
              <button class="btn" id="btnExportHistory">ุชุตุฏูุฑ JSON</button>
            </div>
          </div>

          <div class="card">
            <div class="card-head">
              <h3>ุขุฎุฑ ุงูุฃูุดุทุฉ</h3>
              <div class="muted small">Local history</div>
            </div>
            <div class="table" id="histTable"></div>
          </div>
        </section>

      </section>
    </main>
  </div>

  <!-- Scripts -->
  <script src="bus.js"></script>
<script src="engine.js"></script>
<script src="rbac.js"></script>
<script src="auth-demo.js"></script>
<script src="audit-users.js"></script>

  <script>
    (function(){
      const ROLE_KEY = "sc_role";
      const HKEY = "sc_parent_history";
      const AKEY = "sc_parent_alerts";
      const PKEY = "sc_parent_profile";
      const CKEY = "sc_parent_consent";

      const $ = (s,r=document)=>r.querySelector(s);
      const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
      const pad2 = (n)=>String(n).padStart(2,"0");
      const time = ()=>{
        const d=new Date();
        return pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());
      };
      const today = new Date().toLocaleDateString("ar-SA");

      // Force role
      try{
        localStorage.setItem(ROLE_KEY, "parent");
        window.SCRBAC?.applyRBAC?.();
        window.SCAUDIT?.audit?.("PAGE_OPEN", { page:"parent.html" });
      }catch(_){}

      // Theme
      $("#btnTheme")?.addEventListener("click", ()=>{
        const html = document.documentElement;
        const next = html.dataset.theme === "light" ? "dark" : "light";
        html.dataset.theme = next;
        try{ window.SCAUDIT?.audit?.("THEME_TOGGLE", { to: next }); }catch(_){}
      });

      // nav
      function openView(view){
        $$("#parNav .nav-item").forEach(b=>b.classList.remove("active"));
        $(`#parNav .nav-item[data-view="${view}"]`)?.classList.add("active");
        $$(".view").forEach(v=>v.classList.remove("show"));
        $(`#view-${view}`)?.classList.add("show");
        try{ window.SCAUDIT?.audit?.("NAV_OPEN", { view }); }catch(_){}
      }
      $$("#parNav .nav-item").forEach(btn=>{
        btn.addEventListener("click", ()=> openView(btn.dataset.view));
      });

      $("#btnOpenAlerts")?.addEventListener("click", ()=> openView("alerts"));
      $("#btnOpenAlerts2")?.addEventListener("click", ()=> openView("alerts"));
      $("#btnOpenConsent")?.addEventListener("click", ()=> openView("consent"));

      // Local history
      function loadHist(){
        try{ return JSON.parse(localStorage.getItem(HKEY) || "[]"); }catch(_){ return []; }
      }
      function saveHist(rows){
        localStorage.setItem(HKEY, JSON.stringify(rows.slice(0,200)));
      }
      function addHist(type, meta={}){
        const rows = loadHist();
        rows.unshift({ t: time(), type, meta });
        saveHist(rows);
        renderHist();
        try{ window.SCAUDIT?.audit?.("PARENT_EVENT", { type, meta }); }catch(_){}
      }
      function renderHist(){
        const box = $("#histTable");
        if(!box) return;
        const rows = loadHist().slice(0,60);
        if(!rows.length){
          box.innerHTML = `<div class="empty">ูุง ููุฌุฏ ุณุฌู ุจุนุฏ</div>`;
          return;
        }
        box.innerHTML = `
          <div class="trow thead"><div>ุงูููุช</div><div>ุงูููุน</div><div colspan="3">ุชูุงุตูู</div></div>
          ${rows.map(r=>`
            <div class="trow">
              <div class="muted">${r.t}</div>
              <div><b>${r.type}</b></div>
              <div class="muted" style="grid-column:3 / -1;">${short(JSON.stringify(r.meta||{}))}</div>
            </div>
          `).join("")}
        `;
      }
      function short(s){ return s.length>140 ? s.slice(0,140)+"โฆ" : s; }

      // Alerts
      function loadAlerts(){
        try{ return JSON.parse(localStorage.getItem(AKEY) || "[]"); }catch(_){ return []; }
      }
      function saveAlerts(rows){
        localStorage.setItem(AKEY, JSON.stringify(rows.slice(0,50)));
      }
      function renderAlerts(){
        const box = $("#alertsList");
        if(!box) return;
        const rows = loadAlerts();
        if(!rows.length){
          box.innerHTML = `<div class="empty">ูุง ุชูุฌุฏ ุชูุจููุงุช ุจุนุฏ</div>`;
          $("#lastAlert").textContent = "โ";
          return;
        }
        $("#lastAlert").textContent = rows[0].level;
        box.innerHTML = rows.map(a=>`
          <div class="alert ${a.level==='CRIT'?'crit':a.level==='HIGH'?'high':''}">
            <div class="a-top">
              <div class="a-title">${a.title}</div>
              <div class="muted">${a.t}</div>
            </div>
            <div class="a-body">${esc(a.body)}</div>
            <div class="a-actions">
              <button class="btn ghost ackBtn" data-id="${a.id}">ุชุฃููุฏ</button>
            </div>
          </div>
        `).join("");

        $$(".ackBtn").forEach(b=>{
          b.addEventListener("click", ()=>{
            addHist("ALERT_ACK", { id: b.dataset.id });
            try{ window.SCAUDIT?.audit?.("PARENT_ACK", { id: b.dataset.id }); }catch(_){}
            alert("ุชู ุงูุชุฃููุฏ โ (Demo)");
          });
        });
      }

      function pushAlert(level="MED", title="ุชูุจูู ูู ุงูุนูุงุฏุฉ", body="ุชู ุชุณุฌูู ุญุงูุฉ ููุทุงูุจ. ูุฑุฌู ุงููุชุงุจุนุฉ. (Demo)"){
        const rows = loadAlerts();
        const a = { id:"A-"+Math.random().toString(36).slice(2,7).toUpperCase(), t: time(), level, title, body };
        rows.unshift(a);
        saveAlerts(rows);
        renderAlerts();
        addHist("ALERT_NEW", { id:a.id, level });
      }

      // Consent
      function loadConsent(){
        try{ return JSON.parse(localStorage.getItem(CKEY) || "null"); }catch(_){ return null; }
      }
      function saveConsent(c){
        localStorage.setItem(CKEY, JSON.stringify(c));
      }
      function renderConsent(){
        const c = loadConsent();
        if(!c){
          $("#consentId").textContent = "Consent: โ";
          $("#consentStatus").textContent = "โ";
          $("#consentTime").textContent = "โ";
          $("#consentSummary").value = "";
          $("#parentNote").value = "";
          $("#pendingConsent").textContent = "0";
          return;
        }
        $("#consentId").textContent = "Consent: " + c.id;
        $("#consentType").value = c.type;
        $("#consentSummary").value = c.summary;
        $("#parentNote").value = c.note || "";
        $("#consentStatus").textContent = c.status;
        $("#consentTime").textContent = c.t;
        $("#pendingConsent").textContent = c.status === "PENDING" ? "1" : "0";
      }

      function genConsent(){
        const c = {
          id: "C-" + Math.random().toString(36).slice(2,7).toUpperCase(),
          t: time(),
          type: $("#consentType").value || "clinic_visit",
          summary: "ุทูุจ ููุงููุฉ: ูุชุงุจุนุฉ ุญุงูุฉ ุงูุทุงูุจ + ุฅุฌุฑุงุก ููุงุณุจ ุญุณุจ ุงูุชูููู. (Demo)",
          note: "",
          status: "PENDING"
        };
        saveConsent(c);
        renderConsent();
        addHist("CONSENT_CREATED", { id:c.id, type:c.type });
        try{ window.SCAUDIT?.audit?.("PARENT_CONSENT_REQUESTED", { id:c.id, type:c.type }); }catch(_){}
      }

      function approve(){
        const c = loadConsent();
        if(!c){ alert("ูุง ููุฌุฏ ุทูุจ ููุงููุฉ"); return; }
        c.note = ($("#parentNote").value||"").trim();
        c.status = "APPROVED";
        c.t = time();
        saveConsent(c);
        renderConsent();
        addHist("CONSENT_APPROVED", { id:c.id, note: c.note });
        try{ window.SCAUDIT?.audit?.("CONSENT_APPROVED", { id:c.id }); }catch(_){}
        alert("ุชูุช ุงูููุงููุฉ โ (Demo)");
      }

      function reject(){
        const c = loadConsent();
        if(!c){ alert("ูุง ููุฌุฏ ุทูุจ ููุงููุฉ"); return; }
        c.note = ($("#parentNote").value||"").trim();
        c.status = "REJECTED";
        c.t = time();
        saveConsent(c);
        renderConsent();
        addHist("CONSENT_REJECTED", { id:c.id, note: c.note });
        try{ window.SCAUDIT?.audit?.("CONSENT_REJECTED", { id:c.id }); }catch(_){}
        alert("ุชู ุงูุฑูุถ โ (Demo)");
      }

      // Profile
      function loadProfile(){
        try{ return JSON.parse(localStorage.getItem(PKEY) || "null"); }catch(_){ return null; }
      }
      function saveProfile(p){
        localStorage.setItem(PKEY, JSON.stringify(p));
      }
      function renderProfile(){
        const p = loadProfile() || {};
        $("#allergy").value = p.allergy || "";
        $("#chronic").value = p.chronic || "";
        $("#longMeds").value = p.longMeds || "";
        $("#healthNotes").value = p.healthNotes || "";
        $("#childId").value = p.childId || "STD-23";
        $("#childName").value = p.childName || "ุทุงูุจ #23";
        $("#schoolName").value = p.schoolName || "ูุฏุฑุณุฉ A";
        $("#repChild").textContent = "Child: " + ($("#childName").value || "โ") + " (" + ($("#childId").value || "โ") + ")";
      }

      function saveProfileFromUI(){
        const p = {
          allergy: ($("#allergy").value||"").trim(),
          chronic: ($("#chronic").value||"").trim(),
          longMeds: ($("#longMeds").value||"").trim(),
          healthNotes: ($("#healthNotes").value||"").trim(),
          childId: ($("#childId").value||"").trim(),
          childName: ($("#childName").value||"").trim(),
          schoolName: ($("#schoolName").value||"").trim()
        };
        saveProfile(p);
        renderProfile();
        addHist("PROFILE_SAVED", { childId: p.childId });
        try{ window.SCAUDIT?.audit?.("PROFILE_SAVED", { childId: p.childId }); }catch(_){}
        alert("ุชู ุญูุธ ุงูููู ุงูุตุญู โ (Demo)");
      }

      function clearProfile(){
        if(!confirm("ุชูุฑูุบ ุงูููู ุงูุตุญูุ")) return;
        localStorage.removeItem(PKEY);
        renderProfile();
        addHist("PROFILE_CLEARED", {});
      }

      // Report (parent summary)
      function buildReport(){
        const p = loadProfile() || {};
        const c = loadConsent();
        const alerts = loadAlerts();
        $("#repDate").textContent = "Date: " + today;
        $("#repChild").textContent = "Child: " + (p.childName || "โ") + " (" + (p.childId || "โ") + ")";

        const lines = [
          `โข ุงููุฏุฑุณุฉ: ${p.schoolName || "โ"}`,
          `โข ุงูุญุณุงุณูุฉ: ${p.allergy || "โ"}`,
          `โข ุงููุฑุถ ุงููุฒูู: ${p.chronic || "โ"}`,
          `โข ุงูุฃุฏููุฉ ุงูุฏุงุฆูุฉ: ${p.longMeds || "โ"}`,
          `โข ููุงุญุธุงุช: ${p.healthNotes || "โ"}`,
          "",
          `โข ุขุฎุฑ ุชูุจูู: ${alerts[0] ? (alerts[0].level+" โ "+alerts[0].title) : "โ"}`,
          `โข ุนุฏุฏ ุงูุชูุจููุงุช: ${alerts.length}`,
          "",
          `โข ุงูููุงููุงุช: ${c ? (c.status+" โ "+c.type) : "ูุง ููุฌุฏ"}`,
          "",
          `โข ุชูุตูุฉ ุนุงูุฉ (Demo): ูุชุงุจุนุฉ ุงูุทุงูุจุ ููู ุงูุญุงูุงุช ุงูุนุงููุฉ ุณูุชู ุทูุจ ุฅุญุงูุฉ ุฃู ุชูุงุตู ูุจุงุดุฑ.`
        ];

        $("#repBody").innerHTML = lines.map(x => x ? `<div>${esc(x)}</div>` : `<div style="height:10px"></div>`).join("");
      }

      function exportTxt(){
        buildReport();
        const txt = document.getElementById("repBody").innerText || "โ";
        download("parent-report.txt", "Parent Summary Report (Demo)\n\n"+txt);
        addHist("REPORT_EXPORTED_TXT", {});
      }
      function exportJson(){
        const data = {
          profile: loadProfile(),
          alerts: loadAlerts(),
          consent: loadConsent(),
          history: loadHist()
        };
        download("parent-data.json", JSON.stringify(data, null, 2), "application/json");
        addHist("REPORT_EXPORTED_JSON", {});
      }

      function download(name, text, type="text/plain"){
        const blob = new Blob([text], {type:type+";charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = name;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 800);
      }

      function esc(s){
        return String(s).replace(/[&<>"']/g, m => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
        }[m]));
      }

      // Quick buttons
      $("#qAck")?.addEventListener("click", ()=>{
        addHist("ALERT_ACK_ALL", {});
        try{ window.SCAUDIT?.audit?.("PARENT_ACK_ALL", {}); }catch(_){}
        alert("ุชู ุชุฃููุฏ ุงูุงุณุชูุงู โ (Demo)");
      });
      $("#qConsent")?.addEventListener("click", ()=> openView("consent"));
      $("#qReport")?.addEventListener("click", ()=> { buildReport(); openView("report"); });
      $("#qProfile")?.addEventListener("click", ()=> openView("profile"));

      // Home actions
      $("#btnRefresh")?.addEventListener("click", ()=>{
        $("#dotLive")?.classList.add("pulse");
        setTimeout(()=>$("#dotLive")?.classList.remove("pulse"), 900);
        addHist("REFRESH", {});
      });

      $("#btnSimAlert")?.addEventListener("click", ()=>{
        const lvl = ["LOW","MED","HIGH"][Math.floor(Math.random()*3)];
        pushAlert(lvl, "ุชูุจูู ูู ุงูุนูุงุฏุฉ", "ุชู ุชุณุฌูู ุญุงูุฉ ููุทุงูุจ. ูุฑุฌู ูุชุงุจุนุฉ ุงูุชุนูููุงุช. (Demo)");
        $("#kidState").textContent = lvl==="HIGH" ? "ATTN" : "OK";
      });

      // Alerts actions
      $("#btnClearAlerts")?.addEventListener("click", ()=>{
        if(!confirm("ูุณุญ ุงูุชูุจููุงุชุ")) return;
        localStorage.setItem(AKEY, "[]");
        renderAlerts();
        addHist("ALERTS_CLEARED", {});
      });

      $("#btnAckAll")?.addEventListener("click", ()=>{
        addHist("ALERT_ACK_ALL", {});
        try{ window.SCAUDIT?.audit?.("PARENT_ACK_ALL", {}); }catch(_){}
        alert("ุชู ุชุฃููุฏ ุฌููุน ุงูุชูุจููุงุช โ (Demo)");
      });

      // Consent actions
      $("#btnGenConsent")?.addEventListener("click", genConsent);
      $("#btnApprove")?.addEventListener("click", approve);
      $("#btnReject")?.addEventListener("click", reject);

      // Profile actions
      $("#btnSaveProfile")?.addEventListener("click", saveProfileFromUI);
      $("#btnClearProfile")?.addEventListener("click", clearProfile);

      $("#btnAutoChild")?.addEventListener("click", ()=>{
        $("#childId").value = "STD-" + (Math.floor(Math.random()*90)+10);
        $("#childName").value = "ุทุงูุจ #" + (Math.floor(Math.random()*90)+10);
        $("#schoolName").value = "ูุฏุฑุณุฉ A";
        addHist("CHILD_AUTOFILL", {});
        renderProfile();
      });

      $("#btnOpenReport")?.addEventListener("click", ()=>{ buildReport(); openView("report"); });

      // Exports
      $("#btnExportTxt")?.addEventListener("click", exportTxt);
      $("#btnExportJson")?.addEventListener("click", exportJson);
      $("#btnExportAll")?.addEventListener("click", ()=>{
        exportJson();
        try{ window.SCAUDIT?.audit?.("PARENT_EXPORT_ALL", {}); }catch(_){}
      });

      // History
      $("#btnClearHistory")?.addEventListener("click", ()=>{
        if(!confirm("ูุณุญ ุงูุณุฌูุ")) return;
        localStorage.setItem(HKEY, "[]");
        addHist("HISTORY_CLEARED", {});
        renderHist();
      });
      $("#btnExportHistory")?.addEventListener("click", ()=>{
        download("parent-history.json", JSON.stringify(loadHist(), null, 2), "application/json");
        addHist("HISTORY_EXPORTED", {});
      });

      // Link child
      $("#btnLinkChild")?.addEventListener("click", ()=>{
        openView("profile");
        $("#btnAutoChild")?.click();
        alert("ุชู ุฑุจุท ุงูุงุจู/ุงูุงุจูุฉ (Demo) โ");
        addHist("CHILD_LINKED", {});
      });

      // Request call
      function requestCall(){
        addHist("REQUEST_CALL", { note:"Parent requested contact" });
        try{ window.SCAUDIT?.audit?.("PARENT_REQUEST_CALL", {}); }catch(_){}
        alert("ุชู ุฅุฑุณุงู ุทูุจ ุชูุงุตู ููุนูุงุฏุฉ (Demo) โ");
      }
      $("#btnRequestCall")?.addEventListener("click", requestCall);
      $("#btnRequestCall2")?.addEventListener("click", requestCall);

      // Init
      renderAlerts();
      renderConsent();

      // Seed one pending consent (demo) if none exists
      if(!loadConsent()){
        localStorage.setItem(CKEY, JSON.stringify({
          id:"C-DEMO-01", t: time(), type:"clinic_visit",
          summary:"ุทูุจ ููุงููุฉ: ุฒูุงุฑุฉ ุงูุนูุงุฏุฉ ููุชุงุจุนุฉ ุฃุนุฑุงุถ ุงูุทุงูุจ. (Demo)",
          note:"", status:"PENDING"
        }));
      }
      renderConsent();

      renderProfile();
      buildReport();
      renderHist();

      // Default last alert
      if(loadAlerts().length === 0){
        pushAlert("MED","ุชูุจูู ูู ุงูุนูุงุฏุฉ","ุชู ุชุณุฌูู ุฒูุงุฑุฉ ุงูููู. ูุฑุฌู ุงูุงุทูุงุน ุนูู ุงูุชูุฑูุฑ. (Demo)");
      }
      renderAlerts();
      buildReport();
    })();
  </script>

</body>
</html>
