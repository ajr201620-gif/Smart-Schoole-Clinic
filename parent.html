<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± â€” Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</title>
  <link rel="stylesheet" href="app.css" />
</head>

<body data-page="parent">
  <header class="topbar">
    <div class="topbar__left">
      <a class="btn ghost" href="index.html">âŸµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <div class="brand mini">
        <div class="brand__logo">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
        <div class="brand__txt">
          <div class="brand__name">Ø¨ÙˆØ§Ø¨Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</div>
          <div class="brand__sub">Ù…ØªØ§Ø¨Ø¹Ø© â€¢ Ù…ÙˆØ§ÙÙ‚Ø§Øª â€¢ Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø²ÙŠØ§Ø±Ø©</div>
        </div>
      </div>
    </div>

    <div class="topbar__right">
      <div class="pill">Ù…Ø±Ø­Ø¨Ù‹Ø§: <b data-user-name>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</b></div>
      <button class="btn ghost" id="btnTheme">ğŸŒ“</button>
    </div>
  </header>

  <main class="shell">
    <section class="grid2">
      <!-- Summary -->
      <div class="card pad">
        <div class="card__title">ğŸ“Œ Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø§Ù„Ø©</div>
        <div class="muted">Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙŠÙ…Ùˆ: Ù…Ø±Ø¨ÙˆØ· Ø¨Ø¢Ø®Ø± Ø­Ø§Ù„Ø© ØªØ®Øµ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸.</div>

        <div class="block">
          <div class="label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</div>
          <div class="box" id="parentChildName">â€”</div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="kpi__label">Ø¢Ø®Ø± Ø­Ø§Ù„Ø©</div>
            <div class="kpi__val" id="parentLastCase">â€”</div>
          </div>
          <div class="kpi">
            <div class="kpi__label">Ø§Ù„Ø­Ø§Ù„Ø©</div>
            <div class="kpi__val" id="parentStatus">â€”</div>
          </div>
        </div>

        <div class="block">
          <div class="label">Ø§Ù„ØªØ§Ù„ÙŠ</div>
          <div class="box" id="parentActions">â€”</div>
        </div>

        <div class="hr"></div>

        <div class="card__title">âœ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª</div>
        <div class="muted">Ø¥Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ù…ÙˆØ§ÙÙ‚Ø© Ø¥Ø¬Ø±Ø§Ø¡ â€” Ø±Ø¯ Ù‡Ù†Ø§.</div>

        <div class="row actions">
          <button class="btn solid" id="btnConsentApprove" data-action="consent:approve">ğŸ‘ Ù…ÙˆØ§ÙÙ‚Ø©</button>
          <button class="btn ghost" id="btnConsentDecline" data-action="consent:decline">ğŸ‘ Ø±ÙØ¶</button>
        </div>

        <div class="row actions">
          <button class="btn ghost" data-action="doctor:makeDecision" data-decision="Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…Ø·Ù„ÙˆØ¨Ø© (Ø·Ù„Ø¨ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±)">ğŸ“ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨/Ù…Ù„Ø§Ø­Ø¸Ø©</button>
          <a class="btn ghost" href="visit.html">ğŸ¥ ØºØ±ÙØ© Ø§Ù„Ø²ÙŠØ§Ø±Ø©</a>
        </div>
      </div>

      <!-- History -->
      <div class="card pad">
        <div class="card__title">ğŸ§¾ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
        <div class="muted">Ø¢Ø®Ø± 6 Ø­Ø§Ù„Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨.</div>

        <div id="parentCasesList" class="list"></div>

        <div class="hr"></div>

        <div class="card__title">ğŸ”” ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
        <div id="parentAlerts" class="list"></div>

        <div class="row actions">
          <a class="btn ghost" href="student.html">ğŸ’ ÙØªØ­ Ø§Ù„Ø·Ø§Ù„Ø¨</a>
          <a class="btn ghost" href="doctor.html">ğŸ©º ÙØªØ­ Ø§Ù„Ø·Ø¨ÙŠØ¨</a>
          <a class="btn ghost" href="admin.html">ğŸ« ÙØªØ­ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
        </div>
      </div>
    </section>
  </main>

  <!-- Scripts -->
  <script src="bus.js"></script>
  <script src="auth.js"></script>
  <script src="app-init.js"></script>
  <script src="sensor-sim.js"></script>
  <script src="triage-ai.js"></script>
  <script src="doctor-copilot.js"></script>
  <script src="visit-session.js"></script>
  <script src="app.js"></script>
  <script src="actions.js"></script>

  <script>
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function renderParent(){
      const app = window.app;
      if(!app) return;

      const sum = app.getParentSummary?.();
      if(!sum) return;

      document.getElementById("parentChildName").textContent = sum.childName ?? "â€”";
      document.getElementById("parentLastCase").textContent = sum.lastCaseTitle ?? "â€”";
      document.getElementById("parentStatus").textContent = sum.status ?? "â€”";
      document.getElementById("parentActions").textContent = sum.nextSteps ?? "â€”";

      const list = document.getElementById("parentCasesList");
      if(list){
        if(!sum.cases?.length){
          list.innerHTML = `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯.</div>`;
        } else {
          list.innerHTML = sum.cases.map(x => `
            <div class="rowCard">
              <div class="rowTitle">${escapeHtml(x.title || "Ø­Ø§Ù„Ø©")}</div>
              <div class="rowMeta">${escapeHtml(x.time || "")} â€¢ ${escapeHtml(x.status || "")}</div>
            </div>
          `).join("");
        }
      }

      const alerts = document.getElementById("parentAlerts");
      if(alerts){
        const cases = app.getCases?.() || [];
        const childId = (window.Auth?.getUser?.()?.childSchoolId) || "S-1001";
        const mine = cases.filter(c => c.patient?.schoolId === childId);
        const last = mine.length ? mine[mine.length - 1] : null;

        if(!last){
          alerts.innerHTML = `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª.</div>`;
          return;
        }

        const blocks = [];
        if (last.triage?.priority === "P1") blocks.push({ t:"ğŸš¨ ØªÙ†Ø¨ÙŠÙ‡", m:"Ø­Ø§Ù„Ø© Ø­Ø±Ø¬Ø© â€” ÙŠÙØ¶Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ ÙÙˆØ±Ù‹Ø§" });
        if ((last.visit?.allowParent)) blocks.push({ t:"ğŸ¥ Ø²ÙŠØ§Ø±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©", m:"Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙØ¹Ù‘Ù„ Ø§Ù†Ø¶Ù…Ø§Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ø²ÙŠØ§Ø±Ø©" });
        if ((last.visit?.consent && last.visit?.consent !== "none")) blocks.push({ t:"ğŸ“ Ù…ÙˆØ§ÙÙ‚Ø©", m:`Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${last.visit.consent}` });

        if(!blocks.length){
          alerts.innerHTML = `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
        } else {
          alerts.innerHTML = blocks.map(x => `
            <div class="rowCard">
              <div class="rowTitle">${escapeHtml(x.t)}</div>
              <div class="rowMeta">${escapeHtml(x.m)}</div>
            </div>
          `).join("");
        }
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btnTheme")?.addEventListener("click", () => {
        const html = document.documentElement;
        const isDark = html.getAttribute("data-theme") !== "light";
        html.setAttribute("data-theme", isDark ? "light" : "dark");
      });

      renderParent();
      window.bus?.on?.("case:update", renderParent);
      window.bus?.on?.("visit:update", renderParent);
    });
  </script>
  <script type="module" src="./firebase-init.js"></script>
</body>
</html>
