<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Smart Clinic OS โ Doctor</title>
  <link rel="stylesheet" href="ar.css"/>
  <link rel="stylesheet" href="shell.css"/>
  <script src="bus.js"></script>
  <script src="sensor-sim.js"></script>
  <script src="ai-triage.js"></script>
  <script src="rbac.js"></script>
</head>
<body>

<div class="sc-top">
  <div class="left">
    <span class="sc-chip" id="scRoleChip">Doctor</span>
    <div class="sc-title">
      <b id="scRoleTitle">ุจูุงุจุฉ ุงูุทุจูุจ</b>
      <small>ุงูุทูุจุงุช + ูุฑุงุกุงุช + ุชูุตูุฉ AI + ุชุดุฎูุต + ูุฑุงุฑุงุช</small>
    </div>
  </div>
  <div class="sc-actions">
    <span class="sc-status" id="scStatus">๐ข Ready</span>
    <a class="sc-primary" id="scPrimaryAction" href="visit.html?role=doctor">๐ฅ ุฒูุงุฑุฉ ุงูุชุฑุงุถูุฉ</a>
  </div>
</div>

<div class="sc-shell">
  <aside class="sc-side">
    <div class="sc-chip">ุงูุชูููู</div>
    <nav class="sc-nav">
      <a class="sc-nav-item" href="index.html">๐ ุงูุจูุงุจุฉ</a>
      <a class="sc-nav-item" href="#inbox">๐ฅ ุขุฎุฑ ุญุงูุฉ</a>
      <a class="sc-nav-item" href="#dx">๐ง ุงูุชุดุฎูุต</a>
      <a class="sc-nav-item" href="report.html">๐งพ ุงูุชูุงุฑูุฑ</a>
    </nav>

    <div style="margin-top:14px" class="sc-chip">Quick</div>
    <div class="sc-quick">
      <button class="sc-qa" id="btnLoad">๐ฅ ุชุญููู ุขุฎุฑ ุญุงูุฉ</button>
      <button class="sc-qa" id="btnReRead">๐ ุทูุจ ูุฑุงุกุฉ ุซุงููุฉ</button>
      <button class="sc-qa" id="btnAIHelp">๐ค ูุณุงุนุฏ ุชุดุฎูุต AI</button>
      <a class="sc-qa" id="btnVisit" href="visit.html?role=doctor">๐ฅ ุฏุฎูู ุงูุฒูุงุฑุฉ</a>
    </div>
  </aside>

  <main class="sc-main">
    <div style="padding:16px">
      <div class="panel" id="inbox">
        <div class="h">
          <h2>ุขุฎุฑ ุญุงูุฉ ูุงุฑุฏุฉ</h2>
          <div class="muted">Complaint + Vitals + AI</div>
        </div>

        <div class="row">
          <span class="badge">Case: <b id="caseId">โ</b></span>
          <span class="badge">Priority: <b id="casePri">โ</b></span>
          <span class="badge">Risk: <b id="caseRisk">โ</b></span>
        </div>

        <div class="sep"></div>

        <div class="kpis">
          <div class="kpi"><b>Temp</b><span id="vTemp">โ</span></div>
          <div class="kpi"><b>HR</b><span id="vHR">โ</span></div>
          <div class="kpi"><b>SpOโ</b><span id="vSp">โ</span></div>
          <div class="kpi"><b>BP</b><span id="vBP">โ</span></div>
        </div>

        <div class="sep"></div>

        <div class="h"><h2>ุงูุดููู</h2><div class="muted">ูู ุงูุทุงูุจ</div></div>
        <div class="panel" style="padding:12px; border-radius:14px;">
          <div id="complaint">โ</div>
        </div>

        <div class="sep"></div>

        <div class="h"><h2>ุชูุตูุฉ AI</h2><div class="muted">Recommendation</div></div>
        <div class="panel" style="padding:12px; border-radius:14px;">
          <div id="aiRec">โ</div>
          <div class="muted small" id="aiFlags">โ</div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn ghost" id="btnReRead2">๐ ุทูุจ ูุฑุงุกุฉ ุซุงููุฉ</button>
          <a class="btn" id="btnVisit2" href="visit.html?role=doctor">๐ฅ ูุจูู/ุฏุฎูู ุงูุฒูุงุฑุฉ</a>
          <button class="btn ghost" id="btnAskParent">๐จโ๐ฉโ๐ฆ ุทูุจ ุงูุถูุงู ููู ุงูุฃูุฑ</button>
        </div>
      </div>

      <div class="panel" id="dx" style="margin-top:16px">
        <div class="h">
          <h2>ุงูุชุดุฎูุต ูุฎุทุฉ ุงูุฅุฌุฑุงุก</h2>
          <div class="muted">Dx + Plan + Decisions</div>
        </div>

        <textarea id="dxText" class="input" rows="4" style="width:100%; border-radius:14px; padding:12px;"
          placeholder="ุงูุชุจ ุงูุชุดุฎูุต / ุงูููุงุญุธุงุช..."></textarea>

        <div class="sep"></div>

        <textarea id="planText" class="input" rows="3" style="width:100%; border-radius:14px; padding:12px;"
          placeholder="ุงูุฎุทุฉ: ุฑุงุญุฉ/ูุชุงุจุนุฉ/ุฅุญุงูุฉ..."></textarea>

        <div class="sep"></div>

        <div class="row">
          <button class="btn" id="btnApprove">โ ุงุนุชูุงุฏ ุงูุญุงูุฉ</button>
          <button class="btn ghost" id="btnNeedConsent">๐ก ุชุญููู ูููุงููุฉ ููู ุงูุฃูุฑ</button>
          <button class="btn ghost" id="btnRefer">๐ ุฅุญุงูุฉ</button>
          <button class="btn ghost" id="btnReject">โ ุฑูุถ/ุฅุบูุงู</button>
        </div>

        <div class="small" id="hint">ุญููู ุขุฎุฑ ุญุงูุฉ ุฃููุงูุ ุซู ุงูุชุจ ุงูุชุดุฎูุต ุฃู ุงุณุชุฎุฏู ูุณุงุนุฏ AI.</div>
      </div>

    </div>
  </main>
</div>

<script>
localStorage.setItem("SC_ROLE","doctor");
const $ = (s)=>document.querySelector(s);
let currentCase = null;

function paintCase(c){
  currentCase = c;
  $("#caseId").textContent = c?.id || "โ";
  $("#casePri").textContent = c?.priority || "โ";
  $("#caseRisk").textContent = (c?.riskScore ?? c?.ai?.risk ?? "โ");

  const v = c?.vitals || {};
  $("#vTemp").textContent = v.temp ? (v.temp+"ยฐC") : "โ";
  $("#vHR").textContent   = v.hr ? (v.hr+" bpm") : "โ";
  $("#vSp").textContent   = v.spo2 ? (v.spo2+"%") : "โ";
  $("#vBP").textContent   = v.bp || "โ";

  $("#complaint").textContent = c?.requestDesc || c?.desc || c?.complaint || "โ";
  $("#aiRec").textContent = c?.ai?.recommendation || c?.decision || "โ";
  $("#aiFlags").textContent = c?.ai?.flags?.length ? ("Flags: " + c.ai.flags.join(", ")) : "";

  const room = "ROOM-" + (c.id || Date.now());
  $("#btnVisit").href  = `visit.html?role=doctor&room=${encodeURIComponent(room)}&autojoin=1`;
  $("#btnVisit2").href = $("#btnVisit").href;
}

function loadLatest(){
  const bus = window.SCBUS?.load?.();
  const c = bus?.cases?.[0];
  if(!c){ alert("ูุง ุชูุฌุฏ ุญุงูุงุช ุจุนุฏ"); return; }
  // best effort map complaint
  c.requestDesc = bus?.requests?.find(r=>r.id===c.requestId)?.desc || c.requestDesc || c.desc;
  paintCase(c);
}

function saveCase(patch){
  if(!currentCase) return;
  const bus = window.SCBUS.load();
  const idx = (bus.cases||[]).findIndex(x=>x.id===currentCase.id);
  if(idx<0) return;

  bus.cases[idx] = Object.assign({}, bus.cases[idx], patch);
  window.SCBUS.save(bus);
  paintCase(bus.cases[idx]);
}

function requestReRead(){
  if(!currentCase){ alert("ุญููู ุญุงูุฉ ุฃููุงู"); return; }
  // demo: generate a second reading and attach to case
  const v2 = window.SCSIM.gen(currentCase.priority==="CRIT"?"critical":currentCase.priority==="HIGH"?"sick":"mild");
  const ai2 = window.SCAI.triage({ complaint: $("#complaint").textContent, vitals: v2 });

  const readings = Array.isArray(currentCase.readings) ? currentCase.readings : [];
  readings.unshift({ t: new Date().toISOString(), vitals: v2, ai: ai2 });

  saveCase({ readings, vitals: v2, ai: ai2, note: "ุชูุช ูุฑุงุกุฉ ุซุงููุฉ (ูุญุงูุงุฉ)" });
  alert("ุชูุช ุงููุฑุงุกุฉ ุงูุซุงููุฉ โ ูุชู ุชุญุฏูุซ ุงูุญุงูุฉ");
}

function aiAssistant(){
  if(!currentCase){ alert("ุญููู ุญุงูุฉ ุฃููุงู"); return; }
  const v = currentCase.vitals || {};
  const a = currentCase.ai || {};
  const dx = [
    "ููุฎุต ูุณุงุนุฏ ุงูุทุจูุจ (AI):",
    `- Priority: ${currentCase.priority || a.priority || "โ"} | Risk: ${currentCase.riskScore || a.risk || "โ"}`,
    `- Temp: ${v.temp||"โ"} | HR: ${v.hr||"โ"} | SpOโ: ${v.spo2||"โ"} | BP: ${v.bp||"โ"}`,
    `- Recommendation: ${a.recommendation || currentCase.decision || "โ"}`,
    "",
    "ุงูุชุฑุงุญ ุชุดุฎูุต ุฃููู (Demo):",
    (a.flags||[]).includes("Resp") ? "โข ุงุดุชุจุงู ูุดููุฉ ุชููุณูุฉ/ุงูุชูุงุจ" :
    (a.flags||[]).includes("Fever") ? "โข ุญููู/ุนุฏูู ูุญุชููุฉ" :
    "โข ุฃุนุฑุงุถ ุนุงูุฉ ุชุญุชุงุฌ ุชูููู",
    "",
    "ุฎุทุฉ ููุชุฑุญุฉ:",
    currentCase.priority==="CRIT" ? "โข ุฅุฌุฑุงุก ุทุงุฑุฆ + ุฅุญุงูุฉ + ุฅุดุนุงุฑ ููู ุงูุฃูุฑ" :
    currentCase.priority==="HIGH" ? "โข ุฒูุงุฑุฉ ุงูุชุฑุงุถูุฉ ููุฑูุฉ + ูุชุงุจุนุฉ + ุงุญุชูุงู ููุงููุฉ ููู ุงูุฃูุฑ" :
    currentCase.priority==="MED"  ? "โข ูุชุงุจุนุฉ + ุฅุนุงุฏุฉ ูุฑุงุกุฉ + ุฅุฑุดุงุฏุงุช" :
    "โข ุฅุฑุดุงุฏ ุตุญู + ุฑุงุญุฉ"
  ].join("\n");

  $("#dxText").value = dx;
  $("#planText").value = a.recommendation || "";
}

function askParentJoin(){
  if(!currentCase){ alert("ุญููู ุญุงูุฉ ุฃููุงู"); return; }
  saveCase({ parentJoinRequested: true });
  window.SCBUS.pushAlert("parent", currentCase.priority || "MED", "ุทูุจ ุงูุถูุงู ูุฒูุงุฑุฉ ุงูุชุฑุงุถูุฉ", `Case ${currentCase.id}`, { caseId: currentCase.id });
  alert("ุชู ุฅุฑุณุงู ุทูุจ ุงูุถูุงู ููู ุงูุฃูุฑ โ");
}

function approve(){
  if(!currentCase) return;
  saveCase({ status: "APPROVED", dx: $("#dxText").value || "โ", plan: $("#planText").value || "โ" });
  alert("ุชู ุงูุงุนุชูุงุฏ โ");
}
function needConsent(){
  if(!currentCase) return;
  saveCase({ status: "CONSENT_REQUIRED", dx: $("#dxText").value || "โ", plan: $("#planText").value || "โ" });
  window.SCBUS.pushAlert("parent","MED","ูุทููุจ ููุงููุฉ ููู ุงูุฃูุฑ",`Case ${currentCase.id}`,{caseId:currentCase.id});
  alert("ุชู ุชุญููููุง ูููุงููุฉ ููู ุงูุฃูุฑ โ");
}
function refer(){
  if(!currentCase) return;
  saveCase({ status: "REFERRED", dx: $("#dxText").value || "โ", plan: "ุฅุญุงูุฉ" });
  alert("ุชูุช ุงูุฅุญุงูุฉ โ");
}
function reject(){
  if(!currentCase) return;
  saveCase({ status: "CLOSED", dx: $("#dxText").value || "โ", plan: "ุฅุบูุงู" });
  alert("ุชู ุงูุฅุบูุงู โ");
}

$("#btnLoad").addEventListener("click", loadLatest);
$("#btnReRead").addEventListener("click", requestReRead);
$("#btnReRead2").addEventListener("click", requestReRead);
$("#btnAIHelp").addEventListener("click", aiAssistant);
$("#btnAskParent").addEventListener("click", askParentJoin);
$("#btnApprove").addEventListener("click", approve);
$("#btnNeedConsent").addEventListener("click", needConsent);
$("#btnRefer").addEventListener("click", refer);
$("#btnReject").addEventListener("click", reject);
</script>
</body>
</html>
