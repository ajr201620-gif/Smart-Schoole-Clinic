<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุจูุงุจุฉ ุงูุทุจูุจ โ Smart School Clinic OS</title>

  <link rel="stylesheet" href="app.css" />

<script src="bus.js"></script>
<script src="auth.js"></script>
<script src="triage-ai.js"></script>
<script src="sensor-sim.js"></script>
<script src="visit-session.js"></script>
<script src="doctor-copilot.js"></script>
<script src="actions.js"></script>
<script src="app-init.js"></script>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="logo">๐จโโ๏ธ</div>
    <div class="brandText">
      <div class="name">ุจูุงุจุฉ ุงูุทุจูุจ</div>
      <div class="tagline">ุญุงูุงุช โข Copilot โข ูุฑุงุฑุงุช โข ุฒูุงุฑุฉ ุงูุชุฑุงุถูุฉ</div>
    </div>
  </div>
  <div class="topActions">
    <button class="btn ghost" onclick="location.href='index.html'">โฌ๏ธ ุฑุฌูุน</button>
  </div>
</header>
  <main class="page doctor-page">

  <!-- ๐งพ ูุงุฆูุฉ ุงูุทูุจุงุช ุงููุงุฏูุฉ ูู ุงูุทูุงุจ -->
  <section class="card">
    <div class="row between">
      <h3>๐ฅ ุทูุจุงุช ุงูุฒูุงุฑุฉ ุงูุงูุชุฑุงุถูุฉ</h3>
      <button class="btn ghost" data-action="doctor.refresh">๐ ุชุญุฏูุซ</button>
    </div>

    <div id="doctorQueue" class="list">
      <!-- ูุชู ุชุนุจุฆุชูุง ุชููุงุฆูุงู -->
      <div class="muted">ูุง ุชูุฌุฏ ุทูุจุงุช ุญุงููุงู.</div>
    </div>
  </section>

  <!-- ๐ง ููุฎุต ุงูุญุงูุฉ ุงููุฎุชุงุฑุฉ -->
  <section class="card">
    <h3>๐ฉบ ุชูุงุตูู ุงูุญุงูุฉ (ุงูุญุงูุฉ ุงููุฎุชุงุฑุฉ)</h3>

    <div class="grid-2">
      <div>
        <div class="label">ุงูุทุงูุจ</div>
        <div class="value" id="dStudentName">โ</div>
      </div>
      <div>
        <div class="label">ููุช ุงูุทูุจ</div>
        <div class="value" id="dTime">โ</div>
      </div>
    </div>

    <div class="label" style="margin-top:10px;">ุงูุดููู</div>
    <div class="box" id="dComplaint">โ</div>

    <div class="label" style="margin-top:10px;">ูุฑุงุกุงุช ุงูุญุณุงุณุงุช</div>
    <div class="vitals-grid">
      <div>HR: <span id="dHR">โ</span></div>
      <div>SpOโ: <span id="dSpO2">โ</span></div>
      <div>Temp: <span id="dTemp">โ</span></div>
      <div>BP: <span id="dBP">โ</span></div>
    </div>

    <div class="row" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
      <button class="btn primary" data-action="doctor.requestSecondReading">
        ๐ ุทูุจ ูุฑุงุกุฉ ุซุงููุฉ
      </button>

      <button class="btn ghost" data-action="doctor.runAiAssist">
        ๐ค ุชุดุบูู ูุณุงุนุฏ ุงูุทุจูุจ AI
      </button>
    </div>
  </section>

  <!-- ๐ค ูุณุงุนุฏ ุงูุทุจูุจ AI -->
  <section class="card">
    <h3>๐ค ูุณุงุนุฏ ุงูุทุจูุจ AI</h3>

    <div class="grid-3">
      <div>
        <div class="label">Risk</div>
        <div class="value" id="dRisk">โ</div>
      </div>
      <div>
        <div class="label">Priority</div>
        <div class="value" id="dPriority">โ</div>
      </div>
      <div>
        <div class="label">ูุฑุงุฑ ููุชุฑุญ</div>
        <div class="value" id="dDecision">โ</div>
      </div>
    </div>

    <div class="label" style="margin-top:10px;">ุชูุตูุฉ</div>
    <div class="box" id="dRecommendation">โ</div>

    <div class="row" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
      <button class="btn success" data-action="doctor.acceptVisit">โ ูุจูู ุงูุฒูุงุฑุฉ</button>
      <button class="btn danger" data-action="doctor.rejectVisit">โ ุฑูุถ</button>
      <button class="btn warn" data-action="doctor.requestParentJoin">๐จโ๐ฉโ๐ฆ ุทูุจ ุงูุถูุงู ููู ุงูุฃูุฑ</button>
      <button class="btn ghost" data-action="doctor.escalateToAdmin">๐ซ ุฅุดุนุงุฑ ุงูุฅุฏุงุฑุฉ</button>
    </div>
  </section>

  <!-- ๐ ุงูุชุดุฎูุต ูุงูุฅุญุงูุฉ ูุงูุชูุงุฑูุฑ -->
  <section class="card">
    <h3>๐ ุงูุชุดุฎูุต ูุงูุฅุญุงูุฉ ูุงูุชูุฑูุฑ</h3>

    <div class="grid-2">
      <div>
        <div class="label">ุชุดุฎูุต ุงูุทุจูุจ</div>
        <input id="dDx" class="input" placeholder="ูุซุงู: ุงูุชูุงุจ ููุฒ / ุตุฏุงุน ุฅุฌูุงุฏ..." />
      </div>
      <div>
        <div class="label">ุงูุฎุทุฉ</div>
        <input id="dPlan" class="input" placeholder="ูุซุงู: ุฑุงุญุฉ + ุณูุงุฆู + ูุชุงุจุนุฉ 24 ุณุงุนุฉ" />
      </div>
    </div>

    <div class="row" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
      <button class="btn primary" data-action="doctor.issueSlip">
        ๐งพ ุฅุตุฏุงุฑ ุฑุงุญุฉ
      </button>
      <button class="btn warn" data-action="doctor.createReferral">
        ๐ฅ ุฅุญุงูุฉ
      </button>
      <button class="btn ghost" data-action="doctor.exportReport">
        ๐ ุชุตุฏูุฑ ุชูุฑูุฑ
      </button>
    </div>

    <div class="muted" id="dResult" style="margin-top:10px;"></div>
  </section>

</main>

<main class="container">

  <!-- Cases List -->
  <section class="panel">
    <div class="h">
      <h2>๐ฅ ุงูุญุงูุงุช ุงููุงุฑุฏุฉ</h2>
      <div class="muted">ุงุฎุชุฑ ุญุงูุฉ ููุจุฏุก</div>
    </div>
    <div id="casesList"></div>
  </section>

  <div class="sep"></div>

  <!-- Case Details -->
  <section class="panel" id="casePanel" style="display:none">
    <div class="h">
      <h2>๐งพ ุชูุงุตูู ุงูุญุงูุฉ</h2>
      <div class="muted" id="caseMeta">โ</div>
    </div>

    <div class="kpiGrid">
      <div class="kpi"><div class="k">Temp</div><div class="v" id="dTemp">โ</div></div>
      <div class="kpi"><div class="k">HR</div><div class="v" id="dHR">โ</div></div>
      <div class="kpi"><div class="k">SpOโ</div><div class="v" id="dSpO2">โ</div></div>
      <div class="kpi"><div class="k">BP</div><div class="v" id="dBP">โ</div></div>
    </div>

    <div class="sep"></div>

    <div class="row">
      <button class="btn ghost" id="btnSecond">๐ ูุฑุงุกุฉ ุซุงููุฉ</button>
      <button class="btn" id="btnVirtual">๐ฅ ุฒูุงุฑุฉ ุงูุชุฑุงุถูุฉ</button>
    </div>

    <div class="sep"></div>

    <!-- Copilot -->
    <div class="panel">
      <div class="h">
        <h2>๐ค Doctor AI Copilot</h2>
        <div class="muted">ููุฎุต โข DDx โข Red Flags โข ุฎุทุฉ</div>
      </div>

      <div class="row">
        <button class="btn" id="btnCopilot">โก ุชูููุฏ Copilot</button>
        <button class="btn ghost" id="btnAutoDecision">๐งญ ูุฑุงุฑ ุชููุงุฆู</button>
        <button class="btn ghost" id="btnApplyDecision">โ ุชุทุจูู ุงููุฑุงุฑ</button>
      </div>

      <div class="sep"></div>

      <pre id="cpOut" style="white-space:pre-wrap;font-size:12px"></pre>

      <div class="sep"></div>

      <div class="row">
        <textarea id="dxText" class="input" rows="3" placeholder="ุชุดุฎูุต ุงูุทุจูุจ (DX)"></textarea>
        <textarea id="planText" class="input" rows="3" placeholder="ุงูุฎุทุฉ (PLAN)"></textarea>
      </div>

      <div class="sep"></div>

      <div>
        <b>Checklist ุงูุจุฑูุชูููู</b>
        <div id="protoList" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

</main>

<script>
(function(){
  SCAUTH.requireRole("doctor");
  const $ = (s)=>document.querySelector(s);
  let currentCase = null;
  let proposed = null;

  function loadCases(){
    const bus = SCBUS.load();
    const list = $("#casesList");
    list.innerHTML = (bus.cases||[]).map(c=>`
      <div class="sc-nav-item">
        <b>${c.studentName}</b>
        <div class="muted small">Case ${c.id} โข ${c.priority} โข ${c.status}</div>
        <button class="btn ghost" data-open="${c.id}">ูุชุญ</button>
      </div>
    `).join("") || `<div class="muted">ูุง ุชูุฌุฏ ุญุงูุงุช</div>`;
  }

  function openCase(id){
    const bus = SCBUS.load();
    currentCase = bus.cases.find(c=>c.id===id);
    if(!currentCase) return;

    $("#casePanel").style.display="";
    $("#caseMeta").textContent = `Case ${currentCase.id} โข ${currentCase.studentName} โข ${currentCase.priority}`;

    const v = currentCase.vitals;
    $("#dTemp").textContent = v.temp+"ยฐC";
    $("#dHR").textContent = v.hr;
    $("#dSpO2").textContent = v.spo2+"%";
    $("#dBP").textContent = v.bp;
  }

  function secondReading(){
    if(!currentCase) return;
    const v2 = SCSIM.generateSecond(currentCase.vitals);
    currentCase.vitals = v2;
    currentCase.ai = SCAI.triage(v2, currentCase.requestDesc);
    SCBUS.updateCase(currentCase.id, { vitals:v2, ai:currentCase.ai });
    openCase(currentCase.id);
    alert("ุชูุช ุงููุฑุงุกุฉ ุงูุซุงููุฉ");
  }

  function runCopilot(){
    if(!currentCase) return;
    const cp = SCDocAI.build(currentCase);
    $("#cpOut").textContent = cp.summary;
  }

  function autoDecision(){
    if(!currentCase) return;
    proposed = SCPROTO.proposeDecision(currentCase);
    $("#cpOut").textContent += `\n\nูุฑุงุฑ ููุชุฑุญ: ${proposed.label}`;
    $("#protoList").innerHTML = proposed.checklist.map(x=>`<div class="sc-nav-item">${x}</div>`).join("");
  }

  function applyDecision(){
    if(!currentCase || !proposed) return;
    const patch = {
      dx: $("#dxText").value,
      plan: $("#planText").value,
      decision: proposed.label,
      status: proposed.status
    };
    SCBUS.updateCase(currentCase.id, patch);
    alert("ุชู ุชุทุจูู ุงููุฑุงุฑ");
    loadCases();
  }

  $("#btnSecond").onclick = secondReading;
  $("#btnCopilot").onclick = runCopilot;
  $("#btnAutoDecision").onclick = autoDecision;
  $("#btnApplyDecision").onclick = applyDecision;

  document.addEventListener("click",(e)=>{
    const btn = e.target.closest("[data-open]");
    if(btn) openCase(btn.getAttribute("data-open"));
  });

  $("#btnVirtual").onclick = ()=>{
    if(!currentCase) return;
    location.href = `visit.html?role=doctor&room=ROOM-${currentCase.id}&autojoin=1`;
  };

  loadCases();
})();
</script>
</body>
</html>
