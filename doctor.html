<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ููุญุฉ ุงูุทุจูุจ โ ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</title>
  <link rel="stylesheet" href="app.css" />
<link rel="stylesheet" href="ui.css" />
</head>

<body data-page="doctor">
  <!-- Topbar -->
  <header class="topbar topbar--slim">
    <div class="topbar__left">
      <a class="btn ghost sm" href="index.html">โฉ๏ธ ุงูุฑุฆูุณูุฉ</a>
      <div class="brand mini">
        <div class="brand__logo">๐ฉบ</div>
        <div class="brand__txt">
          <div class="brand__name">ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</div>
          <div class="brand__sub">ููุญุฉ ุงูุทุจูุจ โข ุญุงูุงุช โข ูุฑุงุฑุงุช</div>
        </div>
      </div>
    </div>
    <div class="topbar__right">
      <div class="pill pill--soft">
        <span class="dot ok"></span>
        <span>ูุฑุญุจูุงุ <b data-user-name>ุทุจูุจ</b></span>
      </div>
      <button class="btn ghost sm" id="btnTheme">๐</button>
      <button class="btn danger sm" id="btnLogoutTop" data-action="common:logout">ุฎุฑูุฌ</button>
    </div>
  </header>

  <main class="shell shell--wide">
    <!-- Hero -->
    <section class="hero hero--compact">
      <div class="hero__left">
        <h1 class="hero__title">ุฅุฏุงุฑุฉ ุงูุญุงูุงุช ุจุณุฑุนุฉ ููุถูุญ</h1>
        <p class="hero__lead">ุงุทููุน ุนูู ุงูุญุงูุงุช ุงููุงุฑุฏุฉุ ุฑุงุฌุน ุงูููุงุณุงุชุ ูุฃุตุฏุฑ ุงููุฑุงุฑ ุงูุทุจู.</p>

        <div class="hero__cta">
          <span class="chip"><span class="dot ok"></span> Firestore: <b id="fbState">โ</b></span>
          <span class="chip">ุงูุฏูุฑ: <b data-user-role>doctor</b></span>
        </div>
      </div>

      <div class="hero__right">
        <div class="glassCard glassCard--tight">
          <div class="glassCard__title">ููุฎุต ุงูููู</div>
          <div class="glassCard__body">
            <div class="row"><span class="muted">ุญุงูุงุช ุฌุฏูุฏุฉ:</span> <b id="kNew">โ</b></div>
            <div class="row"><span class="muted">ููุฏ ุงููุชุงุจุนุฉ:</span> <b id="kFollow">โ</b></div>
            <div class="row"><span class="muted">ูุญุงูุฉ:</span> <b id="kRefer">โ</b></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 3 columns -->
    <section class="triLayout">
      <!-- Left: Case list -->
      <aside class="card card--soft">
        <header class="card__head">
          <h2 class="card__title">๐ ุงูุญุงูุงุช</h2>
          <div class="card__tools">
            <button class="btn ghost sm" id="btnRefresh">ุชุญุฏูุซ</button>
          </div>
        </header>
        <div class="card__body">
          <div id="caseList" class="list">
            <div class="empty muted">ูุง ุชูุฌุฏ ุญุงูุงุช.</div>
          </div>
        </div>
      </aside>

      <!-- Center: Case details -->
      <section class="card card--focus">
        <header class="card__head">
          <h2 class="card__title">๐งพ ุชูุงุตูู ุงูุญุงูุฉ</h2>
        </header>
        <div class="card__body">
          <div class="grid2">
            <div>
              <div class="label">ุงูุทุงูุจ</div>
              <div class="value" id="dStudent">โ</div>
            </div>
            <div>
              <div class="label">ุงูุญุงูุฉ</div>
              <div class="value" id="dStatus">โ</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="label">ุงูุฃุนุฑุงุถ</div>
          <div class="value" id="dSymptoms">โ</div>

          <div class="divider"></div>

          <div class="vitals vitals--mini">
            <div class="vital"><div class="vital__label">ูุจุถ</div><div class="vital__value" id="d_hr">โ</div></div>
            <div class="vital"><div class="vital__label">Oโ</div><div class="vital__value" id="d_spo2">โ</div></div>
            <div class="vital"><div class="vital__label">ุญุฑุงุฑุฉ</div><div class="vital__value" id="d_temp">โ</div></div>
            <div class="vital"><div class="vital__label">ุถุบุท</div><div class="vital__value" id="d_bp">โ</div></div>
          </div>

          <div class="divider"></div>

          <label class="field">
            <div class="field__label">ูุฑุงุฑ ุงูุทุจูุจ</div>
            <textarea id="dDecision" class="input" rows="4" placeholder="ุงูุชุจ ุงููุฑุงุฑ ุฃู ุงูุชูุตูุฉโฆ"></textarea>
          </label>

          <div class="rowActions rowActions--split">
            <button class="btn primary" id="btnApprove">โ ุงุนุชูุงุฏ</button>
            <button class="btn warn" id="btnFollow">๐ ูุชุงุจุนุฉ</button>
            <button class="btn" id="btnRefer">โช๏ธ ุฅุญุงูุฉ</button>
          </div>
        </div>
      </section>

      <!-- Right: Activity -->
      <aside class="card card--soft">
        <header class="card__head">
          <h2 class="card__title">๐ ุงููุดุงุท</h2>
        </header>
        <div class="card__body">
          <div id="activity" class="list">
            <div class="empty muted">ูุง ููุฌุฏ ูุดุงุท.</div>
          </div>
          <div class="divider"></div>
          <button class="btn danger" id="btnLogoutBottom" data-action="common:logout">ุฎุฑูุฌ</button>
        </div>
      </aside>
    </section>
  </main>

  <!-- Scripts (order matters) -->
  <script src="./bus.js"></script>
  <script src="./auth.js"></script>

  <!-- Firebase (ONE TIME) -->
  <script type="module" src="./firebase-init.js"></script>

  <!-- Actions -->
  <script src="./actions.js"></script>

  <!-- Page glue -->
  <script>
    (function(){
      const $=(s,r=document)=>r.querySelector(s);
      let selectedId=null;

      async function showFB(){
        const el=$("#fbState");
        let tries=0; while(!window.FB && tries++<40) await new Promise(r=>setTimeout(r,50));
        el.textContent = window.FB ? "ูุชุตู" : "ุบูุฑ ุฌุงูุฒ";
      }

      function renderList(cases){
        const box=$("#caseList");
        if(!cases?.length){ box.innerHTML='<div class="empty muted">ูุง ุชูุฌุฏ ุญุงูุงุช.</div>'; return; }
        box.innerHTML = cases.map(c=>`
          <div class="rowCard ${c.id===selectedId?'is-active':''}" data-id="${c.id}">
            <div class="rowTitle">${c.id}</div>
            <div class="rowMeta">${c.status} โข ${c.priority||'โ'}</div>
          </div>
        `).join("");
        box.querySelectorAll(".rowCard").forEach(el=>{
          el.onclick=()=>select(el.dataset.id, cases);
        });
      }

      function select(id, cases){
        selectedId=id;
        const c=cases.find(x=>x.id===id);
        if(!c) return;
        $("#dStudent").textContent = c.ownerId || "โ";
        $("#dStatus").textContent = c.status || "โ";
        $("#dSymptoms").textContent = c.symptoms || "โ";
        $("#d_hr").textContent = c.vitals?.hr ?? "โ";
        $("#d_spo2").textContent = c.vitals?.spo2 ?? "โ";
        $("#d_temp").textContent = c.vitals?.temp ?? "โ";
        $("#d_bp").textContent = c.vitals?.bp ?? "โ";
        $("#dDecision").value = c.decision || "";
        renderList(cases);
      }

      async function loadCases(){
        const { db, collection, getDocs } = window.FB;
        const snap = await getDocs(collection(db,"cases"));
        const cases = [];
        snap.forEach(d=>cases.push({id:d.id, ...d.data()}));
        // KPIs
        $("#kNew").textContent = cases.filter(c=>c.status==="new").length;
        $("#kFollow").textContent = cases.filter(c=>c.status==="follow").length;
        $("#kRefer").textContent = cases.filter(c=>c.status==="refer").length;
        renderList(cases);
        if(cases[0]) select(cases[0].id, cases);
        window.__cases = cases;
      }

      $("#btnRefresh")?.addEventListener("click", loadCases);
      $("#btnApprove")?.addEventListener("click", async()=>{
        if(!selectedId) return alert("ุงุฎุชุฑ ุญุงูุฉ");
        const { db, doc, updateDoc } = window.FB;
        await updateDoc(doc(db,"cases",selectedId), { status:"approved", decision:$("#dDecision").value });
        loadCases();
      });
      $("#btnFollow")?.addEventListener("click", async()=>{
        if(!selectedId) return alert("ุงุฎุชุฑ ุญุงูุฉ");
        const { db, doc, updateDoc } = window.FB;
        await updateDoc(doc(db,"cases",selectedId), { status:"follow", decision:$("#dDecision").value });
        loadCases();
      });
      $("#btnRefer")?.addEventListener("click", async()=>{
        if(!selectedId) return alert("ุงุฎุชุฑ ุญุงูุฉ");
        const { db, doc, updateDoc } = window.FB;
        await updateDoc(doc(db,"cases",selectedId), { status:"refer", decision:$("#dDecision").value });
        loadCases();
      });

      document.addEventListener("DOMContentLoaded", async()=>{
        await showFB();
        await loadCases();
        const name = localStorage.getItem("USER_NAME") || "ุทุจูุจ";
        document.querySelectorAll("[data-user-name]").forEach(el=>el.textContent=name);
      });
    })();
  </script>
</body>
</html>
