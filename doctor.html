<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุจูุงุจุฉ ุงูุทุจูุจ โ ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</title>
  <link rel="stylesheet" href="app.css" />
</head>

<body data-page="doctor">

  <!-- Topbar -->
  <header class="topbar">
    <div class="inner">
      <div class="topbar_left">
        <a class="btn ghost" href="index.html">โฉ๏ธ ุงูุฑุฆูุณูุฉ</a>

        <div class="brand">
          <div class="brand__logo"></div>
          <div class="brand__txt">
            <div class="brand__name">ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</div>
            <div class="brand__sub">ุจูุงุจุฉ ุงูุทุจูุจ โข Queue โข ูุฑุงุฑุงุช โข ูุชุงุจุนุฉ</div>
          </div>
        </div>

        <div class="pill">
          <small>ุงูุฏูุฑ</small>
          <b data-user-role>doctor</b>
        </div>
      </div>

      <div class="topbar_right">
        <div class="pill">
          <small>ูุฑุญุจูุง</small>
          <b data-user-name>ุทุจูุจ</b>
        </div>
        <button class="btn ghost" id="btnTheme" data-action="common:theme-toggle">๐</button>
        <button class="btn bad" id="btnLogout" data-action="common:logout">ุฎุฑูุฌ</button>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- Hero -->
    <section class="panel hero">
      <div class="heroRow">
        <div>
          <div class="heroTitle">๐ฉบ ููุญุฉ ุงูุทุจูุจ โ ุงููุฑุงุฑ ุนูุฏู</div>
          <div class="heroDesc">
            ุฑุงุฌุน ุงูุญุงูุงุช ุงููุงุฑุฏุฉุ ุงุทูุจ ูุฑุงุกุฉ ุซุงููุฉ ููุญุณุงุณุงุชุ ุงุณุชุฎุฏู ุงููุณุงุนุฏ ุงูุทุจู (ุชุฌุฑูุจู)ุ
            ุซู ุงุชุฎุฐ ุงููุฑุงุฑ: ูุชุงุจุนุฉุ ุฒูุงุฑุฉุ ุฃู ุฅุบูุงู.
          </div>

          <div class="heroActions mt12">
            <button class="btn" id="btnDoctorQueue" data-action="doctor:view-queue">๐ ุนุฑุถ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ</button>
            <button class="btn primary" id="btnOpenCase" data-action="doctor:open-case">๐ ูุชุญ ุงูุญุงูุฉ ุงููุญุฏุฏุฉ</button>
            <a class="btn ghost" href="visit.html">๐ฅ ูุชุญ ุบุฑูุฉ ุงูุฒูุงุฑุฉ</a>
          </div>
        </div>

        <div class="kpiRow" style="min-width:320px;">
          <div class="kpi">
            <div class="kLabel">ุงูุญุงูุงุช ุงููุงุฑุฏุฉ</div>
            <div class="kVal" id="d_k_in">0</div>
            <div class="kMeta">Assigned / New</div>
          </div>
          <div class="kpi warn">
            <div class="kLabel">ุชุญุชุงุฌ ูุชุงุจุนุฉ</div>
            <div class="kVal" id="d_k_follow">0</div>
            <div class="kMeta">Followup</div>
          </div>
          <div class="kpi bad">
            <div class="kLabel">ุญุฑุฌุฉ</div>
            <div class="kVal" id="d_k_critical">0</div>
            <div class="kMeta">Critical</div>
          </div>
        </div>
      </div>
    </section>

    <div class="grid mt16">

      <!-- Queue -->
      <section class="panel card col-6">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">๐</span> ูุงุฆูุฉ ุงูุงูุชุธุงุฑ</div>
          <span class="chip">Queue</span>
        </div>

        <div class="cardBody">
          <div id="d_queue">
            <div class="subtle">ูุง ุชูุฌุฏ ุญุงูุงุช ุญุงููุงู.</div>
          </div>
        </div>
      </section>

      <!-- Case Details -->
      <section class="panel card col-6">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">๐</span> ุชูุงุตูู ุงูุญุงูุฉ</div>
          <span class="chip warn">Live</span>
        </div>

        <div class="cardBody">
          <div class="rowCard">
            <div class="rowTitle">ุงูุทุงูุจ</div>
            <div class="rowMeta" id="d_owner">โ</div>
          </div>

          <div class="rowCard">
            <div class="rowTitle">ุงูุดููู</div>
            <div class="rowMeta" id="d_symptoms">โ</div>
          </div>

          <div class="rowCard">
            <div class="rowTitle">ุงููุฑุงุฑ ุงูุญุงูู</div>
            <div class="rowMeta" id="d_decision">โ</div>
          </div>

          <div class="flex mt12">
            <button class="btn small" id="btnRunSensors2" data-action="student:run-sensors">๐ ุทูุจ ูุฑุงุกุฉ ุซุงููุฉ</button>
            <button class="btn small ghost" data-action="common:download-report">โฌ๏ธ ุชูุฑูุฑ</button>
          </div>
        </div>
      </section>

      <!-- Vitals -->
      <section class="panel card col-6">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">๐</span> ุงูููุงุณุงุช</div>
          <span class="chip warn">Demo</span>
        </div>

        <div class="cardBody">
          <div class="vitals">
            <div class="vital">
              <div class="vLabel">ูุจุถ ุงูููุจ</div>
              <div class="vVal" id="d_hr">โ</div>
            </div>
            <div class="vital">
              <div class="vLabel">ุงูุฃูุณุฌูู</div>
              <div class="vVal" id="d_spo2">โ</div>
            </div>
            <div class="vital">
              <div class="vLabel">ุงูุญุฑุงุฑุฉ</div>
              <div class="vVal" id="d_temp">โ</div>
            </div>
            <div class="vital">
              <div class="vLabel">ุงูุถุบุท</div>
              <div class="vVal" id="d_bp">โ</div>
            </div>
          </div>
        </div>
      </section>

      <!-- AI Assistant + Decision -->
      <section class="panel card col-6">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">๐ค</span> ูุณุงุนุฏ ุงูุทุจูุจ (AI)</div>
          <span class="chip">Assist</span>
        </div>

        <div class="cardBody">
          <div class="field">
            <label>ููุชุฑุญ ุชุดุฎูุต/ุฎุทุฉ (ุชุฌุฑูุจู)</label>
            <textarea id="ai_suggest" class="input" rows="4" placeholder="ูุซุงู: ุฃุนุฑุงุถ ุนุฏูู ุชููุณูุฉ ุฎูููุฉ โ ุฑุงุญุฉ ูุณูุงุฆู ููุชุงุจุนุฉ ุจุนุฏ 24 ุณุงุนุฉ."></textarea>
          </div>

          <div class="field">
            <label>ูุฑุงุฑ ุงูุทุจูุจ ุงูููุงุฆู</label>
            <textarea id="txtDecision" class="input" rows="3" placeholder="ุงูุชุจ ูุฑุงุฑู ููุงโฆ"></textarea>
          </div>

          <div class="flex mt12">
            <button class="btn primary" id="btnUpdateDecision" data-action="doctor:update-decision">๐พ ุญูุธ ุงููุฑุงุฑ</button>
            <button class="btn warn" id="btnFollowup" data-action="doctor:request-followup">๐ ุทูุจ ูุชุงุจุนุฉ</button>
            <button class="btn bad" id="btnCloseCase" data-action="doctor:close-case">๐ ุฅุบูุงู ุงูุญุงูุฉ</button>
          </div>
        </div>
      </section>

      <!-- Parent / Visit -->
      <section class="panel card col-12">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">๐จโ๐ฉโ๐งโ๐ฆ</span> ููู ุงูุฃูุฑ ูุงูุฒูุงุฑุฉ</div>
          <span class="chip ok">Actions</span>
        </div>

        <div class="cardBody">
          <div class="flex">
            <button class="btn" data-action="parent:approve-consent">๐จ ุทูุจ ููุงููุฉ ููู ุงูุฃูุฑ</button>
            <a class="btn ghost" href="parent.html">ูุชุญ ุจูุงุจุฉ ููู ุงูุฃูุฑ</a>
            <a class="btn primary" href="visit.html">๐ฅ ุจุฏุก/ุงูุงูุถูุงู ูุฒูุงุฑุฉ</a>
          </div>
          <div class="subtle mt8">
            *ุทูุจ ููุงููุฉ ููู ุงูุฃูุฑ ููุฑุณู ุชูุจูู (ุชุฌุฑูุจู) ูููููู ุงูููุงููุฉ ูู ุตูุญุชู.*
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Scripts -->
  <script src="./bus.js"></script>
  <script src="./auth.js"></script>
  <script src="./sensor-sim.js"></script>

  <!-- Firebase init (module) -->
  <script type="module" src="./firebase-init.js"></script>

  <!-- Actions -->
  <script src="./actions.js"></script>

  <!-- Doctor binder -->
  <script>
    (function(){
      "use strict";
      const $ = (s,r=document)=>r.querySelector(s);
      const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

      function stats(){
        const DB = window.SSC?.db;
        if(!DB) return;
        const cases = DB.cases||[];
        $("#d_k_in").textContent = cases.length;
        $("#d_k_follow").textContent = cases.filter(c=>c.status==="followup_required").length;
        $("#d_k_critical").textContent = cases.filter(c=>c.priority==="critical"||c.risk==="high").length;
      }

      function renderQueue(){
        const DB = window.SSC?.db;
        const box = $("#d_queue");
        if(!DB || !box) return;
        const cases = DB.cases||[];
        box.innerHTML = cases.length
          ? cases.slice(0,8).map(c=>`
            <div class="rowCard">
              <div class="rowTitle">${esc(c.owner?.name||"ุทุงูุจ")} โข <span class="subtle">#${esc(c.id)}</span></div>
              <div class="rowMeta">ุงูุญุงูุฉ: <b>${esc(c.status||"โ")}</b> โข ุงูุฃููููุฉ: <b>${esc(c.priority||"โ")}</b></div>
              <div class="rowMeta">${esc((c.symptoms||"โ").slice(0,80))}</div>
            </div>
          `).join("")
          : `<div class="subtle">ูุง ุชูุฌุฏ ุญุงูุงุช ุญุงููุงู.</div>`;
      }

      function renderCase(){
        const DB = window.SSC?.db;
        if(!DB) return;
        const c = DB.cases?.[0];
        if(!c){
          $("#d_owner").textContent = "โ";
          $("#d_symptoms").textContent = "โ";
          $("#d_decision").textContent = "โ";
          return;
        }
        $("#d_owner").textContent = c.owner?.name || "โ";
        $("#d_symptoms").textContent = c.symptoms || "โ";
        $("#d_decision").textContent = c.decision || "โ";

        $("#d_hr").textContent = c.vitals?.hr ?? "โ";
        $("#d_spo2").textContent = c.vitals?.spo2 ?? "โ";
        $("#d_temp").textContent = c.vitals?.temp ?? "โ";
        $("#d_bp").textContent = c.vitals?.bp ?? "โ";
      }

      document.addEventListener("DOMContentLoaded", ()=>{
        stats(); renderQueue(); renderCase();
        window.bus?.on?.("case:update", ()=>{ stats(); renderQueue(); renderCase(); });
      });
    })();
  </script>

</body>
</html>
