<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Smart Clinic OS â€” Doctor</title>
  <link rel="stylesheet" href="ar.css"/>
  <link rel="stylesheet" href="shell.css"/>
  <script src="bus.js"></script>
  <script src="sensor-sim.js"></script>
  <script src="ai-triage.js"></script>
  <script src="doctor-copilot.js"></script>
  <script src="rbac.js"></script>
</head>
<body>

<div class="sc-top">
  <div class="left">
    <span class="sc-chip" id="scRoleChip">Doctor</span>
    <div class="sc-title">
      <b id="scRoleTitle">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨</b>
      <small>Ø§Ù„Ø·Ù„Ø¨Ø§Øª + Ù‚Ø±Ø§Ø¡Ø§Øª + ØªÙˆØµÙŠØ© AI + ØªØ´Ø®ÙŠØµ + Ù‚Ø±Ø§Ø±Ø§Øª</small>
    </div>
  </div>
  <div class="sc-actions">
    <span class="sc-status" id="scStatus">ğŸŸ¢ Ready</span>
    <a class="sc-primary" id="scPrimaryAction" href="visit.html?role=doctor">ğŸ¥ Ø²ÙŠØ§Ø±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</a>
  </div>
</div>

<div class="sc-shell">
  <aside class="sc-side">
    <div class="sc-chip">Ø§Ù„ØªÙ†Ù‚Ù‘Ù„</div>
    <nav class="sc-nav">
      <a class="sc-nav-item" href="index.html">ğŸ  Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</a>
      <a class="sc-nav-item" href="#inbox">ğŸ“¥ Ø¢Ø®Ø± Ø­Ø§Ù„Ø©</a>
      <a class="sc-nav-item" href="#dx">ğŸ§  Ø§Ù„ØªØ´Ø®ÙŠØµ</a>
      <a class="sc-nav-item" href="report.html">ğŸ§¾ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
    </nav>

    <div style="margin-top:14px" class="sc-chip">Quick</div>
    <div class="sc-quick">
      <button class="sc-qa" id="btnLoad">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ø­Ø§Ù„Ø©</button>
      <button class="sc-qa" id="btnReRead">ğŸ” Ø·Ù„Ø¨ Ù‚Ø±Ø§Ø¡Ø© Ø«Ø§Ù†ÙŠØ©</button>
      <button class="sc-qa" id="btnAIHelp">ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ ØªØ´Ø®ÙŠØµ AI</button>
      <a class="sc-qa" id="btnVisit" href="visit.html?role=doctor">ğŸ¥ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</a>
    </div>
  </aside>

  <main class="sc-main">
    <div style="padding:16px">
      <div class="panel" id="inbox">
        <div class="h">
          <h2>Ø¢Ø®Ø± Ø­Ø§Ù„Ø© ÙˆØ§Ø±Ø¯Ø©</h2>
          <div class="muted">Complaint + Vitals + AI</div>
        </div>

        <div class="row">
          <span class="badge">Case: <b id="caseId">â€”</b></span>
          <span class="badge">Priority: <b id="casePri">â€”</b></span>
          <span class="badge">Risk: <b id="caseRisk">â€”</b></span>
        </div>

        <div class="sep"></div>

        <div class="kpis">
          <div class="kpi"><b>Temp</b><span id="vTemp">â€”</span></div>
          <div class="kpi"><b>HR</b><span id="vHR">â€”</span></div>
          <div class="kpi"><b>SpOâ‚‚</b><span id="vSp">â€”</span></div>
          <div class="kpi"><b>BP</b><span id="vBP">â€”</span></div>
        </div>

        <div class="sep"></div>

        <div class="h"><h2>Ø§Ù„Ø´ÙƒÙˆÙ‰</h2><div class="muted">Ù…Ù† Ø§Ù„Ø·Ø§Ù„Ø¨</div></div>
        <div class="panel" style="padding:12px; border-radius:14px;">
          <div id="complaint">â€”</div>
        </div>

        <div class="sep"></div>

        <div class="h"><h2>ØªÙˆØµÙŠØ© AI</h2><div class="muted">Recommendation</div></div>
        <div class="panel" style="padding:12px; border-radius:14px;">
          <div id="aiRec">â€”</div>
          <div class="muted small" id="aiFlags">â€”</div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn ghost" id="btnReRead2">ğŸ” Ø·Ù„Ø¨ Ù‚Ø±Ø§Ø¡Ø© Ø«Ø§Ù†ÙŠØ©</button>
          <a class="btn" id="btnVisit2" href="visit.html?role=doctor">ğŸ¥ Ù‚Ø¨ÙˆÙ„/Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</a>
          <button class="btn ghost" id="btnAskParent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</button>
        </div>
      </div>

      <div class="panel" id="dx" style="margin-top:16px">
        <div class="h">
          <h2>Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ®Ø·Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h2>
          <div class="muted">Dx + Plan + Decisions</div>
        </div>

        <textarea id="dxText" class="input" rows="4" style="width:100%; border-radius:14px; padding:12px;"
          placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ´Ø®ÙŠØµ / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>

        <div class="sep"></div>

        <textarea id="planText" class="input" rows="3" style="width:100%; border-radius:14px; padding:12px;"
          placeholder="Ø§Ù„Ø®Ø·Ø©: Ø±Ø§Ø­Ø©/Ù…ØªØ§Ø¨Ø¹Ø©/Ø¥Ø­Ø§Ù„Ø©..."></textarea>

        <div class="sep"></div>
        <div class="sep"></div>

<div class="panel" style="padding:12px; border-radius:14px;">
  <div class="h">
    <h2>ğŸ¤– Doctor AI Copilot</h2>
    <div class="muted">Ù…Ù„Ø®Øµ + DDx + Red Flags + Ø£Ø³Ø¦Ù„Ø© + Ø®Ø·Ø© + ØªÙ‚Ø±ÙŠØ±</div>
  </div>

  <div class="row">
    <button class="btn" id="btnCopilot">âš¡ ØªÙˆÙ„ÙŠØ¯ Copilot</button>
    <button class="btn ghost" id="btnCopyReport">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
  </div>

  <div class="sep"></div>

  <pre id="cpOut" style="white-space:pre-wrap; margin:0; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; opacity:.95;"></pre>
</div>

        <div class="row">
          <button class="btn" id="btnApprove">âœ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø­Ø§Ù„Ø©</button>
          <button class="btn ghost" id="btnNeedConsent">ğŸŸ¡ ØªØ­ÙˆÙŠÙ„ Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</button>
          <button class="btn ghost" id="btnRefer">ğŸš‘ Ø¥Ø­Ø§Ù„Ø©</button>
          <button class="btn ghost" id="btnReject">â›” Ø±ÙØ¶/Ø¥ØºÙ„Ø§Ù‚</button>
        </div>

        <div class="small" id="hint">Ø­Ù…Ù‘Ù„ Ø¢Ø®Ø± Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§ÙƒØªØ¨ Ø§Ù„ØªØ´Ø®ÙŠØµ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø§Ø¹Ø¯ AI.</div>
      </div>

    </div>
  </main>
</div>

<script>
localStorage.setItem("SC_ROLE","doctor");
const $ = (s)=>document.querySelector(s);
let currentCase = null;

function paintCase(c){
  currentCase = c;
  $("#caseId").textContent = c?.id || "â€”";
  $("#casePri").textContent = c?.priority || "â€”";
  $("#caseRisk").textContent = (c?.riskScore ?? c?.ai?.risk ?? "â€”");

  const v = c?.vitals || {};
  $("#vTemp").textContent = v.temp ? (v.temp+"Â°C") : "â€”";
  $("#vHR").textContent   = v.hr ? (v.hr+" bpm") : "â€”";
  $("#vSp").textContent   = v.spo2 ? (v.spo2+"%") : "â€”";
  $("#vBP").textContent   = v.bp || "â€”";

  $("#complaint").textContent = c?.requestDesc || c?.desc || c?.complaint || "â€”";
  $("#aiRec").textContent = c?.ai?.recommendation || c?.decision || "â€”";
  $("#aiFlags").textContent = c?.ai?.flags?.length ? ("Flags: " + c.ai.flags.join(", ")) : "";

  const room = "ROOM-" + (c.id || Date.now());
  $("#btnVisit").href  = `visit.html?role=doctor&room=${encodeURIComponent(room)}&autojoin=1`;
  $("#btnVisit2").href = $("#btnVisit").href;
}

function loadLatest(){
  const bus = window.SCBUS?.load?.();
  const c = bus?.cases?.[0];
  if(!c){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯"); return; }
  // best effort map complaint
  c.requestDesc = bus?.requests?.find(r=>r.id===c.requestId)?.desc || c.requestDesc || c.desc;
  paintCase(c);
}

function saveCase(patch){
  if(!currentCase) return;
  const bus = window.SCBUS.load();
  const idx = (bus.cases||[]).findIndex(x=>x.id===currentCase.id);
  if(idx<0) return;

  bus.cases[idx] = Object.assign({}, bus.cases[idx], patch);
  window.SCBUS.save(bus);
  paintCase(bus.cases[idx]);
}

function requestReRead(){
  if(!currentCase){ alert("Ø­Ù…Ù‘Ù„ Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
  // demo: generate a second reading and attach to case
  const v2 = window.SCSIM.gen(currentCase.priority==="CRIT"?"critical":currentCase.priority==="HIGH"?"sick":"mild");
  const ai2 = window.SCAI.triage({ complaint: $("#complaint").textContent, vitals: v2 });

  const readings = Array.isArray(currentCase.readings) ? currentCase.readings : [];
  readings.unshift({ t: new Date().toISOString(), vitals: v2, ai: ai2 });

  saveCase({ readings, vitals: v2, ai: ai2, note: "ØªÙ…Øª Ù‚Ø±Ø§Ø¡Ø© Ø«Ø§Ù†ÙŠØ© (Ù…Ø­Ø§ÙƒØ§Ø©)" });
  alert("ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© âœ… ÙˆØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
}

function aiAssistant(){
  if(!currentCase){ alert("Ø­Ù…Ù‘Ù„ Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
  const v = currentCase.vitals || {};
  const a = currentCase.ai || {};
  const dx = [
    "Ù…Ù„Ø®Øµ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¨ (AI):",
    `- Priority: ${currentCase.priority || a.priority || "â€”"} | Risk: ${currentCase.riskScore || a.risk || "â€”"}`,
    `- Temp: ${v.temp||"â€”"} | HR: ${v.hr||"â€”"} | SpOâ‚‚: ${v.spo2||"â€”"} | BP: ${v.bp||"â€”"}`,
    `- Recommendation: ${a.recommendation || currentCase.decision || "â€”"}`,
    "",
    "Ø§Ù‚ØªØ±Ø§Ø­ ØªØ´Ø®ÙŠØµ Ø£ÙˆÙ„ÙŠ (Demo):",
    (a.flags||[]).includes("Resp") ? "â€¢ Ø§Ø´ØªØ¨Ø§Ù‡ Ù…Ø´ÙƒÙ„Ø© ØªÙ†ÙØ³ÙŠØ©/Ø§Ù„ØªÙ‡Ø§Ø¨" :
    (a.flags||[]).includes("Fever") ? "â€¢ Ø­Ù…Ù‘Ù‰/Ø¹Ø¯ÙˆÙ‰ Ù…Ø­ØªÙ…Ù„Ø©" :
    "â€¢ Ø£Ø¹Ø±Ø§Ø¶ Ø¹Ø§Ù…Ø© ØªØ­ØªØ§Ø¬ ØªÙ‚ÙŠÙŠÙ…",
    "",
    "Ø®Ø·Ø© Ù…Ù‚ØªØ±Ø­Ø©:",
    currentCase.priority==="CRIT" ? "â€¢ Ø¥Ø¬Ø±Ø§Ø¡ Ø·Ø§Ø±Ø¦ + Ø¥Ø­Ø§Ù„Ø© + Ø¥Ø´Ø¹Ø§Ø± ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" :
    currentCase.priority==="HIGH" ? "â€¢ Ø²ÙŠØ§Ø±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙˆØ±ÙŠØ© + Ù…ØªØ§Ø¨Ø¹Ø© + Ø§Ø­ØªÙ…Ø§Ù„ Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" :
    currentCase.priority==="MED"  ? "â€¢ Ù…ØªØ§Ø¨Ø¹Ø© + Ø¥Ø¹Ø§Ø¯Ø© Ù‚Ø±Ø§Ø¡Ø© + Ø¥Ø±Ø´Ø§Ø¯Ø§Øª" :
    "â€¢ Ø¥Ø±Ø´Ø§Ø¯ ØµØ­ÙŠ + Ø±Ø§Ø­Ø©"
  ].join("\n");

  $("#dxText").value = dx;
  $("#planText").value = a.recommendation || "";
}

function askParentJoin(){
  if(!currentCase){ alert("Ø­Ù…Ù‘Ù„ Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
  saveCase({ parentJoinRequested: true });
  window.SCBUS.pushAlert("parent", currentCase.priority || "MED", "Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ø²ÙŠØ§Ø±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©", `Case ${currentCase.id}`, { caseId: currentCase.id });
  alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù†Ø¶Ù…Ø§Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± âœ…");
}

function approve(){
  if(!currentCase) return;
  saveCase({ status: "APPROVED", dx: $("#dxText").value || "â€”", plan: $("#planText").value || "â€”" });
  alert("ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ âœ…");
}
function needConsent(){
  if(!currentCase) return;
  saveCase({ status: "CONSENT_REQUIRED", dx: $("#dxText").value || "â€”", plan: $("#planText").value || "â€”" });
  window.SCBUS.pushAlert("parent","MED","Ù…Ø·Ù„ÙˆØ¨ Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±",`Case ${currentCase.id}`,{caseId:currentCase.id});
  alert("ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± âœ…");
}
function refer(){
  if(!currentCase) return;
  saveCase({ status: "REFERRED", dx: $("#dxText").value || "â€”", plan: "Ø¥Ø­Ø§Ù„Ø©" });
  alert("ØªÙ…Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø© âœ…");
}
function reject(){
  if(!currentCase) return;
  saveCase({ status: "CLOSED", dx: $("#dxText").value || "â€”", plan: "Ø¥ØºÙ„Ø§Ù‚" });
  alert("ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ âœ…");
}
function runCopilot(){
  if(!currentCase){ alert("Ø­Ù…Ù‘Ù„ Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
  const cp = window.SCDocAI.build(currentCase);

  const out = [];
  out.push(cp.summary);
  out.push("");
  out.push("ØªÙØ±ÙŠÙ‚ ØªØ´Ø®ÙŠØµÙŠ (DDx):");
  cp.ddx.forEach((x,i)=> out.push(`- ${i+1}) ${x}`));

  out.push("");
  out.push("Red Flags:");
  (cp.redFlags.length ? cp.redFlags : ["Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù„Ø§Ù…Ø§Øª Ø¥Ù†Ø°Ø§Ø± ÙˆØ§Ø¶Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"]).forEach(x=> out.push(`- ${x}`));

  out.push("");
  out.push("Ø£Ø³Ø¦Ù„Ø© Ù„Ø§Ø²Ù…Ø© Ù„Ù„Ø·Ø¨ÙŠØ¨:");
  cp.questions.forEach((x,i)=> out.push(`- Q${i+1}: ${x}`));

  out.push("");
  out.push("Ø®Ø·Ø© Ù…Ù‚ØªØ±Ø­Ø©:");
  cp.plan.forEach(x=> out.push(`- ${x}`));

  out.push("");
  out.push("Ø§Ù‚ØªØ±Ø§Ø­ ØµÙŠØ§ØºØ© Dx/Plan (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§):");
  if(!$("#dxText").value.trim()){
    $("#dxText").value =
`ØªØ´Ø®ÙŠØµ Ù…Ø¨Ø¯Ø¦ÙŠ (Demo):
- ${cp.ddx[0] || "Ø£Ø¹Ø±Ø§Ø¶ Ø¹Ø§Ù…Ø©"}
- ÙŠØ­ØªØ§Ø¬ ØªØ£ÙƒÙŠØ¯ Ø³Ø±ÙŠØ±ÙŠ/Ù‚Ø±Ø§Ø¡Ø© Ø«Ø§Ù†ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©

Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
- ${currentCase.ai?.recommendation || "â€”"}
`;
  }
  if(!$("#planText").value.trim()){
    $("#planText").value = cp.plan.map(x=>"â€¢ "+x).join("\n");
  }

  $("#cpOut").textContent = out.join("\n");
}

async function copyReport(){
  if(!currentCase){ alert("Ø­Ù…Ù‘Ù„ Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
  const cp = window.SCDocAI.build(currentCase);
  const dx = $("#dxText").value || "";
  const pl = $("#planText").value || "";
  const decision = currentCase.status || currentCase.decision || (currentCase.ai?.recommendation || "â€”");
  const text = cp.report(dx, pl, decision);

  try{
    await navigator.clipboard.writeText(text);
    alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± âœ…");
  }catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± âœ…");
  }
}
$("#btnLoad").addEventListener("click", loadLatest);
$("#btnReRead").addEventListener("click", requestReRead);
$("#btnReRead2").addEventListener("click", requestReRead);
$("#btnAIHelp").addEventListener("click", aiAssistant);
$("#btnAskParent").addEventListener("click", askParentJoin);
$("#btnApprove").addEventListener("click", approve);
$("#btnNeedConsent").addEventListener("click", needConsent);
$("#btnRefer").addEventListener("click", refer);
$("#btnReject").addEventListener("click", reject);
$("#btnCopilot").addEventListener("click", runCopilot);
$("#btnCopyReport").addEventListener("click", copyReport);
</script>
</body>
</html>
