<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Clinic OS โ ูุงุฌูุฉ ุงูุนูุงุฏุฉ (ุทุจูุจ/ุชูุฑูุถ)</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <div class="logo">SC</div>
      <div>
        <div class="brand-title">Smart Clinic OS</div>
        <div class="brand-sub">Clinic Staff Console โ ูุงุฌูุฉ ุงูุนูุงุฏุฉ (ุทุจูุจ/ุชูุฑูุถ)</div>
      </div>
    </div>

    <div class="top-actions">
  <a class="btn" id="btnGoReport" href="report.html">๐งพ ูุชุญ ุชูุฑูุฑ ุงูุญุงูุฉ</a>
    <a class="btn ghost" href="ar-doctor.html">๐ท AR HUD</a>
  <button class="btn ghost" id="btnTheme">๐</button>
</div>
  </header>

  <div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="nav-title">ุงููุงุฆูุฉ</div>
      <nav class="nav" id="docNav">
        <button class="nav-item active" data-view="triage"><span class="ico">๐ฉบ</span><span>Triage</span></button>
        <button class="nav-item" data-view="diagnosis"><span class="ico">๐ง</span><span>ุชุดุฎูุต/ูุฑุงุฑ</span></button>
        <button class="nav-item" data-view="media"><span class="ico">๐ฅ</span><span>ุตูุช/ุตูุฑุฉ</span></button>
        <button class="nav-item" data-view="report"><span class="ico">๐งพ</span><span>ุชูุฑูุฑ ุงูุญุงูุฉ</span></button>
        <button class="nav-item" data-view="alerts"><span class="ico">๐</span><span>ุชูุจููุงุช/ุฅุจูุงุบ</span></button>
      </nav>

      <div class="sidebar-foot">
        <div class="pill">
          <span class="dot" id="dotLive"></span>
          <div>
            <div style="font-weight:1000;">System</div>
            <div class="muted small" id="sysStatus">System: Ready</div>
          </div>
        </div>

        <button class="btn ghost" id="btnSyncSensors">Sync ุญุณุงุณุงุช (Demo)</button>

        <div class="divider"></div>
        <div class="muted small">
          ูุฐู ูุณุฎุฉ ุนุฑุถ. ุงููุฑุงุกุงุช ูุงูุชุดุฎูุต ููุง ูุฃุบุฑุงุถ ุชุฌุฑูุจูุฉ ููุท.
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">

      <!-- Hero -->
      <section class="hero">
        <div class="hero-left">
          <div class="kicker">๐จโโ๏ธ Clinic Staff</div>
          <h1>ุญุงูุฉ ุณุฑูุฑูุฉ โ ุฅุฏุงุฑุฉ ูุงููุฉ</h1>
          <p class="hero-desc">
            ูุชุญ ุญุงูุฉ โ ูุฑุงุกุงุช โ ุชุดุฎูุต/ูุฑุงุฑ โ ุชูุฑูุฑ โ ุฅุจูุงุบ ููู ุงูุฃูุฑ/ุงูุฅุฏุงุฑุฉ (Demo).
          </p>

          <div class="hero-cta">
            <button class="btn" id="btnQuickTriage">ูุญุต ุณุฑูุน (Demo)</button>
            <button class="btn ghost" id="btnExportCase">ุชุตุฏูุฑ ุงูุญุงูุฉ JSON</button>
          </div>

          <div class="hero-badges">
            <span class="badge">RBAC: Staff</span>
            <span class="badge ghost">Audit Log Enabled</span>
            <span class="badge">Media Capture (Browser)</span>
          </div>
        </div>

        <div class="hero-right">
          <div class="scorecard">
            <div class="scorecard-head">
              <div>
                <div class="score-title">Risk Score</div>
                <div class="score-sub">ุชูููู ุชุฌุฑูุจู ููุญุงูุฉ</div>
              </div>
              <div class="ring">
                <div class="ring-inner">
                  <div class="ring-num" id="riskScore">18</div>
                  <div class="ring-lbl">/100</div>
                </div>
              </div>
            </div>

            <div class="scorecard-grid">
              <div class="mini">
                <div class="mini-k">Priority</div>
                <div class="mini-v" id="prioTxt">LOW</div>
              </div>
              <div class="mini">
                <div class="mini-k">Decision</div>
                <div class="mini-v" id="decisionTxt">โ</div>
              </div>
              <div class="mini">
                <div class="mini-k">Follow-up</div>
                <div class="mini-v" id="followTxt">โ</div>
              </div>
              <div class="mini">
                <div class="mini-k">Notify</div>
                <div class="mini-v" id="notifyTxt">โ</div>
              </div>
            </div>

            <div class="scorecard-foot muted small">* ุชูุฏูุฑุงุช ุฏููู.</div>
          </div>
        </div>
      </section>

      <!-- Views -->
      <section class="views">

        <!-- TRIAGE -->
        <section class="view show" id="view-triage">
          <div class="section-head">
            <div>
              <h2>Triage</h2>
              <div class="muted">ุจูุงูุงุช ุฃูููุฉ + ูุฑุงุกุงุช (Demo)</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnAutoVitals">ุชุนุจุฆุฉ ูุฑุงุกุงุช (Demo)</button>
              <button class="btn" id="btnToDiagnosis">ุงูุชุงูู โ ุชุดุฎูุต</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-head">
                <h3>ุจูุงูุงุช ุงูุญุงูุฉ</h3>
                <div class="muted small" id="caseId">Case: โ</div>
              </div>

              <div class="form">
                <div class="row">
                  <div>
                    <label>ูููุฉ ุงูุทุงูุจ (Demo)</label>
                    <input id="studentId" placeholder="ูุซุงู: STD-23" />
                  </div>
                  <div>
                    <label>ุงูุงุณู (ุงุฎุชูุงุฑู ููุนุฑุถ)</label>
                    <input id="studentName" placeholder="ุทุงูุจ #23" />
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label>ุงูุนูุฑ</label>
                    <input id="age" type="number" min="5" max="20" placeholder="12" />
                  </div>
                  <div>
                    <label>ุงูุตู/ุงููุตู</label>
                    <input id="classRoom" placeholder="6/ุจ" />
                  </div>
                </div>

                <label>ุณุจุจ ุงูุฒูุงุฑุฉ</label>
                <input id="chiefComplaint" placeholder="ุตุฏุงุน / ุญุฑุงุฑุฉ / ุฃูู ุจุทู..." />

                <label>ููุงุญุธุงุช ุฃูููุฉ</label>
                <textarea id="initialNotes" rows="3" placeholder="ูุชู ุจุฏุฃุช ุงูุฃุนุฑุงุถุ ูู ููุงู ุญุณุงุณูุฉุ"></textarea>
              </div>

              <div class="card-actions">
                <button class="btn ghost" id="btnSaveCase">ุญูุธ</button>
                <button class="btn" id="btnCreateCase">ุฅูุดุงุก ุญุงูุฉ</button>
              </div>
            </div>

            <div class="card">
              <div class="card-head">
                <h3>ุงูุนูุงูุงุช ุงูุญูููุฉ</h3>
                <div class="muted small">Vitals (Demo / IoT)</div>
              </div>

              <div class="vitals">
                <div class="vital"><div class="v-k">Temperature</div><div class="v-v"><span id="vTemp">โ</span> ยฐC</div></div>
                <div class="vital"><div class="v-k">Heart Rate</div><div class="v-v"><span id="vHr">โ</span> bpm</div></div>
                <div class="vital"><div class="v-k">SpOโ</div><div class="v-v"><span id="vSpo2">โ</span> %</div></div>
                <div class="vital"><div class="v-k">Blood Pressure</div><div class="v-v"><span id="vBp">โ</span></div></div>
              </div>

              <div class="divider"></div>

              <div class="risk">
                <div>
                  <div class="risk-k">Risk</div>
                  <div class="risk-v low" id="riskTxt">LOW</div>
                </div>
                <div>
                  <div class="risk-k">Progress</div>
                  <div class="riskbar"><span id="riskBar" style="width:18%"></span></div>
                </div>
              </div>

              <div class="card-actions">
                <button class="btn ghost" id="btnCalcRisk">ุญุณุงุจ Risk</button>
                <button class="btn" id="btnLockVitals">ุชุซุจูุช ุงููุฑุงุกุงุช</button>
              </div>
            </div>
          </div>
        </section>

        <!-- DIAGNOSIS / DECISION -->
        <section class="view" id="view-diagnosis">
          <div class="section-head">
            <div>
              <h2>ุชุดุฎูุต / ูุฑุงุฑ</h2>
              <div class="muted">ุชุตููู ุงูุญุงูุฉ + ุฎุทุฉ ุงูุชุนุงูู + ุฅุญุงูุฉ</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnBackTriage">โ ุฑุฌูุน</button>
              <button class="btn" id="btnToMedia">ุงูุชุงูู โ ุตูุช/ุตูุฑุฉ</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-head">
                <h3>ุชุตููู ุงูุญุงูุฉ</h3>
                <div class="muted small">Priority + Decision</div>
              </div>

              <div class="form">
                <div class="row">
                  <div>
                    <label>Priority</label>
                    <select id="priority">
                      <option value="LOW">LOW โ ุจุณูุท</option>
                      <option value="MED">MED โ ูุชูุณุท</option>
                      <option value="HIGH">HIGH โ ุนุงูู</option>
                      <option value="CRIT">CRIT โ ุญุฑุฌ</option>
                    </select>
                  </div>
                  <div>
                    <label>ูุฑุงุฑ ุงูุชุนุงูู</label>
                    <select id="decision">
                      <option value="">โ ุงุฎุชุฑ โ</option>
                      <option value="return_class">ุนูุฏุฉ ูููุตู</option>
                      <option value="observe_followup">ููุงุญุธุฉ + ูุชุงุจุนุฉ</option>
                      <option value="refer_hospital">ุฅุญุงูุฉ (ูุฑูุฒ ุตุญู/ูุณุชุดูู)</option>
                      <option value="call_guardian">ุงุณุชุฏุนุงุก ููู ุงูุฃูุฑ</option>
                      <option value="emergency">ุทูุงุฑุฆ</option>
                    </select>
                  </div>
                </div>

                <label>ุงุดุชุจุงู ุชุดุฎูุตู (Demo)</label>
                <input id="dx" placeholder="ูุซุงู: ุนุฏูู ุชููุณูุฉ / ุฅุฌูุงุฏ /..." />

                <label>ุฎุทุฉ ูุฎุชุตุฑุฉ</label>
                <textarea id="plan" rows="4" placeholder="ุณูุงุฆู/ุฑุงุญุฉ/ูุฑุงูุจุฉ/ุชุนูููุงุช..."></textarea>

                <div class="row">
                  <div>
                    <label>ูุชุงุจุนุฉ ุจุนุฏ</label>
                    <select id="followUp">
                      <option value="">โ</option>
                      <option value="none">ูุง</option>
                      <option value="2h">ุจุนุฏ ุณุงุนุชูู</option>
                      <option value="tomorrow">ุบุฏูุง</option>
                      <option value="3d">ุจุนุฏ 3 ุฃูุงู</option>
                    </select>
                  </div>
                  <div>
                    <label>ุฅุญุงูุฉ ุฅูู</label>
                    <select id="refTo">
                      <option value="">โ</option>
                      <option value="phc">ูุฑูุฒ ุตุญู</option>
                      <option value="hospital">ูุณุชุดูู</option>
                      <option value="ems">ุฅุณุนุงู</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="card-actions">
                <button class="btn ghost" id="btnAutoPlan">ุฎุทุฉ ุฌุงูุฒุฉ (Demo)</button>
                <button class="btn" id="btnApplyDecision">ุชุทุจูู ุงููุฑุงุฑ</button>
              </div>
            </div>

            <div class="card">
              <div class="card-head">
                <h3>ููุงุญุธุงุช ุณุฑูุฑูุฉ</h3>
                <div class="muted small">Clinical notes (Demo)</div>
              </div>

              <div class="form">
                <label>ููุงุญุธุงุช ุงูุทุจูุจ/ุงูุชูุฑูุถ</label>
                <textarea id="clinicalNotes" rows="8" placeholder="ุฃุนุฑุงุถ/ูุญุต/ุนูุงูู ุฎุทูุฑุฉ..."></textarea>
                <label>ุฃุฏููุฉ/ุชูุตูุงุช (ุงุฎุชูุงุฑู)</label>
                <input id="meds" placeholder="ูุซุงู: ุจุงุฑุงุณูุชุงููู ุญุณุจ ุงูุณูุงุณุฉ /..." />
              </div>

              <div class="divider"></div>

              <div class="card-actions">
                <button class="btn ghost" id="btnStamp">ุฎุชู ุงูููุช</button>
                <button class="btn" id="btnToReport">ุฅูุดุงุก ุงูุชูุฑูุฑ โ</button>
              </div>
            </div>
          </div>
        </section>

        <!-- MEDIA -->
        <section class="view" id="view-media">
          <div class="section-head">
            <div>
              <h2>ุตูุช / ุตูุฑุฉ ุฏุงุฎู ุงูุญุงูุฉ</h2>
              <div class="muted">ุชุดุบูู ูุงููุฑุง/ูุงูู (Browser permissions)</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnStopMedia">ุฅููุงู</button>
              <button class="btn" id="btnToReport2">ุงูุชุงูู โ ุงูุชูุฑูุฑ</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-head">
                <h3>ุงููุงููุฑุง</h3>
                <div class="muted small">Video (Demo)</div>
              </div>

              <video id="cam" autoplay playsinline muted style="width:100%; border-radius:18px; border:1px solid var(--stroke); background:var(--panel);"></video>

              <div class="card-actions">
                <button class="btn" id="btnStartCam">ุชุดุบูู ูุงููุฑุง</button>
                <button class="btn ghost" id="btnSnap">ุงูุชูุงุท ุตูุฑุฉ</button>
              </div>

              <div class="divider"></div>
              <div class="muted small">ุงูุตูุฑ ุชูุญูุธ ูู DataURL ุฏุงุฎู ุงููุชุตูุญ (Demo) ูุชูุฑูู ุจุงูุญุงูุฉ.</div>
              <img id="snapImg" alt="" style="display:none; margin-top:10px; width:100%; border-radius:18px; border:1px solid var(--stroke);" />
            </div>

            <div class="card">
              <div class="card-head">
                <h3>ุงูุตูุช</h3>
                <div class="muted small">Audio note (Demo)</div>
              </div>

              <div class="muted">ุชุณุฌูู ููุงุญุธุฉ ุตูุชูุฉ ูุตูุฑุฉ ูุฅุฑูุงููุง ุจุงูุญุงูุฉ.</div>

              <div class="divider"></div>

              <div class="card-actions">
                <button class="btn" id="btnStartRec">ุจุฏุก ุชุณุฌูู</button>
                <button class="btn ghost" id="btnStopRec">ุฅููุงู ุชุณุฌูู</button>
              </div>

              <audio id="audioPlay" controls style="width:100%; margin-top:12px; display:none;"></audio>

              <div class="divider"></div>
              <div class="muted small">* ูุนุชูุฏ ุนูู ุฏุนู ุงููุชุตูุญ ูู MediaRecorder.</div>
            </div>
          </div>
        </section>

        <!-- REPORT -->
        <section class="view" id="view-report">
          <div class="section-head">
            <div>
              <h2>ุชูุฑูุฑ ุงูุญุงูุฉ</h2>
              <div class="muted">ุชูุฑูุฑ ูุงุจู ููุชุตุฏูุฑ (Demo)</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnBackDiag">โ ุฑุฌูุน</button>
              <button class="btn" id="btnExportTxt">ุชุตุฏูุฑ TXT</button>
              <button class="btn" id="btnExportJson">ุชุตุฏูุฑ JSON</button>
            </div>
          </div>

          <div class="card report" id="reportBox">
            <div class="report-title">Clinical Report โ Demo</div>
            <div class="report-meta">
              <span id="rCase">Case: โ</span> โข
              <span id="rStudent">Student: โ</span> โข
              <span id="rTime">Time: โ</span>
            </div>
            <div class="report-body" id="reportBody" style="line-height:1.9;"></div>
            <div class="report-foot muted small">* ูุฐุง ุชูุฑูุฑ ุชุฌุฑูุจู ููุนุฑุถ ูุงูุชุญููู.</div>
          </div>
        </section>

        <!-- ALERTS / NOTIFY -->
        <section class="view" id="view-alerts">
          <div class="section-head">
            <div>
              <h2>ุชูุจููุงุช / ุฅุจูุงุบ</h2>
              <div class="muted">ุฅุจูุงุบ ููู ุงูุฃูุฑ ุฃู ุงูุฅุฏุงุฑุฉ (Demo)</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnToReport3">ูุชุญ ุงูุชูุฑูุฑ</button>
              <button class="btn" id="btnSendNotify">ุฅุฑุณุงู ุงูุฅุจูุงุบ</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-head">
                <h3>ููุงุฉ ุงูุฅุจูุงุบ</h3>
                <div class="muted small">Select recipients</div>
              </div>

              <div class="form">
                <label>ุฅุจูุงุบ ุฅูู</label>
                <select id="notifyTo">
                  <option value="">โ</option>
                  <option value="parent">ููู ุงูุฃูุฑ</option>
                  <option value="admin">ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ</option>
                  <option value="both">ููู ุงูุฃูุฑ + ุงูุฅุฏุงุฑุฉ</option>
                </select>

                <label>ูุณุชูู ุงูุชูุจูู</label>
                <select id="notifyLevel">
                  <option value="LOW">LOW</option>
                  <option value="MED">MED</option>
                  <option value="HIGH">HIGH</option>
                  <option value="CRIT">CRIT</option>
                </select>

                <label>ูุต ุงูุฅุจูุงุบ</label>
                <textarea id="notifyMsg" rows="5" placeholder="ููุฎุต ูุฎุชุตุฑ + ุฅุฌุฑุงุก ูุทููุจ..."></textarea>
              </div>

              <div class="card-actions">
                <button class="btn ghost" id="btnAutoMsg">ูุต ุฌุงูุฒ</button>
                <button class="btn" id="btnLogAlert">ุชุณุฌูู ุชูุจูู</button>
              </div>
            </div>

            <div class="card">
              <div class="card-head">
                <h3>ุณุฌู ุงูุชูุจููุงุช (ูุญูู)</h3>
                <div class="muted small">Local (Demo)</div>
              </div>

              <div class="alerts" id="alertsList">
                <div class="empty">ูุง ุชูุฌุฏ ุชูุจููุงุช ุจุนุฏ</div>
              </div>

              <div class="card-actions">
                <button class="btn ghost" id="btnClearAlerts">ูุณุญ</button>
              </div>
            </div>
          </div>
        </section>

      </section>
    </main>
  </div>

  <!-- Scripts -->
  <script src="bus.js"></script>
<script src="engine.js"></script>
<script src="rbac.js"></script>
<script src="auth-demo.js"></script>
<script src="audit-users.js"></script>
<script src="role-switcher.js"></script>

  <script>
    (function(){
      const $ = (s,r=document)=>r.querySelector(s);
      const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
      const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

      // Force role to staff for this page
      try{
        localStorage.setItem("sc_role","staff");
        window.SCRBAC?.applyRBAC?.();
        window.SCAUDIT?.audit?.("PAGE_OPEN", { page:"doctor.html" });
      }catch(_){}

      // Theme toggle
      $("#btnTheme")?.addEventListener("click", ()=>{
        const html = document.documentElement;
        const next = html.dataset.theme === "light" ? "dark" : "light";
        html.dataset.theme = next;
        try{ window.SCAUDIT?.audit?.("THEME_TOGGLE", { to: next }); }catch(_){}
      });

      // Nav switching
      function openView(view){
        $$("#docNav .nav-item").forEach(b=>b.classList.remove("active"));
        $(`#docNav .nav-item[data-view="${view}"]`)?.classList.add("active");
        $$(".view").forEach(v=>v.classList.remove("show"));
        $(`#view-${view}`)?.classList.add("show");
        try{ window.SCAUDIT?.audit?.("NAV_OPEN", { view }); }catch(_){}
      }
      $$("#docNav .nav-item").forEach(btn=>{
        btn.addEventListener("click", ()=> openView(btn.dataset.view));
      });

      // --- Case model ---
      const caseObj = {
        id: null,
        createdAt: null,
        studentId: "",
        studentName: "",
        age: "",
        classRoom: "",
        chiefComplaint: "",
        initialNotes: "",
        vitals: { temp:null, hr:null, spo2:null, bp:null },
        riskScore: 18,
        priority: "LOW",
        decision: "",
        dx: "",
        plan: "",
        followUp: "",
        refTo: "",
        clinicalNotes: "",
        meds: "",
        media: { photo:null, audio:null },
        notify: { to:"", level:"LOW", msg:"" },
        alerts: []
      };

      function setTxt(id, val){
        const el = $(id);
        if(el) el.textContent = val;
      }

      function newCase(){
        caseObj.id = "CASE-" + Math.random().toString(36).slice(2,8).toUpperCase();
        caseObj.createdAt = new Date();
        setTxt("#caseId", "Case: " + caseObj.id);
        setTxt("#rCase", "Case: " + caseObj.id);
        setTxt("#rTime", "Time: " + (caseObj.createdAt.toLocaleString("ar-SA")));
        $("#studentId").value = "STD-" + rand(10,99);
        $("#studentName").value = "ุทุงูุจ #" + rand(10,99);
        $("#age").value = String(rand(9,16));
        $("#classRoom").value = rand(1,6) + "/"+ ["ุฃ","ุจ","ุฌ"][rand(0,2)];
        $("#chiefComplaint").value = ["ุตุฏุงุน","ุญููู","ุฃูู ุจุทู","ุณุนุงู","ุฅุฌูุงุฏ"][rand(0,4)];
        $("#initialNotes").value = "ูุฏุฉ ุงูุฃุนุฑุงุถ: " + rand(1,6) + " ุณุงุนุฉ. (Demo)";
        try{ window.SCAUDIT?.audit?.("CASE_CREATED", { id: caseObj.id }); }catch(_){}
      }

      // Save form โ object
      function pullCase(){
        caseObj.studentId = ($("#studentId")?.value || "").trim();
        caseObj.studentName = ($("#studentName")?.value || "").trim();
        caseObj.age = ($("#age")?.value || "").trim();
        caseObj.classRoom = ($("#classRoom")?.value || "").trim();
        caseObj.chiefComplaint = ($("#chiefComplaint")?.value || "").trim();
        caseObj.initialNotes = ($("#initialNotes")?.value || "").trim();

        caseObj.priority = $("#priority")?.value || caseObj.priority;
        caseObj.decision = $("#decision")?.value || caseObj.decision;
        caseObj.dx = ($("#dx")?.value || "").trim();
        caseObj.plan = ($("#plan")?.value || "").trim();
        caseObj.followUp = $("#followUp")?.value || "";
        caseObj.refTo = $("#refTo")?.value || "";
        caseObj.clinicalNotes = ($("#clinicalNotes")?.value || "").trim();
        caseObj.meds = ($("#meds")?.value || "").trim();

        caseObj.notify.to = $("#notifyTo")?.value || "";
        caseObj.notify.level = $("#notifyLevel")?.value || "LOW";
        caseObj.notify.msg = ($("#notifyMsg")?.value || "").trim();
      }

      // Risk
      function computeRisk(){
        // Demo logic based on vitals
        const t = caseObj.vitals.temp ?? 36.8;
        const hr = caseObj.vitals.hr ?? 85;
        const spo2 = caseObj.vitals.spo2 ?? 98;

        let score = 10;
        if(t >= 38.0) score += 18;
        if(hr >= 110) score += 18;
        if(spo2 <= 94) score += 35;

        score += Math.min(20, (caseObj.chiefComplaint?.length || 0));
        score = Math.max(0, Math.min(100, score));
        caseObj.riskScore = score;

        // Priority mapping
        let pr = "LOW";
        if(score >= 65) pr = "CRIT";
        else if(score >= 45) pr = "HIGH";
        else if(score >= 28) pr = "MED";
        caseObj.priority = pr;

        setTxt("#riskScore", String(score));
        setTxt("#prioTxt", pr);
        setTxt("#riskTxt", pr);
        const rb = $("#riskBar");
        if(rb) rb.style.width = score + "%";
        $("#riskTxt")?.classList.remove("low","med","high","crit");
        $("#riskTxt")?.classList.add(pr==="LOW"?"low":pr==="MED"?"med":pr==="HIGH"?"high":"crit");

        try{ window.SCAUDIT?.audit?.("RISK_COMPUTED", { score, priority: pr }); }catch(_){}
      }

      // Vitals auto
      function fillVitalsFromEngine(){
        let r = null;
        try{ r = window.ClinicEngine?.syncSensors?.(); }catch(_){}
        if(!r){
          // fallback demo
          r = { temperature: +(36.6+Math.random()*1.3).toFixed(1), heartRate: rand(70,110), spo2: rand(95,99), bp: rand(105,128)+"/"+rand(65,85) };
        }
        caseObj.vitals.temp = r.temperature;
        caseObj.vitals.hr = r.heartRate;
        caseObj.vitals.spo2 = r.spo2;
        caseObj.vitals.bp = r.bp;

        $("#vTemp").textContent = String(r.temperature);
        $("#vHr").textContent = String(r.heartRate);
        $("#vSpo2").textContent = String(r.spo2);
        $("#vBp").textContent = String(r.bp);

        try{ window.SCAUDIT?.audit?.("VITALS_FILLED", { temp:r.temperature, hr:r.heartRate, spo2:r.spo2, bp:r.bp }); }catch(_){}
      }

      // Decision apply
      function applyDecision(){
        pullCase();

        setTxt("#prioTxt", caseObj.priority);
        setTxt("#decisionTxt", caseObj.decision || "โ");
        setTxt("#followTxt", caseObj.followUp || "โ");

        // Suggest notify
        let notify = "โ";
        if(caseObj.decision === "call_guardian" || caseObj.priority === "HIGH" || caseObj.priority === "CRIT") notify = "Parent";
        if(caseObj.decision === "emergency") notify = "Parent+Admin";
        setTxt("#notifyTxt", notify);

        try{ window.SCAUDIT?.audit?.("DECISION_APPLIED", { priority:caseObj.priority, decision:caseObj.decision, followUp:caseObj.followUp, refTo:caseObj.refTo }); }catch(_){}
        buildReport();
      }

      function autoPlan(){
        const cc = ($("#chiefComplaint").value||"").trim();
        $("#dx").value = cc.includes("ุณุนุงู") ? "ุงุดุชุจุงู ุนุฏูู ุชููุณูุฉ (Demo)"
                  : cc.includes("ุญู") ? "ุญููู/ุนุฏูู ูุญุชููุฉ (Demo)"
                  : cc.includes("ุจุทู") ? "ุงุถุทุฑุงุจ ูุถูู (Demo)"
                  : "ุฅุฌูุงุฏ/ุตุฏุงุน (Demo)";

        $("#plan").value =
`- ุชูููู ุฃููู + ูุฑุงุกุงุช.\n- ุณูุงุฆู + ุฑุงุญุฉ.\n- ุชูุฌููุงุช ุตุญูุฉ.\n- ูุชุงุจุนุฉ ุญุณุจ ุงูุญุงุฌุฉ.\n(ูุฐู ุฎุทุฉ ุชุฌุฑูุจูุฉ ููุนุฑุถ)`;

        $("#clinicalNotes").value =
`ูุญุต ูุจุฏุฆู: ูุง ุชูุฌุฏ ุนูุงูุงุช ุฎุทูุฑุฉ ูุงุถุญุฉ (Demo).\nุชูููู: ุญุณุจ ุงููุฑุงุกุงุช ูุงูุฃุนุฑุงุถ.\n`;

        try{ window.SCAUDIT?.audit?.("AUTO_PLAN_USED", {}); }catch(_){}
      }

      function stamp(){
        const t = new Date().toLocaleString("ar-SA");
        $("#clinicalNotes").value = ($("#clinicalNotes").value||"") + `\n[Stamp] ${t}\n`;
        try{ window.SCAUDIT?.audit?.("STAMP_ADDED", { t }); }catch(_){}
      }

      // Report builder
      function buildReport(){
        pullCase();
        const lines = [
          `โข ุงูุทุงูุจ: ${caseObj.studentName || "โ"} (${caseObj.studentId || "โ"})`,
          `โข ุงูุนูุฑ/ุงููุตู: ${caseObj.age || "โ"} โ ${caseObj.classRoom || "โ"}`,
          `โข ุณุจุจ ุงูุฒูุงุฑุฉ: ${caseObj.chiefComplaint || "โ"}`,
          `โข ููุงุญุธุงุช ุฃูููุฉ: ${caseObj.initialNotes || "โ"}`,
          "",
          `โข ุงููุฑุงุกุงุช: Temp=${caseObj.vitals.temp ?? "โ"}ยฐC | HR=${caseObj.vitals.hr ?? "โ"} | SpOโ=${caseObj.vitals.spo2 ?? "โ"}% | BP=${caseObj.vitals.bp ?? "โ"}`,
          `โข Risk Score: ${caseObj.riskScore}/100`,
          `โข Priority: ${caseObj.priority}`,
          "",
          `โข ุงุดุชุจุงู ุชุดุฎูุตู: ${caseObj.dx || "โ"}`,
          `โข ุงููุฑุงุฑ: ${caseObj.decision || "โ"}`,
          `โข ูุชุงุจุนุฉ: ${caseObj.followUp || "โ"}`,
          `โข ุฅุญุงูุฉ ุฅูู: ${caseObj.refTo || "โ"}`,
          "",
          `โข ุงูุฎุทุฉ:`,
          `${caseObj.plan || "โ"}`,
          "",
          `โข ููุงุญุธุงุช ุณุฑูุฑูุฉ:`,
          `${caseObj.clinicalNotes || "โ"}`,
          "",
          `โข ุฃุฏููุฉ/ุชูุตูุงุช: ${caseObj.meds || "โ"}`,
          "",
          `โข ูุณุงุฆุท: ุตูุฑุฉ=${caseObj.media.photo ? "ูุฑููุฉ" : "ูุง"} | ุตูุช=${caseObj.media.audio ? "ูุฑูู" : "ูุง"}`,
          `โข ุฅุดุนุงุฑ: ${caseObj.notify.to || "โ"} | ูุณุชูู=${caseObj.notify.level || "โ"}`
        ];

        $("#rStudent").textContent = "Student: " + (caseObj.studentName || caseObj.studentId || "โ");
        $("#reportBody").innerHTML = lines.map(x => x ? `<div>${escapeHtml(x)}</div>` : `<div style="height:10px"></div>`).join("");

        try{ window.SCAUDIT?.audit?.("REPORT_BUILT", { caseId: caseObj.id }); }catch(_){}
      }

      function escapeHtml(s){
        return String(s).replace(/[&<>"']/g, m => ({
          "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
        }[m]));
      }

      // Export helpers
      function download(name, text, type="text/plain"){
        const blob = new Blob([text], {type:type+";charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = name;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 800);
      }

      function exportJSON(){
        pullCase();
        download((caseObj.id||"case")+"-demo.json", JSON.stringify(caseObj, null, 2), "application/json");
        try{ window.SCAUDIT?.audit?.("CASE_EXPORTED_JSON", { id: caseObj.id }); }catch(_){}
      }

      function exportTXT(){
        pullCase();
        const txt =
`Clinical Report (Demo)
Case: ${caseObj.id}
Student: ${caseObj.studentName} (${caseObj.studentId})
Class: ${caseObj.classRoom} Age: ${caseObj.age}

Chief Complaint: ${caseObj.chiefComplaint}
Notes: ${caseObj.initialNotes}

Vitals: Temp=${caseObj.vitals.temp} HR=${caseObj.vitals.hr} SpO2=${caseObj.vitals.spo2} BP=${caseObj.vitals.bp}
Risk: ${caseObj.riskScore}/100 Priority: ${caseObj.priority}

Dx: ${caseObj.dx}
Decision: ${caseObj.decision}
Follow-up: ${caseObj.followUp}
Referral: ${caseObj.refTo}

Plan:
${caseObj.plan}

Clinical Notes:
${caseObj.clinicalNotes}

Meds: ${caseObj.meds}

Media: photo=${caseObj.media.photo?"yes":"no"} audio=${caseObj.media.audio?"yes":"no"}
Notify: ${caseObj.notify.to} level=${caseObj.notify.level}
`;
        download((caseObj.id||"case")+"-report.txt", txt);
        try{ window.SCAUDIT?.audit?.("CASE_EXPORTED_TXT", { id: caseObj.id }); }catch(_){}
      }

      // Alerts (local demo)
      function renderAlerts(){
        const box = $("#alertsList");
        if(!box) return;
        if(!caseObj.alerts.length){
          box.innerHTML = `<div class="empty">ูุง ุชูุฌุฏ ุชูุจููุงุช ุจุนุฏ</div>`;
          return;
        }
        box.innerHTML = caseObj.alerts.map(a=>`
          <div class="alert ${a.level==='CRIT'?'crit':a.level==='HIGH'?'high':''}">
            <div class="a-top">
              <div class="a-title">${a.title}</div>
              <div class="muted">${a.time}</div>
            </div>
            <div class="a-body">${escapeHtml(a.body)}</div>
          </div>
        `).join("");
      }

      function logAlert(){
        pullCase();
        const to = caseObj.notify.to || "โ";
        const lvl = caseObj.notify.level || "LOW";
        const msg = caseObj.notify.msg || "ุชูุจูู ุชุฌุฑูุจู (Demo)";
        const a = {
          time: new Date().toLocaleTimeString("ar-SA"),
          level: lvl,
          title: "ุชูุจูู/ุฅุจูุงุบ",
          body: `ุฅูู: ${to} | ${msg}`
        };
        caseObj.alerts.unshift(a);
        caseObj.alerts = caseObj.alerts.slice(0,6);
        renderAlerts();
        setTxt("#notifyTxt", to === "both" ? "Parent+Admin" : to || "โ");
        try{ window.SCAUDIT?.audit?.("ALERT_LOGGED", { to, level:lvl }); }catch(_){}
      }

      function sendNotify(){
        pullCase();
        if(!caseObj.notify.to){
          alert("ุงุฎุชุฑ ุฌูุฉ ุงูุฅุจูุงุบ ุฃููุงู");
          return;
        }
        // Demo: just audit + UI
        try{ window.SCAUDIT?.audit?.("NOTIFY_SENT", { to:caseObj.notify.to, level:caseObj.notify.level, caseId:caseObj.id }); }catch(_){}
        alert("ุชู ุฅุฑุณุงู ุงูุฅุจูุงุบ (Demo) โ");
        setTxt("#notifyTxt", caseObj.notify.to === "both" ? "Parent+Admin" : caseObj.notify.to);
      }

      // Media
      let camStream = null;
      let recStream = null;
      let recorder = null;
      let chunks = [];

      async function startCam(){
        try{
          camStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
          $("#cam").srcObject = camStream;
          try{ window.SCAUDIT?.audit?.("CAM_STARTED", { caseId: caseObj.id }); }catch(_){}
        }catch(e){
          alert("ุชุนุฐุฑ ุชุดุบูู ุงููุงููุฑุง. ุชุฃูุฏ ูู ุงูุณูุงุญ ุจุงูุตูุงุญูุฉ.");
        }
      }

      function stopMedia(){
        if(camStream){
          camStream.getTracks().forEach(t=>t.stop());
          camStream = null;
        }
        if(recStream){
          recStream.getTracks().forEach(t=>t.stop());
          recStream = null;
        }
        try{ window.SCAUDIT?.audit?.("MEDIA_STOPPED", { caseId: caseObj.id }); }catch(_){}
      }

      function snap(){
        const v = $("#cam");
        if(!v || !v.videoWidth) { alert("ุดุบูู ุงููุงููุฑุง ุฃููุงู"); return; }
        const c = document.createElement("canvas");
        c.width = v.videoWidth; c.height = v.videoHeight;
        const ctx = c.getContext("2d");
        ctx.drawImage(v, 0, 0);
        const data = c.toDataURL("image/jpeg", 0.85);
        caseObj.media.photo = data;
        const img = $("#snapImg");
        img.src = data;
        img.style.display = "";
        try{ window.SCAUDIT?.audit?.("PHOTO_ATTACHED", { caseId: caseObj.id }); }catch(_){}
      }

      async function startRec(){
        if(!window.MediaRecorder){ alert("ุฌูุงุฒู/ูุชุตูุญู ูุง ูุฏุนู MediaRecorder"); return; }
        try{
          recStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
          recorder = new MediaRecorder(recStream);
          chunks = [];
          recorder.ondataavailable = (e)=>{ if(e.data.size>0) chunks.push(e.data); };
          recorder.onstop = ()=>{
            const blob = new Blob(chunks, { type: "audio/webm" });
            const url = URL.createObjectURL(blob);
            caseObj.media.audio = url; // demo: objectURL (ุฌูุณุฉ ุงููุชุตูุญ)
            const a = $("#audioPlay");
            a.src = url;
            a.style.display = "";
            try{ window.SCAUDIT?.audit?.("AUDIO_ATTACHED", { caseId: caseObj.id }); }catch(_){}
          };
          recorder.start();
          try{ window.SCAUDIT?.audit?.("REC_STARTED", { caseId: caseObj.id }); }catch(_){}
        }catch(e){
          alert("ุชุนุฐุฑ ุชุดุบูู ุงููุงูู. ุชุฃูุฏ ูู ุงูุณูุงุญ ุจุงูุตูุงุญูุฉ.");
        }
      }

      function stopRec(){
        try{
          recorder?.stop?.();
          recStream?.getTracks?.().forEach(t=>t.stop());
          recStream = null;
          try{ window.SCAUDIT?.audit?.("REC_STOPPED", { caseId: caseObj.id }); }catch(_){}
        }catch(_){}
      }

      // Wire buttons
      $("#btnCreateCase")?.addEventListener("click", ()=>{ if(!caseObj.id) newCase(); pullCase(); buildReport(); });
      $("#btnSaveCase")?.addEventListener("click", ()=>{ pullCase(); buildReport(); try{ window.SCAUDIT?.audit?.("CASE_SAVED", { id: caseObj.id }); }catch(_){}});

      $("#btnAutoVitals")?.addEventListener("click", ()=>{ if(!caseObj.id) newCase(); pullCase(); fillVitalsFromEngine(); });
      $("#btnAutoVitals")?.addEventListener("click", ()=> computeRisk());

      $("#btnCalcRisk")?.addEventListener("click", ()=>{ pullCase(); computeRisk(); });
      $("#btnLockVitals")?.addEventListener("click", ()=>{ pullCase(); alert("ุชู ุชุซุจูุช ุงููุฑุงุกุงุช (Demo)"); try{ window.SCAUDIT?.audit?.("VITALS_LOCKED", { id:caseObj.id }); }catch(_){}});

      $("#btnToDiagnosis")?.addEventListener("click", ()=>{ pullCase(); computeRisk(); openView("diagnosis"); });
      $("#btnBackTriage")?.addEventListener("click", ()=> openView("triage"));
      $("#btnToMedia")?.addEventListener("click", ()=> openView("media"));
      $("#btnToReport")?.addEventListener("click", ()=>{ applyDecision(); openView("report"); });
      $("#btnToReport2")?.addEventListener("click", ()=>{ buildReport(); openView("report"); });
      $("#btnToReport3")?.addEventListener("click", ()=> openView("report"));
      $("#btnBackDiag")?.addEventListener("click", ()=> openView("diagnosis"));

      $("#btnAutoPlan")?.addEventListener("click", autoPlan);
      $("#btnStamp")?.addEventListener("click", stamp);
      $("#btnApplyDecision")?.addEventListener("click", ()=>{ applyDecision(); alert("ุชู ุชุทุจูู ุงููุฑุงุฑ (Demo)"); });

      $("#btnStartCam")?.addEventListener("click", startCam);
      $("#btnStopMedia")?.addEventListener("click", stopMedia);
      $("#btnSnap")?.addEventListener("click", snap);

      $("#btnStartRec")?.addEventListener("click", startRec);
      $("#btnStopRec")?.addEventListener("click", stopRec);

      $("#btnAutoMsg")?.addEventListener("click", ()=>{
        pullCase();
        const pr = $("#priority").value || caseObj.priority;
        const base = pr==="CRIT" ? "ุญุงูุฉ ุญุฑุฌุฉ โ ููุฒู ุฅุฌุฑุงุก ุนุงุฌู."
                  : pr==="HIGH" ? "ุญุงูุฉ ุนุงููุฉ โ ูุชุงุจุนุฉ ูุทููุจุฉ."
                  : pr==="MED" ? "ุญุงูุฉ ูุชูุณุทุฉ โ ูุฑุฌู ุงููุชุงุจุนุฉ."
                  : "ุญุงูุฉ ุจุณูุทุฉ.";
        $("#notifyMsg").value = `${base} ุงูุณุจุจ: ${$("#chiefComplaint").value||"โ"}. (Demo)`;
      });

      $("#btnLogAlert")?.addEventListener("click", logAlert);
      $("#btnClearAlerts")?.addEventListener("click", ()=>{ caseObj.alerts=[]; renderAlerts(); });

      $("#btnSendNotify")?.addEventListener("click", sendNotify);

      $("#btnExportJson")?.addEventListener("click", exportJSON);
      $("#btnExportTxt")?.addEventListener("click", exportTXT);
      $("#btnExportCase")?.addEventListener("click", exportJSON);

      $("#btnQuickTriage")?.addEventListener("click", ()=>{
        if(!caseObj.id) newCase();
        fillVitalsFromEngine();
        pullCase();
        computeRisk();
        autoPlan();
        applyDecision();
        openView("diagnosis");
        $("#dotLive")?.classList.add("pulse");
        setTimeout(()=>$("#dotLive")?.classList.remove("pulse"), 900);
      });

      $("#btnSyncSensors")?.addEventListener("click", ()=> {
        fillVitalsFromEngine();
        try{ window.SCAUDIT?.audit?.("SENSORS_SYNC_CLICK", { from:"doctor" }); }catch(_){}
      });

      $("#btnNewCase")?.addEventListener("click", ()=>{
        stopMedia();
        // reset minimal UI
        Object.assign(caseObj, {
          id:null, createdAt:null, media:{photo:null,audio:null}, alerts:[], decision:"", dx:"", plan:"", clinicalNotes:"", meds:""
        });
        $("#snapImg").style.display="none";
        $("#audioPlay").style.display="none";
        $("#vTemp").textContent="โ"; $("#vHr").textContent="โ"; $("#vSpo2").textContent="โ"; $("#vBp").textContent="โ";
        $("#riskScore").textContent="18"; $("#riskBar").style.width="18%";
        $("#prioTxt").textContent="LOW"; $("#riskTxt").textContent="LOW";
        $("#decisionTxt").textContent="โ"; $("#followTxt").textContent="โ"; $("#notifyTxt").textContent="โ";
        renderAlerts();
        newCase();
        openView("triage");
      });

      $("#btnFinalize")?.addEventListener("click", ()=>{
        pullCase();
        buildReport();
        try{ window.SCAUDIT?.audit?.("REPORT_FINALIZED", { id:caseObj.id, priority:caseObj.priority, decision:caseObj.decision }); }catch(_){}
        alert("ุชู ุงุนุชูุงุฏ ุงูุชูุฑูุฑ (Demo) โ");
      });

      // Init
      newCase();
      renderAlerts();
      buildReport();

      // Safety: stop media on leaving
      window.addEventListener("beforeunload", ()=>{ try{ stopMedia(); }catch(_){ }});
    })();
  </script>

</body>
</html>
window.addEventListener("sc:bus:update", ()=>{
  // ููุง ุชูุงุฏู ุฏูุงู ุงูุชุญุฏูุซ ุนูุฏู
  // ูุซุงู:
  // renderAlertsFromBus();
  // renderCasesFromBus();
});
document.getElementById("btnGoReport")?.addEventListener("click", (e)=>{
  // ูู ูุง ุนูุฏู BUS ูุง ุชุณูู ุดู (ุจููุชุญ report.html ุจุงููุถุน ุงูุงูุชุฑุงุถู)
  const bus = window.SCBUS?.load?.();
  const latest = bus?.cases?.[0];

  if(latest?.id){
    e.preventDefault();
    // ุงูุชุญ ุงูุชูุฑูุฑ ุนูู ููุณ ุงูุญุงูุฉ ูุจุงุดุฑุฉ
    location.href = `report.html#case=${encodeURIComponent(latest.id)}`;
    try{ window.SCBUS?.audit?.("OPEN_REPORT_FROM_DOCTOR", { caseId: latest.id }); }catch(_){}
  }
});
