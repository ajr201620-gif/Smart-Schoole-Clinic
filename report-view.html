<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Smart Clinic OS â€” ØªÙ‚Ø±ÙŠØ± Ø±Ø³Ù…ÙŠ</title>

  <script src="js/bus.js"></script>
  <script src="js/permission-slip.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#f6f7fb;color:#111;margin:0;padding:20px}
    .paper{max-width:920px;margin:0 auto;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .brand{font-weight:900;font-size:18px}
    .sub{color:#6b7280;font-size:12px;margin-top:4px}
    .tag{font-size:12px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fafafa}
    h2{margin:18px 0 10px;font-size:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fff}
    .row{display:flex;gap:10px;padding:6px 0;border-bottom:1px dashed #eef0f4}
    .row:last-child{border-bottom:none}
    .k{min-width:140px;color:#6b7280;font-size:12px}
    .v{flex:1;font-size:12px;font-weight:650}
    pre{white-space:pre-wrap;font-size:12px;margin:0;color:#111}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{cursor:pointer;border-radius:12px;padding:10px 12px;border:1px solid #e5e7eb;background:#111;color:#fff;font-weight:800}
    .btn.ghost{background:#fff;color:#111}
    .muted{color:#6b7280;font-size:12px}
    @media print{body{background:#fff;padding:0}.paper{border:none;border-radius:0}.actions{display:none}}
  </style>
</head>

<body>
<div class="paper">
  <div class="top">
    <div>
      <div class="brand">Smart Clinic OS â€” ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø©/Ø­Ø§Ù„Ø©</div>
      <div class="sub" id="meta">â€”</div>
    </div>
    <div class="tag" id="tag">Status: â€”</div>
  </div>

  <div class="actions">
    <button class="btn ghost" id="btnBack">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
    <button class="btn ghost" id="btnPrint">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <button class="btn ghost" id="btnCopy">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>

    <button class="btn" id="btnConsentYes" style="display:none">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
    <button class="btn ghost" id="btnConsentNo" style="display:none">â›” Ø±ÙØ¶</button>
  </div>

  <div class="muted" id="notice" style="margin-top:6px"></div>

  <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©</h2>
  <div class="card" id="caseBox"></div>

  <h2>Ø§Ù„Ø´ÙƒÙˆÙ‰</h2>
  <div class="card"><pre id="complaint">â€”</pre></div>

  <h2>Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©</h2>
  <div class="grid">
    <div class="card" id="vitalsBox"></div>
    <div class="card" id="aiBox"></div>
  </div>

  <h2>ØªØ´Ø®ÙŠØµ Ø§Ù„Ø·Ø¨ÙŠØ¨</h2>
  <div class="card"><pre id="dx">â€”</pre></div>

  <h2>Ø§Ù„Ø®Ø·Ø©</h2>
  <div class="card"><pre id="plan">â€”</pre></div>

  <h2>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h2>
  <div class="card"><pre id="notes">â€”</pre></div>

  <div class="muted" style="margin-top:14px">
    Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ù†Ù…ÙˆØ°Ø¬ Ø¹Ø±Ø¶ (Demo) ÙˆÙ„ÙŠØ³ Ø¨Ø¯ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø±ÙŠØ±ÙŠ.
  </div>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const qs = new URLSearchParams(location.search);
const caseId = qs.get("case") || "";
const role = (qs.get("role") || localStorage.getItem("SC_ROLE") || "parent").toLowerCase();
const autoPrint = qs.get("autoprint")==="1";

function esc(x){ return String(x??"").replace(/[&<>"]/g,(m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m])); }
function line(k,v){ return `<div class="row"><div class="k">${esc(k)}</div><div class="v">${esc(v)}</div></div>`; }

function getCase(){
  const bus = window.SCBUS?.load?.() || {cases:[]};
  return (bus.cases||[]).find(c=>String(c.id)===String(caseId)) || null;
}
function patchCase(patch){
  const bus = window.SCBUS.load();
  const idx = (bus.cases||[]).findIndex(c=>String(c.id)===String(caseId));
  if(idx<0) return null;
  bus.cases[idx] = Object.assign({}, bus.cases[idx], patch);
  window.SCBUS.save(bus);
  return bus.cases[idx];
}

function buildText(c){
  const v=c.vitals||{}, ai=c.ai||{};
  return [
    "Smart Clinic OS â€” ØªÙ‚Ø±ÙŠØ±",
    "â€”".repeat(40),
    `Case: ${c.id}`,
    `Status: ${c.status||"â€”"}`,
    `Priority: ${c.priority||ai.priority||"â€”"} | Risk: ${(c.riskScore??ai.risk??"â€”")}/100`,
    "",
    "Ø§Ù„Ø´ÙƒÙˆÙ‰:",
    (c.requestDesc||c.desc||c.complaint||"â€”"),
    "",
    "Vitals:",
    `Temp: ${v.temp??"â€”"}  HR: ${v.hr??"â€”"}  SpO2: ${v.spo2??"â€”"}  BP: ${v.bp??"â€”"}`,
    "",
    "Dx:",
    (c.dx||"â€”"),
    "",
    "Plan:",
    (c.plan||"â€”"),
    "",
    "Visit Notes:",
    (c.visit?.notes||"â€”"),
    "â€”".repeat(40)
  ].join("\n");
}

function render(){
  const c = getCase();
  if(!c){
    $("#notice").textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ù‚Ù… case ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.";
    return;
  }
  const ai = c.ai||{};
  const v = c.vitals||{};
  $("#meta").textContent = `Case ${c.id} â€¢ Role: ${role} â€¢ Generated: ${new Date().toLocaleString("ar-SA")}`;
  $("#tag").textContent = `Status: ${c.status||"â€”"}`;

  $("#caseBox").innerHTML = [
    line("Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„Ø©", c.id),
    line("Priority", c.priority||ai.priority||"â€”"),
    line("Risk", (c.riskScore??ai.risk??"â€”") + "/100"),
    line("Ø§Ù„Ù‚Ø±Ø§Ø±", c.decision||ai.recommendation||"â€”"),
    line("Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±", c.consent || "â€”")
  ].join("");

  $("#complaint").textContent = c.requestDesc||c.desc||c.complaint||"â€”";
  $("#vitalsBox").innerHTML = [
    line("Temp", v.temp ? v.temp+"Â°C" : "â€”"),
    line("HR", v.hr ? v.hr+" bpm" : "â€”"),
    line("SpOâ‚‚", v.spo2 ? v.spo2+"%" : "â€”"),
    line("BP", v.bp || "â€”")
  ].join("");

  $("#aiBox").innerHTML = [
    line("AI Recommendation", ai.recommendation || "â€”"),
    line("Flags", (ai.flags||[]).join(", ") || "â€”")
  ].join("");

  $("#dx").textContent = c.dx || "â€”";
  $("#plan").textContent = c.plan || "â€”";
  $("#notes").textContent = c.visit?.notes || "â€”";

  const needConsent = (c.status === "CONSENT_REQUIRED");
  const isParent = (role === "parent");
  $("#btnConsentYes").style.display = (needConsent && isParent) ? "" : "none";
  $("#btnConsentNo").style.display  = (needConsent && isParent) ? "" : "none";

  $("#notice").textContent = (needConsent && isParent)
    ? "Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© ØªØªØ·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚ØªÙƒ. Ø§Ø®ØªØ± Ù…ÙˆØ§ÙÙ‚Ø©/Ø±ÙØ¶ ÙˆØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙˆØ±Ù‹Ø§ØŒ ÙˆØ¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù†Ø¯ Ø±Ø³Ù…ÙŠ."
    : "";
}

$("#btnBack").addEventListener("click", ()=>{
  location.href = role==="doctor" ? "doctor.html" : role==="admin" ? "admin.html" : role==="student" ? "student.html" : "parent.html";
});
$("#btnPrint").addEventListener("click", ()=> window.print());
$("#btnCopy").addEventListener("click", async ()=>{
  const c = getCase();
  if(!c) return;
  const txt = buildText(c);
  try{ await navigator.clipboard.writeText(txt); alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…"); }
  catch(_){ alert("Ù…Ø§Ù‚Ø¯Ø±Øª Ø£Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ Ø§Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§."); }
});

$("#btnConsentYes").addEventListener("click", ()=>{
  const c = getCase();
  if(!c) return;

  // ØªÙˆÙ‚ÙŠØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Demo)
  const guardianName = prompt("Ø§ÙƒØªØ¨ Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù„Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:","") || "";
  const guardianPhone = prompt("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ø¹Ø±Ø¶):","") || "";
  const ok = confirm("ØªØ£ÙƒÙŠØ¯: Ø£ÙˆØ§ÙÙ‚ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø·Ø©/Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø°ÙƒÙˆØ± ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.");
  if(!ok) return;

  patchCase({
    consent:"APPROVED",
    status:"APPROVED_BY_PARENT",
    guardianSig: { name: guardianName.trim()||"ÙˆÙ„ÙŠ Ø£Ù…Ø± (Demo)", phone: guardianPhone.trim()||"â€”", at: new Date().toISOString() }
  });

  // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù†Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ø±Ø³Ù…ÙŠ + ÙØªØ­Ù‡
  const slip = window.SCSLIP?.createSlip(c.id, "Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø¥Ø¬Ø±Ø§Ø¡/Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬", {
    guardianName: guardianName.trim()||"ÙˆÙ„ÙŠ Ø£Ù…Ø± (Demo)",
    guardianPhone: guardianPhone.trim()||"â€”",
    signedAt: new Date().toISOString()
  });
  if(slip) window.SCSLIP.openSlip(slip);

  alert("ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© âœ… ÙˆØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù†Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ø±Ø³Ù…ÙŠ");
  render();
});

$("#btnConsentNo").addEventListener("click", ()=>{
  const c = getCase();
  if(!c) return;

  const fallbackPlan =
`Ø®Ø·Ø© Ø¨Ø¯ÙŠÙ„Ø© (Ø¨Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©):
â€¢ Ù…ØªØ§Ø¨Ø¹Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
â€¢ Ø±Ø§Ø­Ø© + Ø³ÙˆØ§Ø¦Ù„ + Ø¥Ø±Ø´Ø§Ø¯ ØµØ­ÙŠ
â€¢ Ø¥Ø¹Ø§Ø¯Ø© Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø¹Ø¯ 30â€“60 Ø¯Ù‚ÙŠÙ‚Ø© Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶
â€¢ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ø¥Ø°Ø§ Ø³Ø§Ø¡Øª Ø§Ù„Ø­Ø§Ù„Ø©`;

  patchCase({
    consent:"REJECTED",
    status:"FOLLOW_UP",
    plan: fallbackPlan
  });

  try{ window.SCBUS.pushAlert("admin","MED","Ø±ÙØ¶ Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±","ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø©", { caseId: c.id }); }catch(_){}

  alert("ØªÙ… Ø§Ù„Ø±ÙØ¶ â›” ÙˆØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø®Ø·Ø© Ø¨Ø¯ÙŠÙ„Ø©");
  render();
});

render();
if(autoPrint) setTimeout(()=>window.print(), 500);
</script>
</body>
</html>
