<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark" data-ui="pro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุจูุงุจุฉ ุงูุทุงูุจ โ ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</title>

  <!-- existing -->
 <link rel="stylesheet" href="app.css" />
<link rel="stylesheet" href="ui.css" />
</head>

<body data-page="student">
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar__left">
      <a class="btn ghost sm" href="index.html">โฉ๏ธ ุงูุฑุฆูุณูุฉ</a>

      <div class="brand mini">
        <div class="brand__logo">๐ฉบ</div>
        <div class="brand__txt">
          <div class="brand__name">ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</div>
          <div class="brand__sub">ุจูุงุจุฉ ุงูุทุงูุจ โข ูุฑุฒ ุฐูู โข ููุงุณุงุช โข ุฒูุงุฑุฉ</div>
        </div>
      </div>
    </div>

    <div class="topbar__right">
      <span class="pill">
        <span class="dot ok"></span>
        <span>ูุฑุญุจูุงุ <b data-user-name>ุทุงูุจ</b></span>
      </span>

      <!-- UI mode toggle (PRO/CLEAN/NEO) -->
      <button class="btn ghost sm" data-ui-toggle>PRO</button>

      <button class="btn ghost sm" id="btnTheme" data-action="common:theme-toggle">๐</button>
      <button class="btn danger sm" id="btnLogout" data-action="common:logout">ุฎุฑูุฌ</button>
    </div>
  </header>

  <main class="shell shell--wide">
    <!-- HERO -->
    <section class="hero">
      <div class="hero__left">
        <h1 class="hero__title">ูุญุต ุฐูู ุณุฑูุน โ ุจุฏูู ุชูุชุฑ</h1>
        <p class="hero__lead">
          ุงูุชุจ ุงูุดููู โ ุดุบูู ุงูููุงุณุงุช โ ุดุบูู ุงููุฑุฒ ุงูุฐูู โ ุฅุฐุง ุงุญุชุฌุช: ุฒูุงุฑุฉ ุงูุชุฑุงุถูุฉ ูุน ุงูุทุจูุจ.
        </p>

        <div class="hero__actions">
          <span class="badge ok"><span class="dot ok"></span> ุงููุธุงู ุฌุงูุฒ</span>
          <span class="badge"><span class="dot ok"></span> Firestore: <b id="fbState">โ</b></span>
          <span class="badge">ุงูุฏูุฑ: <b data-user-role>student</b></span>
        </div>
      </div>

      <div class="hero__right">
        <div class="card">
          <div class="card__head">
            <h2 class="card__title">ุงูุฅุฌุฑุงุก ุงูุชุงูู</h2>
          </div>
          <div class="card__body">
            <div class="row">
              <span class="muted">ุงููุทููุจ ุงูุขู:</span>
              <b id="nextStepTxt">ุงูุชุจ ุงูุดููู ๐</b>
            </div>
            <div class="row" style="margin-top:10px">
              <span class="muted">ุขุฎุฑ ุชุญุฏูุซ:</span>
              <span id="lastUpdateTxt">โ</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- MAIN WORKSPACE (ONE CARD ONLY) -->
    <section class="card">
      <div class="card__head">
        <h2 class="card__title">ููุญุฉ ุงููุญุต</h2>

        <!-- Quick actions (ูุงุถุญุฉ ููุจุงุดุฑุฉ) -->
        <div class="card__tools">
          <button class="btn sm" data-action="btnCreateCase">๐งพ ุฅูุดุงุก ุญุงูุฉ</button>
          <button class="btn sm" data-action="student:run-sensors">๐ ููุงุณุงุช</button>
          <button class="btn primary sm" data-action="student:submit-ai">๐ค ูุฑุฒ</button>
          <button class="btn sm" data-action="student:start-visit">๐ฅ ุฒูุงุฑุฉ</button>
          <button class="btn ghost sm" data-action="btnMyReport">โฌ๏ธ ุชูุฑูุฑ</button>
        </div>
      </div>

      <div class="card__body">
        <div class="grid2">
          <!-- LEFT: Symptoms -->
          <section>
            <div class="field__label">๐ ุงูุดููู / ุงูุฃุนุฑุงุถ</div>
            <textarea id="symptoms" class="input" rows="10"
              placeholder="ูุซุงู: ุตุฏุงุน + ุญุฑุงุฑุฉ + ุณุนุงู + ุฃูู ุญููโฆ"></textarea>

            <div style="margin-top:10px" class="row" >
              <button class="btn ghost" data-action="student:save-symptoms">ุญูุธ</button>
              <span class="muted" style="font-size:13px">* ุงูุชุจูุง ุจูุถูุญ ุนุดุงู ุงููุฑุฒ ูููู ุฃุฏู</span>
            </div>

            <div class="divider"></div>

            <div class="stack">
              <button class="btn" id="btnRunSensors" data-action="student:run-sensors">๐ ุชุดุบูู ุงูููุงุณุงุช (ูุญุงูุงุฉ)</button>
              <button class="btn primary" id="btnSubmitAI" data-action="student:submit-ai">๐ค ุชุดุบูู ุงููุฑุฒ ุงูุฐูู</button>
              <button class="btn" id="btnStartVisit" data-action="student:start-visit">๐ฅ ุจุฏุก ุฒูุงุฑุฉ ุงูุชุฑุงุถูุฉ</button>
            </div>
          </section>

          <!-- RIGHT: Results -->
          <section>
            <div class="field__label">๐ ุงูููุงุณุงุช ูุงููุชูุฌุฉ</div>

            <div class="tableWrap" style="border-radius:14px">
              <table class="table" style="min-width:auto">
                <thead>
                  <tr>
                    <th>ุงููุคุดุฑ</th>
                    <th>ุงููููุฉ</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td>ูุจุถ ุงูููุจ</td><td id="v_hr">โ</td></tr>
                  <tr><td>ุงูุฃูุณุฌูู</td><td id="v_spo2">โ</td></tr>
                  <tr><td>ุงูุญุฑุงุฑุฉ</td><td id="v_temp">โ</td></tr>
                  <tr><td>ุงูุถุบุท</td><td id="v_bp">โ</td></tr>
                </tbody>
              </table>
            </div>

            <div class="divider"></div>

            <div class="grid2">
              <div class="card" style="box-shadow:none">
                <div class="card__head"><h3 class="card__title" style="font-size:14px">ุงูุญุงูุฉ</h3></div>
                <div class="card__body"><b id="v_status">โ</b></div>
              </div>
              <div class="card" style="box-shadow:none">
                <div class="card__head"><h3 class="card__title" style="font-size:14px">ุงูุฃููููุฉ</h3></div>
                <div class="card__body"><b id="v_priority">โ</b></div>
              </div>
              <div class="card" style="box-shadow:none">
                <div class="card__head"><h3 class="card__title" style="font-size:14px">ุงููุฎุงุทุฑ</h3></div>
                <div class="card__body"><b id="v_risk">โ</b></div>
              </div>
              <div class="card" style="box-shadow:none">
                <div class="card__head"><h3 class="card__title" style="font-size:14px">ูุฑุงุฑ AI</h3></div>
                <div class="card__body"><b id="v_decision">โ</b></div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="card" style="box-shadow:none">
              <div class="card__head">
                <h3 class="card__title" style="font-size:14px">๐ ุงูุชูุจููุงุช</h3>
              </div>
              <div class="card__body">
                <div id="notifyList" class="list">
                  <div class="empty muted">ูุง ููุฌุฏ ุชูุจููุงุช ุญุงููุงู.</div>
                </div>
              </div>
            </div>

          </section>
        </div>
      </div>
    </section>

  </main>

  <!-- Core scripts -->
  <script src="./bus.js"></script>
  <script src="./auth.js"></script>
  <script src="./triage-ai.js"></script>
  <script src="./sensor-sim.js"></script>
  <script src="./student-notify.js"></script>

  <!-- UI mode switcher -->
  <script src="./ui.js"></script>

  <!-- Firebase (ONE TIME) -->
  <script type="module" src="./firebase-init.js"></script>

  <!-- Actions (ONE TIME) -->
  <script src="./actions.js"></script>

  <!-- Binder: ูุนุฑุถ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ุนูุฏู ุงูุขู ูู SSC.db (ูุฅุฐุง ูุงุญููุง ุฑุจุทุชูุง ูู Firestore ูุง ูุชุนุงุฑุถ) -->
  <script>
    (function(){
      "use strict";
      const $=(s,r=document)=>r.querySelector(s);
      const escapeHtml=(s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

      async function showFB(){
        const el=$("#fbState");
        let tries=0;
        while(!window.FB && tries++<40) await new Promise(r=>setTimeout(r,50));
        el.textContent = window.FB ? "ูุชุตู" : "ุบูุฑ ุฌุงูุฒ";
      }

      function renderVitals(){
        const db = window.SSC && window.SSC.db;
        if(!db) return;

        const userId = db.session?.currentUserId;
        const c = db.cases?.find(x=>x.owner?.id===userId) || db.cases?.[0];
        if(!c){
          $("#nextStepTxt").textContent="ุงูุชุจ ุงูุดููู ๐";
          return;
        }

        $("#v_hr").textContent = c.vitals?.hr ?? "โ";
        $("#v_spo2").textContent = c.vitals?.spo2 ?? "โ";
        $("#v_temp").textContent = c.vitals?.temp ?? "โ";
        $("#v_bp").textContent = c.vitals?.bp ?? "โ";

        $("#v_status").textContent = c.status ?? "โ";
        $("#v_priority").textContent = c.priority ?? "โ";
        $("#v_risk").textContent = c.risk ?? "โ";
        $("#v_decision").textContent = c.decision ?? "โ";

        const hasSymptoms = !!(c.symptoms && String(c.symptoms).trim());
        const hasVitals = !!(c.vitals && (c.vitals.hr || c.vitals.spo2 || c.vitals.temp || c.vitals.bp));
        const hasAI = !!(c.decision || c.priority || c.risk);

        $("#nextStepTxt").textContent =
          !hasSymptoms ? "ุงูุชุจ ุงูุดููู ุซู ุงุญูุธ" :
          !hasVitals ? "ุดุบูู ุงูููุงุณุงุช" :
          !hasAI ? "ุดุบูู ุงููุฑุฒ ุงูุฐูู" :
          "ุงุจุฏุฃ ุฒูุงุฑุฉ ุฅุฐุง ุงุญุชุฌุช โ";

        $("#lastUpdateTxt").textContent = c.updatedAt || c.createdAt || "โ";
      }

      function renderNotifications(){
        const db = window.SSC && window.SSC.db;
        const box = $("#notifyList");
        if(!db || !box) return;

        const items = (db.notifications||[]).filter(n=>n.toRole==="student").slice(0,6);
        if(!items.length){
          box.innerHTML = `<div class="empty muted">ูุง ููุฌุฏ ุชูุจููุงุช ุญุงููุงู.</div>`;
          return;
        }
        box.innerHTML = items.map(n=>`
          <div class="rowCard">
            <div class="rowTitle">${escapeHtml(n.title)}</div>
            <div class="rowMeta">${escapeHtml(n.message)} โข <span class="muted">${escapeHtml(n.at)}</span></div>
          </div>
        `).join("");
      }

      document.addEventListener("DOMContentLoaded", async()=>{
        await showFB();
        renderVitals();
        renderNotifications();
        window.bus?.on?.("case:update", renderVitals);
        window.bus?.on?.("notify:update", renderNotifications);
      });
    })();
  </script>
</body>
</html>
