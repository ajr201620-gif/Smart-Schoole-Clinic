<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุจูุงุจุฉ ุงูุทุงูุจ โ ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</title>
  <link rel="stylesheet" href="app.css" />
</head>

<body data-page="student">
  <!-- Topbar (Slim) -->
  <header class="topbar topbar--slim">
    <div class="topbar__left">
      <a class="btn ghost sm" href="index.html">โฉ๏ธ ุงูุฑุฆูุณูุฉ</a>

      <div class="brand mini">
        <div class="brand__logo">๐ฉบ</div>
        <div class="brand__txt">
          <div class="brand__name">ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</div>
          <div class="brand__sub">ุจูุงุจุฉ ุงูุทุงูุจ โข ูุฑุฒ ุฐูู โข ููุงุณุงุช โข ุฒูุงุฑุฉ</div>
        </div>
      </div>
    </div>

    <div class="topbar__right">
      <div class="pill pill--soft">
        <span class="dot ok"></span>
        <span>ูุฑุญุจูุงุ <b data-user-name>ุทุงูุจ</b></span>
      </div>

      <button class="btn ghost sm" id="btnTheme" data-action="common:theme-toggle">๐</button>
      <button class="btn danger sm" id="btnLogoutTop" data-action="common:logout">ุฎุฑูุฌ</button>
    </div>
  </header>

  <main class="shell shell--wide">
    <!-- Hero (Clean) -->
    <section class="hero hero--compact">
      <div class="hero__left">
        <h1 class="hero__title">ุฌุงูุฒ ููุญุตูโฆ ุจุฏูู ูุง ูุฎููู ๐</h1>
        <p class="hero__lead">
          ุงูุชุจ ุงูุดููู โ ุดุบูู ุงูููุงุณุงุช โ ุดุบูู ุงููุฑุฒ ุงูุฐูู โ ุซู ุงุจุฏุฃ ุฒูุงุฑุฉ.
        </p>

        <div class="hero__cta">
          <button class="btn primary lg" id="btnPrimaryFlow" data-action="student:primary-flow">
            ๐ง ุงุจุฏุฃ ุงููุญุต ุงูุฐูู
          </button>

          <div class="hero__mini">
            <span class="chip" id="chipStatus"><span class="dot ok"></span> ุงููุธุงู ุฌุงูุฒ</span>
            <span class="chip"><span class="dot ok"></span> Firebase/Firestore: <b id="fbState">โ</b></span>
            <span class="chip">ุงูุฏูุฑ: <b data-user-role>student</b></span>
          </div>
        </div>
      </div>

      <div class="hero__right">
        <div class="glassCard glassCard--tight">
          <div class="glassCard__title">ููุฎุต ุณุฑูุน</div>
          <div class="glassCard__body">
            <div class="row">
              <span class="muted">ุงูุฎุทูุฉ ุงูุชุงููุฉ:</span>
              <span id="nextStepTxt">ุงุจุฏุฃ ุจูุชุงุจุฉ ุงูุดููู ๐</span>
            </div>
            <div class="row">
              <span class="muted">ุขุฎุฑ ุชุญุฏูุซ:</span>
              <span id="lastUpdateTxt">โ</span>
            </div>
          </div>
        </div>

        <div class="quickBar">
          <button class="qbtn" id="qbCreateCase" data-action="btnCreateCase">๐งพ ุญุงูุฉ</button>
          <button class="qbtn" id="qbSensors" data-action="student:run-sensors">๐ ููุงุณุงุช</button>
          <button class="qbtn qbtn--primary" id="qbAI" data-action="student:submit-ai">๐ค ูุฑุฒ</button>
          <button class="qbtn" id="qbVisit" data-action="student:start-visit">๐ฅ ุฒูุงุฑุฉ</button>
          <button class="qbtn" id="qbReport" data-action="btnMyReport">โฌ๏ธ ุชูุฑูุฑ</button>
        </div>
      </div>
    </section>

    <!-- Layout 3 Columns -->
    <section class="triLayout">
      <!-- Left: Steps -->
      <aside class="card card--soft">
        <header class="card__head">
          <h2 class="card__title">๐งญ ุฎุทูุงุชู</h2>
        </header>
        <div class="card__body">
          <ol class="steps">
            <li class="step" id="st1"><span class="step__dot"></span><span>ุงูุชุจ ุงูุดููู</span></li>
            <li class="step" id="st2"><span class="step__dot"></span><span>ุดุบูู ุงูููุงุณุงุช</span></li>
            <li class="step" id="st3"><span class="step__dot"></span><span>ุดุบูู ุงููุฑุฒ ุงูุฐูู</span></li>
            <li class="step" id="st4"><span class="step__dot"></span><span>ุงุจุฏุฃ ุฒูุงุฑุฉ</span></li>
          </ol>

          <div class="divider"></div>

          <div class="stack">
            <a class="btn ghost" href="visit.html">ูุชุญ ุตูุญุฉ ุงูุฒูุงุฑุฉ</a>
            <a class="btn ghost" href="parent.html">ุจูุงุจุฉ ููู ุงูุฃูุฑ</a>
          </div>
        </div>
      </aside>

      <!-- Center: Complaint + Actions -->
      <section class="card card--focus">
        <header class="card__head">
          <h2 class="card__title">๐ ุงูุดููู / ุงูุฃุนุฑุงุถ</h2>
          <div class="card__tools">
            <button class="btn ghost sm" data-action="student:save-symptoms">ุญูุธ</button>
          </div>
        </header>

        <div class="card__body">
          <label class="field">
            <div class="field__label">ูุด ุชุญุณ ูููุ (ุงูุชุจูุง ุจูุถูุญ)</div>
            <textarea id="symptoms" class="input input--xl" rows="6"
              placeholder="ูุซุงู: ุตุฏุงุน + ุญุฑุงุฑุฉ + ุณุนุงู + ุฃูู ุญููโฆ"></textarea>
          </label>

          <div class="rowActions rowActions--split">
            <button class="btn" id="btnRunSensors" data-action="student:run-sensors">๐ ุชุดุบูู ุงูููุงุณุงุช</button>
            <button class="btn primary" id="btnSubmitAI" data-action="student:submit-ai">๐ค ุชุดุบูู ุงููุฑุฒ ุงูุฐูู</button>
          </div>

          <div class="hint">
            โ ุงูููุงุณุงุช ููุง ูุญุงูุงุฉ (Demo). ูุงุญููุง ูุฑุจุท IoT ุงูุญูููู.
          </div>
        </div>
      </section>

      <!-- Right: Results -->
      <aside class="card card--soft">
        <header class="card__head">
          <h2 class="card__title">๐ ุงููุชูุฌุฉ ูุงูููุงุณุงุช</h2>
          <div class="card__tools">
            <span class="pill"><span class="dot warn"></span> Demo</span>
          </div>
        </header>

        <div class="card__body">
          <div class="vitals vitals--mini">
            <div class="vital">
              <div class="vital__label">ูุจุถ</div>
              <div class="vital__value" id="v_hr">โ</div>
              <div class="vital__unit">BPM</div>
            </div>
            <div class="vital">
              <div class="vital__label">Oโ</div>
              <div class="vital__value" id="v_spo2">โ</div>
              <div class="vital__unit">%</div>
            </div>
            <div class="vital">
              <div class="vital__label">ุญุฑุงุฑุฉ</div>
              <div class="vital__value" id="v_temp">โ</div>
              <div class="vital__unit">ยฐC</div>
            </div>
            <div class="vital">
              <div class="vital__label">ุถุบุท</div>
              <div class="vital__value" id="v_bp">โ</div>
              <div class="vital__unit">mmHg</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="miniCards miniCards--2">
            <div class="miniCard">
              <div class="miniCard__label">ุงูุญุงูุฉ</div>
              <div class="miniCard__value" id="v_status">โ</div>
            </div>
            <div class="miniCard">
              <div class="miniCard__label">ุงูุฃููููุฉ</div>
              <div class="miniCard__value" id="v_priority">โ</div>
            </div>
            <div class="miniCard">
              <div class="miniCard__label">ุงููุฎุงุทุฑ</div>
              <div class="miniCard__value" id="v_risk">โ</div>
            </div>
            <div class="miniCard">
              <div class="miniCard__label">ูุฑุงุฑ AI</div>
              <div class="miniCard__value" id="v_decision">โ</div>
            </div>
          </div>

          <div class="divider"></div>

          <section class="noticeBox">
            <div class="noticeBox__title">๐ ุงูุชูุจููุงุช</div>
            <div id="notifyList" class="list">
              <div class="empty muted">ูุง ููุฌุฏ ุชูุจููุงุช ุญุงููุงู.</div>
            </div>
          </section>

          <div class="divider"></div>

          <button class="btn danger" id="btnLogoutBottom" data-action="common:logout">ุฎุฑูุฌ</button>
        </div>
      </aside>
    </section>
  </main>

  <!-- Scripts (order matters) -->
  <script src="./bus.js"></script>
  <script src="./auth.js"></script>
  <script src="./triage-ai.js"></script>
  <script src="./sensor-sim.js"></script>
  <script src="./student-notify.js"></script>

  <!-- Firebase init (ONE TIME ONLY) -->
  <script type="module" src="./firebase-init.js"></script>

  <!-- Actions wiring (ONE TIME ONLY) -->
  <script src="./actions.js"></script>

  <!-- Small UI binder -->
  <script>
    (function(){
      "use strict";
      function $(s,r=document){return r.querySelector(s);}
      function escapeHtml(s){return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));}

      function setStep(n){
        ["st1","st2","st3","st4"].forEach((id,i)=>{
          const el = $("#"+id);
          if(!el) return;
          el.classList.toggle("is-done", i < n-1);
          el.classList.toggle("is-active", i === n-1);
        });
      }

      function renderVitals() {
        const db = window.SSC && window.SSC.db;
        if (!db) return;

        const userId = db.session?.currentUserId;
        const c = db.cases?.find(x => x.owner?.id === userId) || db.cases?.[0];
        if (!c) {
          setStep(1);
          $("#nextStepTxt").textContent = "ุงุจุฏุฃ ุจูุชุงุจุฉ ุงูุดููู ๐";
          return;
        }

        $("#v_hr").textContent = c.vitals?.hr ?? "โ";
        $("#v_spo2").textContent = c.vitals?.spo2 ?? "โ";
        $("#v_temp").textContent = c.vitals?.temp ?? "โ";
        $("#v_bp").textContent = c.vitals?.bp ?? "โ";

        $("#v_status").textContent = c.status ?? "โ";
        $("#v_priority").textContent = c.priority ?? "โ";
        $("#v_risk").textContent = c.risk ?? "โ";
        $("#v_decision").textContent = c.decision ?? "โ";

        const hasSymptoms = !!(c.symptoms && String(c.symptoms).trim().length);
        const hasVitals = !!(c.vitals && (c.vitals.hr || c.vitals.spo2 || c.vitals.temp || c.vitals.bp));
        const hasAI = !!(c.decision || c.priority || c.risk);

        const step = !hasSymptoms ? 1 : (!hasVitals ? 2 : (!hasAI ? 3 : 4));
        setStep(step);

        const nextTxt = step===1 ? "ุงูุชุจ ุงูุดููู ุซู ุงุญูุธ" :
                        step===2 ? "ุดุบูู ุงูููุงุณุงุช" :
                        step===3 ? "ุดุบูู ุงููุฑุฒ ุงูุฐูู" :
                                  "ุงุจุฏุฃ ุฒูุงุฑุฉ ุงูุขู โ";
        $("#nextStepTxt").textContent = nextTxt;

        $("#lastUpdateTxt").textContent = c.updatedAt || c.createdAt || "โ";
      }

      function renderNotifications() {
        const db = window.SSC && window.SSC.db;
        const box = $("#notifyList");
        if (!db || !box) return;

        const role = "student";
        const items = (db.notifications||[]).filter(n => n.toRole === role).slice(0,8);

        if (!items.length) {
          box.innerHTML = `<div class="empty muted">ูุง ููุฌุฏ ุชูุจููุงุช ุญุงููุงู.</div>`;
          return;
        }

        box.innerHTML = items.map(n => `
          <div class="rowCard">
            <div class="rowTitle">${escapeHtml(n.title)}</div>
            <div class="rowMeta">${escapeHtml(n.message)} โข <span class="muted">${escapeHtml(n.at)}</span></div>
          </div>
        `).join("");
      }

      // Primary flow button
      function wirePrimary(){
        const b = $("#btnPrimaryFlow");
        if(!b) return;
        b.addEventListener("click", () => {
          // 1) focus symptoms
          const t = $("#symptoms");
          if (t) { t.scrollIntoView({behavior:"smooth", block:"center"}); t.focus(); }
        });
      }

      // Firebase state badge
      async function showFB(){
        const el = $("#fbState");
        if(!el) return;
        try{
          // wait a moment for module to load
          let tries=0;
          while(!window.FB && tries++<40) await new Promise(r=>setTimeout(r,50));
          el.textContent = window.FB ? "ูุชุตู" : "ุบูุฑ ุฌุงูุฒ";
        }catch(_){
          el.textContent = "ุบูุฑ ุฌุงูุฒ";
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        wirePrimary();
        renderVitals();
        renderNotifications();
        showFB();

        window.bus?.on?.("case:update", () => renderVitals());
        window.bus?.on?.("notify:update", () => renderNotifications());
      });
    })();
  </script>
</body>
</html>
