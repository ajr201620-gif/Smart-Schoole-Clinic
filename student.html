<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุจูุงุจุฉ ุงูุทุงูุจ โ ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</title>
  <link rel="stylesheet" href="app.css" />
</head>

<body data-page="student">

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar__left">
      <a class="btn ghost" href="index.html">โฉ๏ธ ุงูุฑุฆูุณูุฉ</a>

      <div class="brand mini">
        <div class="brand__logo">๐ฉบ</div>
        <div class="brand__txt">
          <div class="brand__name">ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</div>
          <div class="brand__sub">ุจูุงุจุฉ ุงูุทุงูุจ โข ูุฑุฒ ุฐูู โข ููุงุณุงุช โข ุฒูุงุฑุฉ</div>
        </div>
      </div>
    </div>

    <div class="topbar__right">
      <div class="pill">
        <span>ูุฑุญุจูุงุ <b data-user-name>ุทุงูุจ</b></span>
      </div>

      <button class="btn ghost" id="btnTheme">๐ ุงููุธูุฑ</button>
      <button class="btn danger" id="btnLogout" data-action="btnLogout">ุฎุฑูุฌ</button>
    </div>
  </header>

  <!-- Main -->
  <main class="shell">
    <!-- Hero -->
    <section class="hero">
      <div class="hero__left">
        <h1 class="hero__title">ุฌุงูุฒ ููุญุตูโฆ ุจุฏูู ูุง ูุฎููู ๐</h1>
        <p class="hero__lead">
          ุงูุชุจ ุดููุงูุ ุดุบูู ุงูููุงุณุงุชุ ุซู ูููุฐ ุงููุฑุฒ ุงูุฐูู. ุงูุขู ูุฑุจูุท ุจู Firebase/Firestore โ
        </p>

        <div class="hero__actions">
          <button class="btn primary" id="btnTriage" data-action="btnTriage">๐ค ุชุดุบูู ุงููุฑุฒ ุงูุฐูู</button>
          <button class="btn" id="btnCreateCase" data-action="btnCreateCase">๐งพ ุฅูุดุงุก ุญุงูุฉ</button>
          <button class="btn ghost" id="btnVisit" data-action="btnVisit">๐ฅ ุทูุจ ุฒูุงุฑุฉ ุงูุชุฑุงุถูุฉ</button>
          <button class="btn" id="btnMyCases" data-action="btnMyCases">๐ ุนุฑุถ ุญุงูุงุชู</button>
          <button class="btn ghost" id="btnMyReport" data-action="btnMyReport">โฌ๏ธ ุชูุฑูุฑ</button>
          <button class="btn ghost" id="btnHelp" data-action="btnHelp">๐ ูุณุงุนุฏุฉ</button>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="kpi__label">ุญุงูุฉ ุงููุธุงู</div>
            <div class="kpi__value">ุฌุงูุฒ</div>
          </div>
          <div class="kpi">
            <div class="kpi__label">ุงูุฏูุฑ</div>
            <div class="kpi__value" data-user-role>student</div>
          </div>
          <div class="kpi">
            <div class="kpi__label">ุงูุจูุงูุงุช</div>
            <div class="kpi__value">Firestore โ</div>
          </div>
        </div>
      </div>

      <div class="hero__right">
        <div class="glassCard">
          <div class="glassCard__title">ููุฎุต ุณุฑูุน</div>
          <div class="glassCard__body">
            <div class="row">
              <span class="muted">ุชุฐููุฑ:</span>
              <span>ุงูุฃูุถู: ููุงุณุงุช โ ูุฑุฒ โ ุฅูุดุงุก ุญุงูุฉ โ ุฒูุงุฑุฉ.</span>
            </div>
            <div class="row">
              <span class="muted">ูุตูุญุฉ:</span>
              <span>ุฅุฐุง ูุชุจุช โูุงุฏุฑูโโฆ AI ุจูุญุงููโฆ ุจุณ ูู ุณุงุญุฑ ๐</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Grid -->
    <section class="grid2">

      <!-- Symptoms / Complaint -->
      <section class="card">
        <header class="card__head">
          <h2 class="card__title">๐ ุงูุดููู / ุงูุฃุนุฑุงุถ</h2>
          <div class="card__tools">
            <button class="btn ghost sm" id="btnSaveSymptoms">ุญูุธ</button>
          </div>
        </header>

        <div class="card__body">
          <label class="field">
            <div class="field__label">ูุด ุชุญุณ ูููุ (ุงูุชุจูุง ุจูุถูุญ)</div>
            <textarea id="symptoms" class="input" rows="5" placeholder="ูุซุงู: ุตุฏุงุน + ุญุฑุงุฑุฉ + ุณุนุงู + ุฃูู ุญููโฆ"></textarea>
          </label>

          <div class="rowActions">
            <!-- ูุฑุจุทูุง ุชุญุช ุจูู Actions.runTriage() -->
            <button class="btn" id="btnRunSensors">๐ ุชุดุบูู ุงูููุงุณุงุช (ูุญุงูุงุฉ)</button>
            <!-- ูุฑุจุทูุง ุชุญุช ุจูู Actions.createCaseFromLast() -->
            <button class="btn primary" id="btnSubmitAI">๐ค ูุฑุฒ ุฐูู (AI)</button>
          </div>

          <div class="hint">โ ุงูููุงุณุงุช ููุง ูุญุงูุงุฉ ููุชุฌุฑุจุฉ. ูุงุญููุง ูุฑุจุทูุง IoT.</div>
        </div>
      </section>

      <!-- Vitals -->
      <section class="card">
        <header class="card__head">
          <h2 class="card__title">๐ ุงูููุงุณุงุช (Vitals)</h2>
          <div class="card__tools">
            <span class="pill">Demo</span>
          </div>
        </header>

        <div class="card__body">
          <div class="vitals">
            <div class="vital">
              <div class="vital__label">ูุจุถ ุงูููุจ</div>
              <div class="vital__value" id="v_hr">โ</div>
              <div class="vital__unit">BPM</div>
            </div>

            <div class="vital">
              <div class="vital__label">ุงูุฃูุณุฌูู</div>
              <div class="vital__value" id="v_spo2">โ</div>
              <div class="vital__unit">%</div>
            </div>

            <div class="vital">
              <div class="vital__label">ุงูุญุฑุงุฑุฉ</div>
              <div class="vital__value" id="v_temp">โ</div>
              <div class="vital__unit">ยฐC</div>
            </div>

            <div class="vital">
              <div class="vital__label">ุงูุถุบุท</div>
              <div class="vital__value" id="v_bp">โ</div>
              <div class="vital__unit">mmHg</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="miniCards">
            <div class="miniCard">
              <div class="miniCard__label">ุงูุญุงูุฉ</div>
              <div class="miniCard__value" id="v_status">โ</div>
            </div>
            <div class="miniCard">
              <div class="miniCard__label">ุงูุฃููููุฉ</div>
              <div class="miniCard__value" id="v_priority">โ</div>
            </div>
            <div class="miniCard">
              <div class="miniCard__label">ุงููุฎุงุทุฑ</div>
              <div class="miniCard__value" id="v_risk">โ</div>
            </div>
            <div class="miniCard">
              <div class="miniCard__label">ูุฑุงุฑ AI</div>
              <div class="miniCard__value" id="v_decision">โ</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Visit -->
      <section class="card">
        <header class="card__head">
          <h2 class="card__title">๐ ุงูุฒูุงุฑุฉ / ุงูุฅุญุงูุฉ</h2>
          <div class="card__tools">
            <a class="btn ghost sm" href="visit.html">ูุชุญ ุตูุญุฉ ุงูุฒูุงุฑุฉ</a>
          </div>
        </header>

        <div class="card__body">
          <p class="muted">
            ุจุนุฏ ุงููุฑุฒ ุงูุฐูู ุชูุฏุฑ ุชุจุฏุฃ ุฒูุงุฑุฉ โ (Demo) ุซู ุชุฑูุญ ูุตูุญุฉ ุงูุฒูุงุฑุฉ.
          </p>

          <div class="rowActions">
            <button class="btn primary" id="btnStartVisit">๐ ุจุฏุก ุฒูุงุฑุฉ</button>
            <a class="btn" href="parent.html">๐จโ๐ฉโ๐งโ๐ฆ ุจูุงุจุฉ ููู ุงูุฃูุฑ</a>
          </div>

          <div class="hint">ุฅุฐุง ูุง ููู ุญุงูุฉ: ุณูููู ููุงุณุงุช ููุฑุฒ ุฃูู.</div>
        </div>
      </section>

      <!-- Notifications (Demo placeholder) -->
      <section class="card">
        <header class="card__head">
          <h2 class="card__title">๐ ุงูุชูุจููุงุช</h2>
          <div class="card__tools">
            <span class="pill">ูุญุธู</span>
          </div>
        </header>

        <div class="card__body">
          <div id="notifyList" class="list">
            <div class="empty muted">ูุง ููุฌุฏ ุชูุจููุงุช ุญุงููุงู.</div>
          </div>
        </div>
      </section>

    </section>
  </main>

  <!-- โ Required scripts (ONE TIME, order matters) -->
  <script type="module" src="./firebase-init.js"></script>
  <script src="./rbac.js"></script>
  <script src="./actions.js"></script>

  <!-- Page glue: map your custom buttons -> Actions + update UI -->
  <script>
    (function(){
      const $ = (s,r=document)=>r.querySelector(s);

      // Theme toggle (simple)
      $("#btnTheme")?.addEventListener("click", () => {
        const html = document.documentElement;
        const cur = html.getAttribute("data-theme") || "dark";
        const nxt = cur === "dark" ? "light" : "dark";
        html.setAttribute("data-theme", nxt);
        localStorage.setItem("THEME", nxt);
      });

      // Restore theme
      const savedTheme = localStorage.getItem("THEME");
      if (savedTheme) document.documentElement.setAttribute("data-theme", savedTheme);

      // Save symptoms locally (and used by actions via complaint)
      $("#btnSaveSymptoms")?.addEventListener("click", () => {
        localStorage.setItem("SYMPTOMS", ($("#symptoms")?.value || "").trim());
        alert("ุชู ุงูุญูุธ โ");
      });

      // IMPORTANT: actions.js reads complaint from #complaint or #txtComplaint
      // so we provide a hidden alias input for compatibility
      const ta = $("#symptoms");
      if (ta && !$("#txtComplaint")) {
        const alias = document.createElement("textarea");
        alias.id = "txtComplaint";
        alias.className = "input";
        alias.style.display = "none";
        ta.insertAdjacentElement("afterend", alias);
      }
      function syncComplaint(){
        const v = ($("#symptoms")?.value || localStorage.getItem("SYMPTOMS") || "").trim();
        const alias = $("#txtComplaint");
        if (alias) alias.value = v;
      }
      $("#symptoms")?.addEventListener("input", syncComplaint);
      syncComplaint();

      // Wire your custom buttons to Actions
      $("#btnRunSensors")?.addEventListener("click", async () => {
        syncComplaint();
        await window.Actions?.runTriage?.(); // creates triage doc + emits triage:update
      });

      $("#btnSubmitAI")?.addEventListener("click", async () => {
        syncComplaint();
        // creates a case using last triage (or sim if none)
        await window.Actions?.createCaseFromLast?.(); // emits case:update
      });

      $("#btnStartVisit")?.addEventListener("click", async () => {
        syncComplaint();
        await window.Actions?.createVisit?.(); // creates visit doc
        location.href = "visit.html";
      });

      // Update UI from events
      function paintFromTriage(detail){
        const v = detail?.vitals || {};
        const t = detail?.triage || {};
        if ($("#v_hr")) $("#v_hr").textContent = v.hr ?? "โ";
        if ($("#v_spo2")) $("#v_spo2").textContent = v.spo2 ?? "โ";
        if ($("#v_temp")) $("#v_temp").textContent = v.temp ?? "โ";
        if ($("#v_bp")) $("#v_bp").textContent = v.bp ?? "โ";

        if ($("#v_status")) $("#v_status").textContent = "ุชู ุงูููุงุณ";
        if ($("#v_priority")) $("#v_priority").textContent = t.priority ?? "โ";
        if ($("#v_risk")) $("#v_risk").textContent = t.risk ?? "โ";
        if ($("#v_decision")) $("#v_decision").textContent = `Score ${t.score ?? "โ"}`;
      }

      window.addEventListener("triage:update", (e) => paintFromTriage(e.detail));
      window.addEventListener("case:update", (e) => {
        // case:update from actions sometimes is patch-only; keep simple
        if ($("#v_status")) $("#v_status").textContent = "ุชู ุฅูุดุงุก ุญุงูุฉ";
      });

      // Auto-fill name/role labels
      const name = localStorage.getItem("USER_NAME") || "ุทุงูุจ";
      document.querySelectorAll("[data-user-name]").forEach(el=>el.textContent = name);
      document.querySelectorAll("[data-user-role]").forEach(el=>el.textContent = "student");
    })();
  </script>
<script type="module" src="./firebase-init.js"></script>
</body>
</html>
