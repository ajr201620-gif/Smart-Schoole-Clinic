<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Clinic OS โ ุจูุงุจุฉ ุงูุทุงูุจ</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <div class="logo">SC</div>
      <div>
        <div class="brand-title">Smart Clinic OS</div>
        <div class="brand-sub">Student Portal โ ุจูุงุจุฉ ุงูุทุงูุจ</div>
      </div>
    </div>

    <div class="top-actions">
      <button class="btn ghost" id="btnTheme" title="ุชุจุฏูู ุงููุถุน">๐</button>
      <button class="btn ghost" id="btnQuickRequest">ุทูุจ ุณุฑูุน</button>
      <button class="btn" id="btnSOS" title="ุชูุจูู ุนุงุฌู (Demo)">๐</button>
    </div>
  </header>

  <div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="nav-title">ุงููุงุฆูุฉ</div>
      <nav class="nav" id="stuNav">
        <button class="nav-item active" data-view="home"><span class="ico">๐</span><span>ุงูุฑุฆูุณูุฉ</span></button>
        <button class="nav-item" data-view="request"><span class="ico">๐</span><span>ุทูุจ ุฒูุงุฑุฉ</span></button>
        <button class="nav-item" data-view="status"><span class="ico">๐</span><span>ูุชุงุจุนุฉ ุงูุทูุจ</span></button>
        <button class="nav-item" data-view="learn"><span class="ico">๐</span><span>ุชุนููู ุตุญู</span></button>
        <button class="nav-item" data-view="history"><span class="ico">๐๏ธ</span><span>ุงูุณุฌู</span></button>
      </nav>

      <div class="sidebar-foot">
        <div class="pill">
          <span class="dot" id="dotLive"></span>
          <div>
            <div style="font-weight:1000;">System</div>
            <div class="muted small" id="sysStatus">System: Ready</div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="muted small">
          * ูุฐู ูุณุฎุฉ ุชุฌุฑูุจูุฉ ููุนุฑุถ. ูุง ูุชู ุฅุฑุณุงู ุจูุงูุงุช ุญููููุฉ.
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">

      <!-- Hero -->
      <section class="hero">
        <div class="hero-left">
          <div class="kicker">๐ Student</div>
          <h1>ูุฑุญุจูุง ุจู</h1>
          <p class="hero-desc">
            ุงุทูุจ ุฒูุงุฑุฉ ููุนูุงุฏุฉุ ุชุงุจุน ุงูุญุงูุฉุ ูุชุนููู ุจุณุฑุนุฉ ููู ุชุชุตุฑู ุนูุฏ ุงูุฃุนุฑุงุถ ุงูุดุงุฆุนุฉ.
          </p>

          <div class="hero-cta">
            <button class="btn" id="btnGoRequest">ุงุทูุจ ุฒูุงุฑุฉ ุงูุขู</button>
            <button class="btn ghost" id="btnGoLearn">ุชุนููู ุตุญู ุณุฑูุน</button>
          </div>

          <div class="hero-badges">
            <span class="badge">RBAC: Student</span>
            <span class="badge ghost">Privacy-first</span>
            <span class="badge">Local Demo</span>
          </div>
        </div>

        <div class="hero-right">
          <div class="scorecard">
            <div class="scorecard-head">
              <div>
                <div class="score-title">ุขุฎุฑ ุชูุตูุฉ</div>
                <div class="score-sub">ูุฎุชุตุฑ ููุทุงูุจ</div>
              </div>
              <div class="ring">
                <div class="ring-inner">
                  <div class="ring-num" id="lastScore">โ</div>
                  <div class="ring-lbl">OK</div>
                </div>
              </div>
            </div>

            <div class="scorecard-grid">
              <div class="mini">
                <div class="mini-k">ุงูุญุงูุฉ</div>
                <div class="mini-v" id="lastStatus">ูุณุชูุฑุฉ</div>
              </div>
              <div class="mini">
                <div class="mini-k">ุชูุตูุฉ</div>
                <div class="mini-v" id="lastAdvice">ูุงุก + ุฑุงุญุฉ</div>
              </div>
              <div class="mini">
                <div class="mini-k">ูุชุงุจุนุฉ</div>
                <div class="mini-v" id="lastFollow">ุฅู ูุฒู</div>
              </div>
              <div class="mini">
                <div class="mini-k">ุงูููู</div>
                <div class="mini-v" id="today">โ</div>
              </div>
            </div>

            <div class="scorecard-foot muted small">* ุจูุงูุงุช ุชุฌุฑูุจูุฉ.</div>
          </div>
        </div>
      </section>

      <!-- Views -->
      <section class="views">

        <!-- HOME -->
        <section class="view show" id="view-home">
          <div class="section-head">
            <div>
              <h2>ุงูุฑุฆูุณูุฉ</h2>
              <div class="muted">ุงุฎุชุตุงุฑุงุช ุณุฑูุนุฉ + ุชุนูููุงุช</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnRefresh">ุชุญุฏูุซ</button>
              <button class="btn" id="btnOpenStatus">ูุชุงุจุนุฉ ุงูุทูุจ</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-head">
                <h3>ุงุฎุชุตุงุฑุงุช</h3>
                <div class="muted small">Quick actions</div>
              </div>

              <div class="quickGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn ghost" id="qHeadache">๐ค ุตุฏุงุน</button>
                <button class="btn ghost" id="qFever">๐ก๏ธ ุญุฑุงุฑุฉ</button>
                <button class="btn ghost" id="qStomach">๐คข ุฃูู ุจุทู</button>
                <button class="btn ghost" id="qBreath">๐ฎโ๐จ ุถูู ุชููุณ</button>
              </div>

              <div class="divider"></div>
              <div class="muted small" id="quickHint">ุงุฎุชุฑ ุนุฑุถูุง ูุชุธูุฑ ุฎุทูุงุช ุณุฑูุนุฉ.</div>
            </div>

            <div class="card">
              <div class="card-head">
                <h3>ุฅุฑุดุงุฏ ููุฑู</h3>
                <div class="muted small">What to do now</div>
              </div>

              <div class="tips" id="tipsBox" style="display:grid; gap:10px;">
                <div class="tip">๐ง ุงุดุฑุจ ูุงุก ุงูุขู</div>
                <div class="tip">๐ด ุฎุฐ ุฑุงุญุฉ ูุตูุฑุฉ</div>
                <div class="tip">๐ท ุฅุฐุง ูุงูุช ุฃุนุฑุงุถ ุนุฏูู: ุงุจุชุนุฏ ุนู ุงูุขุฎุฑูู ูุจููุบ ุงููุนูู</div>
                <div class="tip">๐ ูู ุงุณุชูุฑุช ุงูุฃุนุฑุงุถ: ุงุทูุจ ุฒูุงุฑุฉ ููุนูุงุฏุฉ</div>
              </div>

              <div class="card-actions">
                <button class="btn" id="btnMakeRequest">ุทูุจ ุฒูุงุฑุฉ</button>
                <button class="btn ghost" id="btnSeeLearn">ูุชุญ ุงูุชุนููู ุงูุตุญู</button>
              </div>
            </div>
          </div>
        </section>

        <!-- REQUEST -->
        <section class="view" id="view-request">
          <div class="section-head">
            <div>
              <h2>ุทูุจ ุฒูุงุฑุฉ ููุนูุงุฏุฉ</h2>
              <div class="muted">ุงููุฃ ุจูุงูุงุช ูุฎุชุตุฑุฉ (Demo)</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnBackHome">โ ุฑุฌูุน</button>
              <button class="btn" id="btnSubmitReq">ุฅุฑุณุงู ุงูุทูุจ</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-head">
                <h3>ุจูุงูุงุช ุงูุทุงูุจ</h3>
                <div class="muted small">Student info</div>
              </div>

              <div class="form">
                <div class="row">
                  <div>
                    <label>Student ID (Demo)</label>
                    <input id="studentId" placeholder="STD-23" />
                  </div>
                  <div>
                    <label>ุงูุงุณู</label>
                    <input id="studentName" placeholder="ุทุงูุจ #23" />
                  </div>
                </div>

                <div class="row">
                  <div>
                    <label>ุงูุนูุฑ</label>
                    <input id="age" type="number" min="5" max="20" placeholder="12" />
                  </div>
                  <div>
                    <label>ุงูุตู/ุงููุตู</label>
                    <input id="classRoom" placeholder="6/ุจ" />
                  </div>
                </div>

                <label>ุงูุนุฑุถ ุงูุฑุฆูุณู</label>
                <select id="symptom">
                  <option value="">โ ุงุฎุชุฑ โ</option>
                  <option value="headache">ุตุฏุงุน</option>
                  <option value="fever">ุญุฑุงุฑุฉ</option>
                  <option value="stomach">ุฃูู ุจุทู</option>
                  <option value="cough">ุณุนุงู</option>
                  <option value="breath">ุถูู ุชููุณ</option>
                  <option value="injury">ุฅุตุงุจุฉ/ุฌุฑุญ</option>
                </select>

                <label>ูุตู ูุฎุชุตุฑ</label>
                <textarea id="desc" rows="4" placeholder="ูุชู ุจุฏุฃุ ุดุฏุชูุ ุฃู ุดูุก ูููโฆ"></textarea>

                <label>ุฏุฑุฌุฉ ุงูุฅูุญุงุญ (ุญุณุจ ุดุนูุฑู)</label>
                <select id="urgency">
                  <option value="low">ููุฎูุถ</option>
                  <option value="med" selected>ูุชูุณุท</option>
                  <option value="high">ุนุงูู</option>
                </select>
              </div>

              <div class="card-actions">
                <button class="btn ghost" id="btnAutoFill">ุชุนุจุฆุฉ ุณุฑูุนุฉ</button>
                <button class="btn" id="btnSubmitReq2">ุฅุฑุณุงู</button>
              </div>
            </div>

            <div class="card">
              <div class="card-head">
                <h3>ูุงุฐุง ุณูุญุฏุซ ุจุนุฏ ุงูุฅุฑุณุงูุ</h3>
                <div class="muted small">Flow</div>
              </div>

              <ul class="bullets">
                <li>ุณูุธูุฑ ุงูุทูุจ ูู ุงูุนูุงุฏุฉ (Demo).</li>
                <li>ูุฏ ูุชู ุงุณุชุฏุนุงุคู ุฃู ุทูุจ ูุชุงุจุนุฉ.</li>
                <li>ูุฏ ูุชู ุฅุดุนุงุฑ ููู ุงูุฃูุฑ ุนูุฏ ุงูุญุงุฌุฉ.</li>
                <li>ุฎุตูุตูุฉ ุงูุทุงูุจ ูุญููุธุฉ ุญุณุจ ุงูุฏูุฑ.</li>
              </ul>

              <div class="divider"></div>
              <div class="muted small">
                * ูู ุงููุณุฎุฉ ุงูุญููููุฉ ูููู ุฑุจุท ุงูุทูุจ ุจู (ููุงุฐ/ุฃุจุดุฑ) ูุชูุซูู ููู ุงูุฃูุฑ.
              </div>
            </div>
          </div>
        </section>

        <!-- STATUS -->
        <section class="view" id="view-status">
          <div class="section-head">
            <div>
              <h2>ูุชุงุจุนุฉ ุงูุทูุจ</h2>
              <div class="muted">Tracking (Demo)</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnBackHome2">โ ุฑุฌูุน</button>
              <button class="btn" id="btnAdvance">ุชูุฏู ุงูุญุงูุฉ (Demo)</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-head">
                <h3>ุญุงูุฉ ุงูุทูุจ ุงูุญุงููุฉ</h3>
                <div class="muted small" id="reqId">Request: โ</div>
              </div>

              <div class="statusBox" style="display:grid; gap:10px;">
                <div class="kvrow"><span class="muted">ุงููุฑุญูุฉ:</span><b id="stStage">โ</b></div>
                <div class="kvrow"><span class="muted">ุงูููุช:</span><b id="stTime">โ</b></div>
                <div class="kvrow"><span class="muted">ููุงุญุธุฉ:</span><b id="stNote">โ</b></div>
              </div>

              <div class="divider"></div>

              <div class="card-actions">
                <button class="btn" id="btnCancel">ุฅูุบุงุก ุงูุทูุจ</button>
                <button class="btn ghost" id="btnOpenReq">ูุชุญ ูููุฐุฌ ุงูุทูุจ</button>
              </div>
            </div>

            <div class="card">
              <div class="card-head">
                <h3>ูุตุงุฆุญ ุฃุซูุงุก ุงูุงูุชุธุงุฑ</h3>
                <div class="muted small">While waiting</div>
              </div>

              <div class="tips" style="display:grid; gap:10px;">
                <div class="tip">๐ช ุงุฌูุณ ูู ููุงู ุขูู ููุงุฏุฆ</div>
                <div class="tip">๐ง ุงุดุฑุจ ูุงุก</div>
                <div class="tip">๐งโ๐ซ ุฃุฎุจุฑ ุงููุนูู ุฅุฐุง ุณุงุกุช ุงูุฃุนุฑุงุถ</div>
                <div class="tip">๐ ููุทูุงุฑุฆ ุงุณุชุฎุฏู ุฒุฑ SOS</div>
              </div>
            </div>
          </div>
        </section>

        <!-- LEARN -->
        <section class="view" id="view-learn">
          <div class="section-head">
            <div>
              <h2>ุชุนููู ุตุญู ุชูุงุนูู</h2>
              <div class="muted">Micro-lessons + Quiz</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnBackHome3">โ ุฑุฌูุน</button>
              <button class="btn" id="btnQuiz">ุงุฎุชุจุงุฑ ุณุฑูุน</button>
            </div>
          </div>

          <div class="grid-2">
            <div class="card">
              <div class="card-head">
                <h3>ุฏุฑูุณ ูุตูุฑุฉ</h3>
                <div class="muted small">Pick one</div>
              </div>

              <div class="quickGrid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button class="btn ghost lbtn" data-l="wash">๐งผ ุบุณู ุงููุฏูู</button>
                <button class="btn ghost lbtn" data-l="hydr">๐ง ุงูุชุฑุทูุจ</button>
                <button class="btn ghost lbtn" data-l="sleep">๐ด ุงูููู</button>
                <button class="btn ghost lbtn" data-l="mask">๐ท ุงูููุงูุฉ</button>
              </div>

              <div class="divider"></div>
              <div class="muted" id="lessonBox" style="line-height:1.9;">
                ุงุฎุชุฑ ุฏุฑุณูุง ูุนุฑุถู ููุง.
              </div>
            </div>

            <div class="card">
              <div class="card-head">
                <h3>ุชุญุฏู ุงูููู</h3>
                <div class="muted small">Daily challenge</div>
              </div>

              <div class="tip" style="line-height:1.9;">
                โ ุงุดุฑุจ ููุจ ูุงุก ุงูุขูุ ุซู ุณุฌูู โุชูโ ูู ุงูุณุฌู.
              </div>

              <div class="card-actions">
                <button class="btn" id="btnMarkDone">ุชู โ</button>
                <button class="btn ghost" id="btnOpenHistory">ูุชุญ ุงูุณุฌู</button>
              </div>
            </div>
          </div>
        </section>

        <!-- HISTORY -->
        <section class="view" id="view-history">
          <div class="section-head">
            <div>
              <h2>ุงูุณุฌู</h2>
              <div class="muted">Requests + Activity (local demo)</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnClear">ูุณุญ ุงูุณุฌู</button>
              <button class="btn" id="btnExport">ุชุตุฏูุฑ JSON</button>
            </div>
          </div>

          <div class="card">
            <div class="card-head">
              <h3>ุขุฎุฑ ุงูุฃูุดุทุฉ</h3>
              <div class="muted small">Local history</div>
            </div>
            <div class="table" id="histTable"></div>
          </div>
        </section>

      </section>
    </main>
  </div>

  <!-- Scripts -->
  <script src="engine.js"></script>
  <script src="rbac.js"></script>
  <script src="auth-demo.js"></script>
  <script src="audit-users.js"></script>

  <script>
    (function(){
      const ROLE_KEY = "sc_role";
      const HKEY = "sc_student_history";
      const RKEY = "sc_student_request";

      const $ = (s,r=document)=>r.querySelector(s);
      const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
      const pad2 = (n)=>String(n).padStart(2,"0");
      const time = ()=>{
        const d=new Date();
        return pad2(d.getHours())+":"+pad2(d.getMinutes())+":"+pad2(d.getSeconds());
      };
      const today = new Date().toLocaleDateString("ar-SA");

      // Force role
      try{
        localStorage.setItem(ROLE_KEY, "student");
        window.SCRBAC?.applyRBAC?.();
        window.SCAUDIT?.audit?.("PAGE_OPEN", { page:"student.html" });
      }catch(_){}

      // Theme toggle
      $("#btnTheme")?.addEventListener("click", ()=>{
        const html = document.documentElement;
        const next = html.dataset.theme === "light" ? "dark" : "light";
        html.dataset.theme = next;
        try{ window.SCAUDIT?.audit?.("THEME_TOGGLE", { to: next }); }catch(_){}
      });

      // nav
      function openView(view){
        $$("#stuNav .nav-item").forEach(b=>b.classList.remove("active"));
        $(`#stuNav .nav-item[data-view="${view}"]`)?.classList.add("active");
        $$(".view").forEach(v=>v.classList.remove("show"));
        $(`#view-${view}`)?.classList.add("show");
        try{ window.SCAUDIT?.audit?.("NAV_OPEN", { view }); }catch(_){}
      }
      $$("#stuNav .nav-item").forEach(btn=>{
        btn.addEventListener("click", ()=> openView(btn.dataset.view));
      });

      // Home buttons
      $("#today").textContent = today;
      $("#btnGoRequest")?.addEventListener("click", ()=> openView("request"));
      $("#btnMakeRequest")?.addEventListener("click", ()=> openView("request"));
      $("#btnSeeLearn")?.addEventListener("click", ()=> openView("learn"));
      $("#btnGoLearn")?.addEventListener("click", ()=> openView("learn"));
      $("#btnOpenStatus")?.addEventListener("click", ()=> openView("status"));
      $("#btnBackHome")?.addEventListener("click", ()=> openView("home"));
      $("#btnBackHome2")?.addEventListener("click", ()=> openView("home"));
      $("#btnBackHome3")?.addEventListener("click", ()=> openView("home"));

      // Quick hints
      function setQuick(msg){
        $("#quickHint").textContent = msg;
      }
      $("#qHeadache")?.addEventListener("click", ()=> setQuick("ููุตุฏุงุน: ุงุดุฑุจ ูุงุก + ุฑุงุญุฉ 10 ุฏูุงุฆู + ุชุฌูุจ ุงูุดุงุดุงุช. ุฅุฐุง ุงุณุชูุฑ ุงุทูุจ ุฒูุงุฑุฉ."));
      $("#qFever")?.addEventListener("click", ()=> setQuick("ููุญุฑุงุฑุฉ: ุณูุงุฆู + ุฅุจูุงุบ ุงููุนูู + ุงุทูุจ ุฒูุงุฑุฉ ููุนูุงุฏุฉ. ุชุฌูุจ ูุฎุงูุทุฉ ุงูุขุฎุฑูู."));
      $("#qStomach")?.addEventListener("click", ()=> setQuick("ูุฃูู ุงูุจุทู: ุงุฌูุณ ุจูุฏูุก + ูุงุก ุฑุดูุงุช + ุงุทูุจ ุฒูุงุฑุฉ ุฅุฐุง ุงูุฃูู ููู ุฃู ูุณุชูุฑ."));
      $("#qBreath")?.addEventListener("click", ()=> setQuick("ูุถูู ุงูุชููุณ: ุฃุฎุจุฑ ุงููุนูู ููุฑูุง + ุงุณุชุฎุฏู SOS ุฅุฐุง ุณุงุกุช ุงูุฃุนุฑุงุถ."));

      // Learn lessons
      const lessons = {
        wash: "ุบุณู ุงููุฏูู: 20 ุซุงููุฉ ุจุงููุงุก ูุงูุตุงุจููุ ุฎุตูุตูุง ูุจู ุงูุฃูู ูุจุนุฏ ุงูุณุนุงู/ุงูุนุทุณ.",
        hydr: "ุงูุชุฑุทูุจ: ุงููุงุก ูููู ุงูุตุฏุงุน ูุงูุฅุฑูุงู. ุฎูู ูุฑูุจ ูู ููููุฉ ูุงุก.",
        sleep: "ุงูููู: 8โ9 ุณุงุนุงุช ุชุณุงุนุฏ ุงูููุงุนุฉ ูุงูุชุฑููุฒ ูุชููู ุงูุชูุชุฑ.",
        mask: "ุงูููุงูุฉ: ุบุทู ุงููู ุนูุฏ ุงูุณุนุงูุ ูุงุจุชุนุฏ ุนู ุงูุขุฎุฑูู ุฅุฐุง ุนูุฏู ุฃุนุฑุงุถ."
      };
      $$(".lbtn").forEach(b=>{
        b.addEventListener("click", ()=>{
          $("#lessonBox").textContent = lessons[b.dataset.l] || "โ";
          addHist("LESSON_OPEN", { lesson: b.dataset.l });
        });
      });

      // Quiz
      $("#btnQuiz")?.addEventListener("click", ()=>{
        const ok = confirm("ุณุคุงู ุณุฑูุน: ูู ุบุณู ุงููุฏูู 20 ุซุงููุฉ ูููุ");
        addHist("QUIZ", { answer: ok ? "yes" : "no" });
        alert(ok ? "ุตุญ โ" : "ูู ูุดููุฉโฆ ุชุนูููุง ุงูููู ๐");
      });

      // History
      function loadHist(){
        try{ return JSON.parse(localStorage.getItem(HKEY) || "[]"); }catch(_){ return []; }
      }
      function saveHist(rows){
        localStorage.setItem(HKEY, JSON.stringify(rows.slice(0,200)));
      }
      function addHist(type, meta={}){
        const rows = loadHist();
        rows.unshift({ t: time(), type, meta });
        saveHist(rows);
        renderHist();
        try{ window.SCAUDIT?.audit?.("STUDENT_EVENT", { type, meta }); }catch(_){}
      }
      function renderHist(){
        const box = $("#histTable");
        if(!box) return;
        const rows = loadHist().slice(0,50);
        if(!rows.length){
          box.innerHTML = `<div class="empty">ูุง ููุฌุฏ ุณุฌู ุจุนุฏ</div>`;
          return;
        }
        box.innerHTML = `
          <div class="trow thead"><div>ุงูููุช</div><div>ุงูููุน</div><div colspan="3">ุชูุงุตูู</div></div>
          ${rows.map(r=>`
            <div class="trow">
              <div class="muted">${r.t}</div>
              <div><b>${r.type}</b></div>
              <div class="muted" style="grid-column:3 / -1;">${short(JSON.stringify(r.meta||{}))}</div>
            </div>
          `).join("")}
        `;
      }
      function short(s){ return s.length>120 ? s.slice(0,120)+"โฆ" : s; }

      // Request tracking model
      const stages = [
        { s:"SENT", note:"ุชู ุฅุฑุณุงู ุงูุทูุจ โ" },
        { s:"QUEUED", note:"ุชูุช ุฅุถุงูุชู ููุงุฆูุฉ ุงูุนูุงุฏุฉ" },
        { s:"CALLED", note:"ูุฏ ูุชู ุงุณุชุฏุนุงุคู ุงูุขู" },
        { s:"IN_CLINIC", note:"ุฏุงุฎู ุงูุนูุงุฏุฉ (Demo)" },
        { s:"DONE", note:"ุชู ุฅุบูุงู ุงูุทูุจ" }
      ];

      function loadReq(){
        try{ return JSON.parse(localStorage.getItem(RKEY) || "null"); }catch(_){ return null; }
      }
      function saveReq(req){
        localStorage.setItem(RKEY, JSON.stringify(req));
      }
      function renderReq(){
        const req = loadReq();
        if(!req){
          $("#reqId").textContent = "Request: โ";
          $("#stStage").textContent = "ูุง ููุฌุฏ ุทูุจ";
          $("#stTime").textContent = "โ";
          $("#stNote").textContent = "ุงุฐูุจ ูุทูุจ ุฒูุงุฑุฉ ูุฅุฑุณุงู ุทูุจ ุฌุฏูุฏ.";
          return;
        }
        $("#reqId").textContent = "Request: " + req.id;
        $("#stStage").textContent = req.stage;
        $("#stTime").textContent = req.t;
        $("#stNote").textContent = req.note;
      }

      function submitReq(){
        const req = {
          id: "REQ-" + Math.random().toString(36).slice(2,8).toUpperCase(),
          t: time(),
          stage: "SENT",
          note: "ุชู ุฅุฑุณุงู ุงูุทูุจ โ",
          studentId: ($("#studentId").value||"").trim(),
          studentName: ($("#studentName").value||"").trim(),
          age: ($("#age").value||"").trim(),
          classRoom: ($("#classRoom").value||"").trim(),
          symptom: $("#symptom").value || "",
          desc: ($("#desc").value||"").trim(),
          urgency: $("#urgency").value || "med"
        };
        saveReq(req);
        addHist("REQUEST_SENT", { id:req.id, symptom:req.symptom, urgency:req.urgency });
        alert("ุชู ุฅุฑุณุงู ุงูุทูุจ (Demo) โ");
        openView("status");
        renderReq();
      }

      function advanceReq(){
        const req = loadReq();
        if(!req){ alert("ูุง ููุฌุฏ ุทูุจ ุจุนุฏ"); return; }
        const idx = stages.findIndex(x=>x.s===req.stage);
        const next = stages[Math.min(stages.length-1, idx+1)];
        req.stage = next.s;
        req.note = next.note;
        req.t = time();
        saveReq(req);
        addHist("REQUEST_STAGE", { id:req.id, stage:req.stage });
        renderReq();
      }

      function cancelReq(){
        const req = loadReq();
        if(!req){ return; }
        if(!confirm("ูุชุฃูุฏ ุชุจุบู ุชูุบู ุงูุทูุจุ")) return;
        localStorage.removeItem(RKEY);
        addHist("REQUEST_CANCELED", { id:req.id });
        renderReq();
      }

      // Buttons
      $("#btnSubmitReq")?.addEventListener("click", submitReq);
      $("#btnSubmitReq2")?.addEventListener("click", submitReq);
      $("#btnAdvance")?.addEventListener("click", advanceReq);
      $("#btnCancel")?.addEventListener("click", cancelReq);
      $("#btnOpenReq")?.addEventListener("click", ()=> openView("request"));

      $("#btnAutoFill")?.addEventListener("click", ()=>{
        $("#studentId").value = "STD-" + (Math.floor(Math.random()*90)+10);
        $("#studentName").value = "ุทุงูุจ #" + (Math.floor(Math.random()*90)+10);
        $("#age").value = String(Math.floor(Math.random()*7)+10);
        $("#classRoom").value = (Math.floor(Math.random()*6)+1) + "/" + ["ุฃ","ุจ","ุฌ"][Math.floor(Math.random()*3)];
        $("#symptom").value = ["headache","fever","stomach","cough"][Math.floor(Math.random()*4)];
        $("#desc").value = "ุจุฏุฃุช ุงูุฃุนุฑุงุถ ูุจู " + (Math.floor(Math.random()*6)+1) + " ุณุงุนุฉ. (Demo)";
        $("#urgency").value = ["low","med","high"][Math.floor(Math.random()*3)];
        addHist("AUTOFILL", {});
      });

      // Quick request
      $("#btnQuickRequest")?.addEventListener("click", ()=>{
        openView("request");
        $("#btnAutoFill")?.click();
      });

      // SOS (demo)
      $("#btnSOS")?.addEventListener("click", ()=>{
        addHist("SOS", { note:"Emergency demo pressed" });
        try{ window.SCAUDIT?.audit?.("SOS_PRESSED", { by:"student" }); }catch(_){}
        alert("ุชู ุฅุฑุณุงู ุชูุจูู ุนุงุฌู ููุนูุงุฏุฉ (Demo) ๐");
        $("#dotLive")?.classList.add("pulse");
        setTimeout(()=>$("#dotLive")?.classList.remove("pulse"), 900);
      });

      $("#btnMarkDone")?.addEventListener("click", ()=>{
        addHist("CHALLENGE_DONE", { date: today });
        alert("ููุชุงุฒ โ ุณุฌููุงูุง ูู ุงูุณุฌู");
      });

      $("#btnOpenHistory")?.addEventListener("click", ()=> openView("history"));

      $("#btnClear")?.addEventListener("click", ()=>{
        if(!confirm("ูุณุญ ุงูุณุฌู ุจุงููุงููุ")) return;
        localStorage.setItem(HKEY, "[]");
        addHist("HISTORY_CLEARED", {});
        renderHist();
      });

      $("#btnExport")?.addEventListener("click", ()=>{
        const rows = loadHist();
        const blob = new Blob([JSON.stringify(rows, null, 2)], {type:"application/json;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "student-history.json";
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 600);
        addHist("HISTORY_EXPORTED", { count: rows.length });
      });

      $("#btnRefresh")?.addEventListener("click", ()=>{
        $("#dotLive")?.classList.add("pulse");
        setTimeout(()=>$("#dotLive")?.classList.remove("pulse"), 900);
        addHist("REFRESH", {});
      });

      // Init
      renderHist();
      renderReq();
    })();
  </script>

</body>
</html>
