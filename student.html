<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Smart Clinic OS โ Student</title>
  <link rel="stylesheet" href="ar.css"/>
  <link rel="stylesheet" href="shell.css"/>
  <script src="bus.js"></script>
  <script src="sensor-sim.js"></script>
  <script src="ai-triage.js"></script>
  <script src="rbac.js"></script>
</head>
<body>

<div class="sc-top">
  <div class="left">
    <span class="sc-chip" id="scRoleChip">Student</span>
    <div class="sc-title">
      <b id="scRoleTitle">ุจูุงุจุฉ ุงูุทุงูุจ</b>
      <small>ุดููู + ุญุณุงุณุงุช (ูุญุงูุงุฉ) + ูุฑุฒ AI + ุฒูุงุฑุฉ ุงูุชุฑุงุถูุฉ</small>
    </div>
  </div>
  <div class="sc-actions">
    <span class="sc-status" id="scStatus">๐ข Ready</span>
    <a class="sc-primary" id="scPrimaryAction" href="visit.html?role=student">๐ฅ ุฒูุงุฑุฉ ุงูุชุฑุงุถูุฉ</a>
  </div>
</div>

<div class="sc-shell">
  <aside class="sc-side">
    <div class="sc-chip">ุงูุชูููู</div>
    <nav class="sc-nav">
      <a class="sc-nav-item" href="index.html">๐ ุงูุจูุงุจุฉ</a>
      <a class="sc-nav-item" href="#check">๐ฉบ ุงููุญุต</a>
      <a class="sc-nav-item" href="#ai">๐ง ูุฑุฒ AI</a>
      <a class="sc-nav-item" href="report.html#me">๐งพ ุชูุฑูุฑู</a>
    </nav>

    <div style="margin-top:14px" class="sc-chip">Quick</div>
    <div class="sc-quick">
      <button class="sc-qa" id="btnGen">โก ุชูููุฏ ุญุณุงุณุงุช</button>
      <button class="sc-qa" id="btnRunAI">๐ง ุชุดุบูู ุงููุฑุฒ</button>
      <button class="sc-qa" id="btnSubmit">๐จ ุฅุฑุณุงู ููุทุจูุจ</button>
      <a class="sc-qa" id="btnVisit" href="visit.html?role=student">๐ฅ ุฏุฎูู ุงูุฒูุงุฑุฉ</a>
    </div>
  </aside>

  <main class="sc-main">
    <div style="padding:16px">
      <div class="panel">
        <div class="h">
          <h2 id="check">ุงูุดููู</h2>
          <div class="muted">ุงูุชุจ ุงูุฃุนุฑุงุถ ุจุงุฎุชุตุงุฑ</div>
        </div>

        <textarea id="complaint" class="input" rows="3" style="width:100%; border-radius:14px; padding:12px;"
          placeholder="ูุซุงู: ุตุฏุงุน + ุญุฑุงุฑุฉ + ูุญุฉ..."></textarea>

        <div class="sep"></div>

        <div class="h">
          <h2>ูุฑุงุกุงุช ุงูุญุณุงุณุงุช (ูุญุงูุงุฉ)</h2>
          <div class="muted">Temp / HR / SpOโ / BP</div>
        </div>

        <div class="kpis">
          <div class="kpi"><b>Temp</b><span id="vTemp">โ</span></div>
          <div class="kpi"><b>HR</b><span id="vHR">โ</span></div>
          <div class="kpi"><b>SpOโ</b><span id="vSp">โ</span></div>
          <div class="kpi"><b>BP</b><span id="vBP">โ</span></div>
        </div>

        <div class="sep"></div>

        <div class="h" id="ai">
          <h2>ูุฑุฒ AI ุงูุฐูู</h2>
          <div class="muted">Risk + Priority + ุชูุตูุฉ</div>
        </div>

        <div class="kpis">
          <div class="kpi"><b>Risk</b><span id="aiRisk">โ</span></div>
          <div class="kpi"><b>Priority</b><span id="aiPri">โ</span></div>
          <div class="kpi"><b>Recommendation</b><span id="aiRec">โ</span></div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn" id="btnGen2">โก ุชูููุฏ ุญุณุงุณุงุช</button>
          <button class="btn ghost" id="btnRunAI2">๐ง ุชุดุบูู ุงููุฑุฒ</button>
          <button class="btn" id="btnSubmit2">๐จ ุฅุฑุณุงู ููุทุจูุจ</button>
          <a class="btn ghost" id="btnVisit2" href="visit.html?role=student">๐ฅ ุนูุงุฏุฉ ุงูุชุฑุงุถูุฉ</a>
        </div>

        <div class="small" id="hint">ุงุจุฏุฃ ุจุชูููุฏ ุงูุญุณุงุณุงุช ุซู ุดุบูู ูุฑุฒ AI ุซู ุฃุฑุณู ููุทุจูุจ.</div>
      </div>
    </div>
  </main>
</div>

<script>
localStorage.setItem("SC_ROLE","student");

const $ = (s)=>document.querySelector(s);
let vitals = null;
let ai = null;

function paintVitals(v){
  $("#vTemp").textContent = v.temp + "ยฐC";
  $("#vHR").textContent   = v.hr + " bpm";
  $("#vSp").textContent   = v.spo2 + "%";
  $("#vBP").textContent   = v.bp;
}

function paintAI(a){
  $("#aiRisk").textContent = a.risk + "/100";
  $("#aiPri").textContent  = a.priority;
  $("#aiRec").textContent  = a.recommendation;
}

function genProfileSmart(){
  const c = ($("#complaint").value||"").toLowerCase();
  // ูุฒู ุจุณูุท ุญุณุจ ุงูุฃุนุฑุงุถ
  if(c.includes("ุถูู")||c.includes("ุงุบูุงุก")||c.includes("ุฅุบูุงุก")) return "critical";
  if(c.includes("ูุญุฉ")||c.includes("ุญุฑุงุฑุฉ")||c.includes("ุตุฏุฑ")) return Math.random()<0.6?"sick":"mild";
  return Math.random()<0.75?"normal":"mild";
}

function runAI(){
  ai = window.SCAI.triage({ complaint: $("#complaint").value, vitals });
  paintAI(ai);

  const msg = ai.priority==="CRIT" ? "ุทุงุฑุฆ โ ุณูุชู ุชูุฌููู ูุจุงุดุฑุฉ ููุทุจูุจ" :
              ai.priority==="HIGH" ? "ุนุงูู โ ููุตุญ ุจุฒูุงุฑุฉ ุงูุชุฑุงุถูุฉ" :
              ai.priority==="MED"  ? "ูุชูุณุท โ ูุฏ ูุทูุจ ูุฑุงุกุฉ ุซุงููุฉ" :
              "ููุฎูุถ โ ุฅุฑุดุงุฏ ุตุญู";
  $("#hint").textContent = msg;
}

function submitToDoctor(){
  if(!window.SCBUS){ alert("bus.js ุบูุฑ ููุฌูุฏ"); return; }
  if(!vitals){ alert("ูููุฏ ุงูุญุณุงุณุงุช ุฃูููุง"); return; }
  if(!ai){ runAI(); }

  // create request + case
  const req = window.SCBUS.pushRequest({
    studentId: "STD-DEMO",
    studentName: "ุทุงูุจ (Demo)",
    symptom: "student_portal",
    urgency: (ai.priority==="HIGH"||ai.priority==="CRIT") ? "high" : "med",
    desc: $("#complaint").value || "โ"
  });

  const c = window.SCBUS.createCase(req, {
    priority: ai.priority,
    riskScore: ai.risk,
    decision: ai.recommendation,
    dx: "ุจุงูุชุธุงุฑ ุงูุทุจูุจ",
    plan: ai.recommendation,
    vitals,
    ai
  });

  // room = case id
  const room = "ROOM-" + (c.id || Date.now());
  $("#btnVisit").href = `visit.html?role=student&room=${encodeURIComponent(room)}&autojoin=1`;
  $("#btnVisit2").href = $("#btnVisit").href;

  alert("ุชู ุงูุฅุฑุณุงู โ ุฑูู ุงูุญุงูุฉ: " + c.id);
}

function bind(id, fn){ const el=$(id); if(el) el.addEventListener("click", fn); }

bind("#btnGen", ()=>{ vitals = window.SCSIM.gen(genProfileSmart()); paintVitals(vitals); ai=null; });
bind("#btnGen2", ()=>$("#btnGen").click());

bind("#btnRunAI", ()=>{ if(!vitals){ alert("ูููุฏ ุงูุญุณุงุณุงุช"); return; } runAI(); });
bind("#btnRunAI2", ()=>$("#btnRunAI").click());

bind("#btnSubmit", submitToDoctor);
bind("#btnSubmit2", submitToDoctor);

</script>
</body>
</html>
