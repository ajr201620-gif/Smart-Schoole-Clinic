<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</title>
  <link rel="stylesheet" href="app.css" />
</head>

<body data-page="admin">
  <header class="topbar">
    <div class="topbar__left">
      <a class="btn ghost" href="index.html">âŸµ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <div class="brand mini">
        <div class="brand__logo">ğŸ«</div>
        <div class="brand__txt">
          <div class="brand__name">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
          <div class="brand__sub">Ù…Ø¤Ø´Ø±Ø§Øª â€¢ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª â€¢ ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØªØµØ¯ÙŠØ±</div>
        </div>
      </div>
    </div>

    <div class="topbar__right">
      <div class="pill">Ù…Ø±Ø­Ø¨Ù‹Ø§: <b data-user-name>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</b></div>
      <button class="btn ghost" id="btnTheme">ğŸŒ“</button>
    </div>
  </header>

  <main class="shell">
    <!-- KPIs -->
    <section class="card pad">
      <div class="card__title">ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
      <div class="muted">Ù‡Ø°Ù‡ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¯ÙŠÙ…Ùˆ Ù…Ù† localStorage (Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø±Ø¨Ø· Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª).</div>

      <div class="kpis">
        <div class="kpi">
          <div class="kpi__label">Ø·Ù„Ø¨Ø§Øª Ø²ÙŠØ§Ø±Ø©</div>
          <div class="kpi__val" id="kpiRequests">0</div>
        </div>
        <div class="kpi">
          <div class="kpi__label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
          <div class="kpi__val" id="kpiCases">0</div>
        </div>
        <div class="kpi">
          <div class="kpi__label">Ø­Ø§Ù„Ø§Øª Ø­Ø±Ø¬Ø©</div>
          <div class="kpi__val" id="kpiCritical">0</div>
        </div>
        <div class="kpi">
          <div class="kpi__label">ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©</div>
          <div class="kpi__val" id="kpiFollowup">0</div>
        </div>
      </div>

      <div class="row actions">
        <button class="btn solid" id="btnExportReport" data-action="admin:exportReport">â¬‡ï¸ ØªØµØ¯ÙŠØ± JSON</button>
        <button class="btn ghost" id="btnResetDemo" data-action="admin:resetDemo">ğŸ§¹ ØªØµÙÙŠØ± Ø§Ù„Ø¯ÙŠÙ…Ùˆ</button>
        <a class="btn ghost" href="doctor.html">ğŸ©º Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨</a>
        <a class="btn ghost" href="student.html">ğŸ’ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</a>
      </div>
    </section>

    <!-- Recent Cases -->
    <section class="grid2" style="margin-top:14px;">
      <div class="card pad">
        <div class="card__title">ğŸ§¾ Ø¢Ø®Ø± Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
        <div class="muted">Ø¹Ø±Ø¶ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø­Ø§Ù„Ø§Øª â€” (Ø¥Ù† Ù…Ø§ Ø¸Ù‡Ø± Ø´ÙŠØ¡: Ø±ÙˆØ­ Ù„Ù„Ø·Ø§Ù„Ø¨ ÙˆØ£Ù†Ø´Ø¦ Ø­Ø§Ù„Ø©).</div>

        <div id="adminCases" class="list"></div>
      </div>

      <div class="card pad">
        <div class="card__title">ğŸ›°ï¸ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
        <div class="muted">Ù‚Ø§Ø¦Ù…Ø© Ù…Ø®ØªØµØ±Ø© ØªØ­Ø§ÙƒÙŠ Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.</div>

        <div id="adminAlerts" class="list"></div>
      </div>
    </section>
  </main>

  <!-- Scripts -->
  <script src="bus.js"></script>
  <script src="auth.js"></script>
  <script src="app-init.js"></script>
  <script src="sensor-sim.js"></script>
  <script src="triage-ai.js"></script>
  <script src="doctor-copilot.js"></script>
  <script src="visit-session.js"></script>
  <script src="app.js"></script>
  <script src="actions.js"></script>

  <script>
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function renderAdminLists(){
      const app = window.app;
      if(!app) return;

      const cases = app.getCases?.() || [];
      const visits = app.getVisits?.() || [];

      // KPIs
      const stats = app.getAdminStats?.();
      if (stats && window.bus?.applyStats) window.bus.applyStats(stats);

      const list = document.getElementById("adminCases");
      if(list){
        if(!cases.length){
          list.innerHTML = `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯.</div>`;
        } else {
          const last = cases.slice(-8).reverse();
          list.innerHTML = last.map(c => `
            <div class="rowCard">
              <div class="rowTitle">${escapeHtml(c.id)} â€” ${escapeHtml(c.patient?.name || "Ø·Ø§Ù„Ø¨")}</div>
              <div class="rowMeta">
                ${escapeHtml(c.triage?.priority || "â€”")} / ${escapeHtml(c.triage?.risk || "â€”")}
                â€¢ ${new Date(c.createdAt).toLocaleString("ar-SA")}
                â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ${escapeHtml(c.status)}
              </div>
              <div class="rowBtns">
                <a class="btn tiny ghost" href="doctor.html">ÙØªØ­ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¨</a>
                <a class="btn tiny ghost" href="parent.html">ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</a>
              </div>
            </div>
          `).join("");
        }
      }

      const alerts = document.getElementById("adminAlerts");
      if(alerts){
        const critical = cases.filter(c => c.triage?.priority === "P1").slice(-4).reverse();
        const pendingVisits = visits.filter(v => v.status === "pending").slice(-4).reverse();

        const blocks = [];
        critical.forEach(c => blocks.push({
          t: "ğŸš¨ Ø­Ø§Ù„Ø© Ø­Ø±Ø¬Ø©",
          m: `${c.id} â€¢ ${c.patient?.name || "Ø·Ø§Ù„Ø¨"} â€¢ ${c.triage?.risk || "â€”"}`,
        }));
        pendingVisits.forEach(v => blocks.push({
          t: "ğŸ¥ Ø·Ù„Ø¨ Ø²ÙŠØ§Ø±Ø©",
          m: `${v.id} â€¢ Ù„Ù„Ø­Ø§Ù„Ø© ${v.caseId} â€¢ ÙƒÙˆØ¯ ${v.joinCode}`,
        }));

        if(!blocks.length){
          alerts.innerHTML = `<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
        } else {
          alerts.innerHTML = blocks.map(x => `
            <div class="rowCard">
              <div class="rowTitle">${escapeHtml(x.t)}</div>
              <div class="rowMeta">${escapeHtml(x.m)}</div>
            </div>
          `).join("");
        }
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btnTheme")?.addEventListener("click", () => {
        const html = document.documentElement;
        const isDark = html.getAttribute("data-theme") !== "light";
        html.setAttribute("data-theme", isDark ? "light" : "dark");
      });

      renderAdminLists();
      window.bus?.on?.("case:update", renderAdminLists);
      window.bus?.on?.("visit:update", renderAdminLists);
    });
  </script>
    <!-- Ø¨Ø§Ù‚ÙŠ Ø³ÙƒØ±Ø¨ØªØ§ØªÙƒ -->
  <script src="./actions.js"></script>

  <!-- Firebase (Ù„Ø§Ø²Ù… Ø¢Ø®Ø± Ø´ÙŠØ¡ ÙˆÙ‚Ø¨Ù„ </body>) -->
  <script type="module" src="./firebase-init.js"></script>
</body>
</html>

