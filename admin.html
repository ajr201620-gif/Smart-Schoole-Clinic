<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ููุญุฉ ุงูุฅุฏุงุฑุฉ โ ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</title>
  <link rel="stylesheet" href="app.css" />
<link rel="stylesheet" href="ui.css" />
</head>

<body data-page="admin">
  <!-- Topbar -->
  <header class="topbar topbar--slim">
    <div class="topbar__left">
      <a class="btn ghost sm" href="index.html">โฉ๏ธ ุงูุฑุฆูุณูุฉ</a>
      <div class="brand mini">
        <div class="brand__logo">๐ซ</div>
        <div class="brand__txt">
          <div class="brand__name">ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</div>
          <div class="brand__sub">ููุญุฉ ุงูุฅุฏุงุฑุฉ โข ูุคุดุฑุงุช โข ูุชุงุจุนุฉ</div>
        </div>
      </div>
    </div>

    <div class="topbar__right">
      <div class="pill pill--soft">
        <span class="dot ok"></span>
        <span>ูุฑุญุจูุงุ <b data-user-name>ุงูุฅุฏุงุฑุฉ</b></span>
      </div>
      <button class="btn ghost sm" id="btnTheme">๐</button>
      <button class="btn danger sm" id="btnLogoutTop" data-action="common:logout">ุฎุฑูุฌ</button>
    </div>
  </header>

  <main class="shell shell--wide">
    <!-- Hero -->
    <section class="hero hero--compact">
      <div class="hero__left">
        <h1 class="hero__title">ูุคุดุฑุงุช ุงููุฏุฑุณุฉ ุงูุตุญูุฉ</h1>
        <p class="hero__lead">ูุธุฑุฉ ุดุงููุฉ ุนูู ุงูุญุงูุงุชุ ุงูุฃููููุงุชุ ูุงููุชุงุจุนุฉโุจุดูู ูุงุถุญ ููุงุจู ููุนุฑุถ.</p>

        <div class="hero__cta">
          <span class="chip"><span class="dot ok"></span> Firestore: <b id="fbState">โ</b></span>
          <span class="chip">ุงูุฏูุฑ: <b data-user-role>admin</b></span>
          <button class="btn ghost sm" id="btnRefresh">ุชุญุฏูุซ</button>
        </div>
      </div>

      <div class="hero__right">
        <div class="glassCard glassCard--tight">
          <div class="glassCard__title">ููุฎุต ุณุฑูุน</div>
          <div class="glassCard__body">
            <div class="row"><span class="muted">ุทูุงุจ ูุญุตูุง ุงูููู:</span> <b id="kChecked">โ</b></div>
            <div class="row"><span class="muted">ูุญุชุงุฌ ูุชุงุจุนุฉ:</span> <b id="kFollow">โ</b></div>
            <div class="row"><span class="muted">ุฅุญุงูุงุช:</span> <b id="kRefer">โ</b></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Layout -->
    <section class="triLayout triLayout--admin">
      <!-- Left: KPIs -->
      <section class="card card--soft">
        <header class="card__head">
          <h2 class="card__title">๐ ูุคุดุฑุงุช</h2>
        </header>
        <div class="card__body">
          <div class="kpis kpis--admin">
            <div class="kpiBox">
              <div class="kpiBox__t">ุฅุฌูุงูู ุงูุญุงูุงุช</div>
              <div class="kpiBox__v" id="kTotal">โ</div>
            </div>
            <div class="kpiBox">
              <div class="kpiBox__t">ุฌุฏูุฏุฉ</div>
              <div class="kpiBox__v" id="kNew">โ</div>
            </div>
            <div class="kpiBox">
              <div class="kpiBox__t">ูุชูุณุทุฉ</div>
              <div class="kpiBox__v" id="kMed">โ</div>
            </div>
            <div class="kpiBox">
              <div class="kpiBox__t">ุนุงููุฉ</div>
              <div class="kpiBox__v" id="kHigh">โ</div>
            </div>
            <div class="kpiBox">
              <div class="kpiBox__t">ููุนุชูุฏุฉ</div>
              <div class="kpiBox__v" id="kApproved">โ</div>
            </div>
            <div class="kpiBox">
              <div class="kpiBox__t">ูุชุงุจุนุฉ</div>
              <div class="kpiBox__v" id="kFollow2">โ</div>
            </div>
            <div class="kpiBox">
              <div class="kpiBox__t">ุฅุญุงูุฉ</div>
              <div class="kpiBox__v" id="kRefer2">โ</div>
            </div>
            <div class="kpiBox">
              <div class="kpiBox__t">ุฅุดุนุงุฑุงุช ุงูููู</div>
              <div class="kpiBox__v" id="kNotif">โ</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="noticeBox">
            <div class="noticeBox__title">๐งญ ูุฑุงุฑ ุณุฑูุน</div>
            <div class="muted">ุงุฎุชุฑ ุญุงูุฉ ูู ุงูุฌุฏููุ ุซู ุฃุฑุณู ุฅุดุนุงุฑ ุฃู ุบููุฑ ุญุงูุชูุง.</div>
          </div>
        </div>
      </section>

      <!-- Center: Table -->
      <section class="card card--focus">
        <header class="card__head">
          <h2 class="card__title">๐งพ ุฌุฏูู ุงูุญุงูุงุช</h2>
          <div class="card__tools">
            <select id="filterStatus" class="input" style="max-width:180px">
              <option value="all">ูู ุงูุญุงูุงุช</option>
              <option value="new">ุฌุฏูุฏุฉ</option>
              <option value="approved">ููุนุชูุฏุฉ</option>
              <option value="follow">ูุชุงุจุนุฉ</option>
              <option value="refer">ุฅุญุงูุฉ</option>
            </select>
          </div>
        </header>

        <div class="card__body">
          <div id="casesTable" class="tableWrap">
            <div class="empty muted">ุฌุงุฑู ุงูุชุญูููโฆ</div>
          </div>
        </div>
      </section>

      <!-- Right: Actions -->
      <aside class="card card--soft">
        <header class="card__head">
          <h2 class="card__title">โ๏ธ ุฅุฌุฑุงุกุงุช</h2>
        </header>
        <div class="card__body">
          <div class="miniCards miniCards--2">
            <div class="miniCard">
              <div class="miniCard__label">Case ID</div>
              <div class="miniCard__value" id="selId">โ</div>
            </div>
            <div class="miniCard">
              <div class="miniCard__label">Owner</div>
              <div class="miniCard__value" id="selOwner">โ</div>
            </div>
            <div class="miniCard">
              <div class="miniCard__label">Status</div>
              <div class="miniCard__value" id="selStatus">โ</div>
            </div>
            <div class="miniCard">
              <div class="miniCard__label">Priority</div>
              <div class="miniCard__value" id="selPriority">โ</div>
            </div>
          </div>

          <div class="divider"></div>

          <label class="field">
            <div class="field__label">ุฑุณุงูุฉ ุฅุดุนุงุฑ</div>
            <textarea id="notifMsg" class="input" rows="4" placeholder="ูุซุงู: ุชู ุงุนุชูุงุฏ ุญุงูุชูุ ุฑุงุฌุน ุงูุทุจูุจ ุบุฏูุงโฆ"></textarea>
          </label>

          <div class="rowActions rowActions--split">
            <button class="btn primary" id="btnNotifyStudent">๐ ุฅุดุนุงุฑ ุงูุทุงูุจ</button>
            <button class="btn" id="btnNotifyParent">๐จโ๐ฉโ๐งโ๐ฆ ุฅุดุนุงุฑ ููู ุงูุฃูุฑ</button>
          </div>

          <div class="divider"></div>

          <div class="rowActions rowActions--split">
            <button class="btn warn" id="btnSetFollow">๐ ูุชุงุจุนุฉ</button>
            <button class="btn" id="btnSetRefer">โช๏ธ ุฅุญุงูุฉ</button>
          </div>

          <div class="divider"></div>

          <button class="btn danger" id="btnLogoutBottom" data-action="common:logout">ุฎุฑูุฌ</button>
        </div>
      </aside>
    </section>
  </main>

  <!-- Scripts -->
  <script src="./bus.js"></script>
  <script src="./auth.js"></script>

  <!-- Firebase -->
  <script type="module" src="./firebase-init.js"></script>

  <!-- Actions (logout/theme etc if you have) -->
  <script src="./actions.js"></script>

  <!-- Page glue -->
  <script>
    (function(){
      const $=(s,r=document)=>r.querySelector(s);
      let casesCache=[];
      let selected=null;

      async function showFB(){
        const el=$("#fbState");
        let tries=0; while(!window.FB && tries++<40) await new Promise(r=>setTimeout(r,50));
        el.textContent = window.FB ? "ูุชุตู" : "ุบูุฑ ุฌุงูุฒ";
      }

      function fmt(s){ return (s===undefined||s===null||s==="") ? "โ" : String(s); }

      function setSelected(c){
        selected=c;
        $("#selId").textContent = c? c.id : "โ";
        $("#selOwner").textContent = c? fmt(c.ownerId) : "โ";
        $("#selStatus").textContent = c? fmt(c.status) : "โ";
        $("#selPriority").textContent = c? fmt(c.priority) : "โ";
      }

      function computeKPIs(){
        const total = casesCache.length;
        const kNew = casesCache.filter(c=>c.status==="new").length;
        const kApproved = casesCache.filter(c=>c.status==="approved").length;
        const kFollow = casesCache.filter(c=>c.status==="follow").length;
        const kRefer = casesCache.filter(c=>c.status==="refer").length;
        const kHigh = casesCache.filter(c=>(c.priority||"").toLowerCase()==="high").length;
        const kMed  = casesCache.filter(c=>(c.priority||"").toLowerCase()==="medium").length;

        $("#kTotal").textContent = total;
        $("#kNew").textContent = kNew;
        $("#kApproved").textContent = kApproved;
        $("#kFollow2").textContent = kFollow;
        $("#kRefer2").textContent = kRefer;
        $("#kHigh").textContent = kHigh;
        $("#kMed").textContent = kMed;

        $("#kChecked").textContent = total; // Demo: total
        $("#kFollow").textContent = kFollow;
        $("#kRefer").textContent = kRefer;
      }

      function renderTable(){
        const wrap=$("#casesTable");
        const f = $("#filterStatus").value;
        const list = (f==="all") ? casesCache : casesCache.filter(c=>c.status===f);

        if(!list.length){
          wrap.innerHTML = `<div class="empty muted">ูุง ุชูุฌุฏ ูุชุงุฆุฌ.</div>`;
          return;
        }

        wrap.innerHTML = `
          <table class="table">
            <thead>
              <tr>
                <th>Case</th>
                <th>Owner</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Symptoms</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(c=>`
                <tr class="trow ${selected?.id===c.id?'is-active':''}" data-id="${c.id}">
                  <td>${c.id}</td>
                  <td>${fmt(c.ownerId)}</td>
                  <td>${fmt(c.status)}</td>
                  <td>${fmt(c.priority)}</td>
                  <td>${fmt(c.symptoms).slice(0,38)}${(fmt(c.symptoms).length>38)?'โฆ':''}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;

        wrap.querySelectorAll(".trow").forEach(tr=>{
          tr.onclick=()=>{
            const id = tr.dataset.id;
            const c = casesCache.find(x=>x.id===id);
            setSelected(c);
            renderTable();
          };
        });
      }

      async function loadCases(){
        const { db, collection, getDocs } = window.FB;
        const snap = await getDocs(collection(db,"cases"));
        casesCache=[];
        snap.forEach(d=>casesCache.push({ id:d.id, ...d.data() }));
        computeKPIs();
        if(!selected && casesCache[0]) setSelected(casesCache[0]);
        renderTable();
      }

      async function updateCaseStatus(status){
        if(!selected) return alert("ุงุฎุชุฑ ุญุงูุฉ ูู ุงูุฌุฏูู ุฃููุงู");
        const { db, doc, updateDoc, serverTimestamp } = window.FB;
        await updateDoc(doc(db,"cases",selected.id), { status, updatedAt: serverTimestamp() });
        await loadCases();
        alert("ุชู โ");
      }

      async function sendNotif(toRole){
        if(!selected) return alert("ุงุฎุชุฑ ุญุงูุฉ ุฃููุงู");
        const msg = ($("#notifMsg").value||"").trim();
        if(!msg) return alert("ุงูุชุจ ุฑุณุงูุฉ ุงูุฅุดุนุงุฑ");

        const { db, collection, addDoc, serverTimestamp } = window.FB;
        await addDoc(collection(db,"notifications"), {
          toRole,
          title: "ุชูุจูู ูู ุงูุฅุฏุงุฑุฉ",
          message: msg,
          caseId: selected.id,
          ownerId: selected.ownerId || null,
          at: new Date().toISOString(),
          createdAt: serverTimestamp()
        });
        $("#notifMsg").value="";
        alert("ุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ โ");
      }

      document.addEventListener("DOMContentLoaded", async()=>{
        await showFB();
        await loadCases();

        $("#btnRefresh").onclick = loadCases;
        $("#filterStatus").onchange = renderTable;

        $("#btnSetFollow").onclick = ()=>updateCaseStatus("follow");
        $("#btnSetRefer").onclick = ()=>updateCaseStatus("refer");

        $("#btnNotifyStudent").onclick = ()=>sendNotif("student");
        $("#btnNotifyParent").onclick = ()=>sendNotif("parent");

        const name = localStorage.getItem("USER_NAME") || "ุงูุฅุฏุงุฑุฉ";
        document.querySelectorAll("[data-user-name]").forEach(el=>el.textContent=name);
      });
    })();
  </script>
</body>
</html>
