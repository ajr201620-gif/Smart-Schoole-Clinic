<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</title>
  <link rel="stylesheet" href="app.css" />
</head>

<body data-page="admin">

  <!-- Topbar -->
  <header class="topbar">
    <div class="inner">
      <div class="topbar_left">
        <a class="btn ghost" href="index.html">â†©ï¸ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

        <div class="brand">
          <div class="brand__logo"></div>
          <div class="brand__txt">
            <div class="brand__name">Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</div>
            <div class="brand__sub">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€¢ Ù…Ø¤Ø´Ø±Ø§Øª â€¢ Ø¥Ø­Ø§Ù„Ø§Øª â€¢ Ù…Ø±Ø§Ù‚Ø¨Ø©</div>
          </div>
        </div>

        <div class="pill">
          <small>Ø§Ù„Ø¯ÙˆØ±</small>
          <b data-user-role>admin</b>
        </div>
      </div>

      <div class="topbar_right">
        <div class="pill">
          <small>Ù…Ø±Ø­Ø¨Ù‹Ø§</small>
          <b data-user-name>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</b>
        </div>

        <button class="btn ghost" id="btnTheme" data-action="common:theme-toggle">ğŸŒ“</button>
        <button class="btn bad" id="btnLogout" data-action="common:logout">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- Hero -->
    <section class="panel hero">
      <div class="heroRow">
        <div>
          <div class="heroTitle">ğŸ« Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€” ØªØ­ÙƒÙ… ÙƒØ§Ù…Ù„ (Ø¨Ø¯ÙˆÙ† ÙƒØ±Ù ÙŠØ¯ÙˆÙŠ)</div>
          <div class="heroDesc">
            Ù‡Ù†Ø§ ØªØ´ÙˆÙ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§ØªØŒ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©ØŒ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§ØªØŒ Ø§Ù„Ø²ÙŠØ§Ø±Ø§ØªØŒ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.
            ÙƒÙ„ Ø²Ø± Ù‡Ù†Ø§ Ø´ØºØ§Ù„ (ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ø­Ù„ÙŠÙ‹Ø§) ÙˆØ¬Ø§Ù‡Ø² Ù†Ø±Ø¨Ø·Ù‡ Ø¹Ù„Ù‰ Firestore Ø¨Ø¹Ø¯ Ù…Ø§ Ù†Ø«Ø¨Øª Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ.
          </div>

          <div class="heroActions mt12">
            <button class="btn" id="btnAdminRequests" data-action="admin:view-requests">ğŸ“¥ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
            <button class="btn primary" id="btnAssignDoctor" data-action="admin:assign-doctor">ğŸ©º Ø¥Ø­Ø§Ù„Ø© Ù„Ø·Ø¨ÙŠØ¨</button>
            <button class="btn bad" id="btnMarkCritical" data-action="admin:mark-critical">ğŸš¨ ØªÙ…ÙŠÙŠØ² ÙƒØ­Ø§Ù„Ø© Ø­Ø±Ø¬Ø©</button>
            <button class="btn ghost" id="btnExportAudit" data-action="admin:export-audit">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„</button>
          </div>

          <div class="flex mt12">
            <a class="btn ghost" href="student.html">ğŸ’ Ø§Ù„Ø·Ø§Ù„Ø¨</a>
            <a class="btn ghost" href="parent.html">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</a>
            <a class="btn ghost" href="doctor.html">ğŸ©º Ø§Ù„Ø·Ø¨ÙŠØ¨</a>
            <a class="btn ghost" href="visit.html">ğŸ¥ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</a>
          </div>
        </div>

        <div class="kpiRow" style="min-width:320px;">
          <div class="kpi">
            <div class="kLabel">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
            <div class="kVal" id="k_cases">0</div>
            <div class="kMeta">Ø§Ù„ÙŠÙˆÙ…/Ø¢Ø®Ø± Ø¬Ù„Ø³Ø©</div>
          </div>
          <div class="kpi warn">
            <div class="kLabel">Ø­Ø§Ù„Ø§Øª ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø©</div>
            <div class="kVal" id="k_follow">0</div>
            <div class="kMeta">Followup required</div>
          </div>
          <div class="kpi bad">
            <div class="kLabel">Ø­Ø§Ù„Ø§Øª Ø­Ø±Ø¬Ø©</div>
            <div class="kVal" id="k_critical">0</div>
            <div class="kMeta">Critical / High risk</div>
          </div>
          <div class="kpi ok">
            <div class="kLabel">Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø¬Ø¯ÙˆÙ„Ø©</div>
            <div class="kVal" id="k_visits">0</div>
            <div class="kMeta">Scheduled / In progress</div>
          </div>
        </div>
      </div>
    </section>

    <div class="grid mt16">

      <!-- Cases List -->
      <section class="panel card col-8">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">ğŸ“‹</span> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª</div>
          <span class="chip">Cases</span>
        </div>

        <div class="cardBody">
          <div id="caseList">
            <div class="subtle">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯.</div>
          </div>
        </div>
      </section>

      <!-- Admin Insights -->
      <section class="panel card col-4">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">ğŸ“ˆ</span> Ù…Ø¤Ø´Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
          <span class="chip warn">Monitor</span>
        </div>

        <div class="cardBody">
          <div class="rowCard">
            <div class="rowTitle">Ù…ÙˆØ§ÙÙ‚Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</div>
            <div class="rowMeta">
              Approved: <b id="k_cons_appr">0</b> â€¢ Rejected: <b id="k_cons_rej">0</b> â€¢ Pending: <b id="k_cons_pen">0</b>
            </div>
          </div>

          <div class="rowCard">
            <div class="rowTitle">Ù‚Ø±Ø§Ø±Ø§Øª AI / Ø§Ù„Ø·Ø¨ÙŠØ¨</div>
            <div class="rowMeta" id="k_decisions">â€”</div>
          </div>

          <div class="rowCard">
            <div class="rowTitle">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</div>
            <div class="rowMeta flex">
              <button class="btn small" id="btnHeatmap" data-action="admin:open-heatmap">ğŸ—ºï¸ Heatmap</button>
              <button class="btn small" id="btnSlips" data-action="admin:open-slips">ğŸ§¾ ØªØµØ§Ø±ÙŠØ­</button>
              <button class="btn small" data-action="common:download-report">â¬‡ï¸ ØªÙ‚Ø±ÙŠØ±</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Notifications -->
      <section class="panel card col-12">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">ğŸ””</span> ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
          <span class="chip ok">Live</span>
        </div>

        <div class="cardBody">
          <div id="adminNotify">
            <div class="subtle">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Scripts -->
  <script src="./bus.js"></script>
  <script src="./auth.js"></script>
  <script src="./sensor-sim.js"></script>

  <!-- Firebase init (module) -->
  <script type="module" src="./firebase-init.js"></script>

  <!-- Actions -->
  <script src="./actions.js"></script>

  <!-- Admin binder -->
  <script>
    (function(){
      "use strict";
      const $ = (s,r=document)=>r.querySelector(s);
      const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

      function badge(priority, risk){
        const p = (priority||"").toLowerCase();
        const r = (risk||"").toLowerCase();
        if(p.includes("critical") || r.includes("high")) return `<span class="chip bad">Critical</span>`;
        if(p.includes("high") || r.includes("med")) return `<span class="chip warn">Needs attention</span>`;
        return `<span class="chip ok">Normal</span>`;
      }

      function compute(){
        const DB = window.SSC?.db;
        if(!DB) return null;

        const cases = DB.cases || [];
        const visits = DB.visits || [];

        const critical = cases.filter(c => (c.priority==="critical" || c.risk==="high" || c.status==="critical")).length;
        const follow = cases.filter(c => (c.status==="followup_required")).length;

        const vActive = visits.filter(v => ["scheduled","in_progress","checked_in"].includes(v.status)).length;

        const consAppr = cases.filter(c => c.consent==="approved").length;
        const consRej  = cases.filter(c => c.consent==="rejected").length;
        const consPen  = cases.length - consAppr - consRej;

        // top decisions quick summary
        const top = {};
        cases.forEach(c => {
          const d = (c.decision || "â€”").slice(0,30);
          top[d] = (top[d]||0)+1;
        });
        const topStr = Object.entries(top)
          .sort((a,b)=>b[1]-a[1])
          .slice(0,4)
          .map(([k,v])=> `${esc(k)}: <b>${v}</b>`)
          .join(" â€¢ ") || "â€”";

        return { cases, visits, critical, follow, vActive, consAppr, consRej, consPen, topStr };
      }

      function render(){
        const data = compute();
        if(!data) return;

        $("#k_cases").textContent = data.cases.length;
        $("#k_critical").textContent = data.critical;
        $("#k_follow").textContent = data.follow;
        $("#k_visits").textContent = data.vActive;

        $("#k_cons_appr").textContent = data.consAppr;
        $("#k_cons_rej").textContent = data.consRej;
        $("#k_cons_pen").textContent = data.consPen;

        $("#k_decisions").innerHTML = data.topStr;

        const list = $("#caseList");
        if(list){
          if(!data.cases.length){
            list.innerHTML = `<div class="subtle">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯.</div>`;
          } else {
            list.innerHTML = data.cases.slice(0,10).map(c => `
              <div class="rowCard">
                <div class="rowTitle">
                  ${esc(c.owner?.name || "Ø·Ø§Ù„Ø¨")} â€¢ <span class="subtle">#${esc(c.id)}</span>
                </div>
                <div class="rowMeta">
                  <span class="subtle">${esc(c.at || "")}</span>
                  â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: <b>${esc(c.status || "â€”")}</b>
                  â€¢ ${badge(c.priority, c.risk)}
                </div>
                <div class="rowMeta">
                  Ø´ÙƒÙˆÙ‰: ${esc((c.symptoms || "â€”").slice(0,80))}
                </div>

                <div class="flex mt12">
                  <button class="btn small" data-action="admin:assign-doctor" data-case-id="${esc(c.id)}">ğŸ©º Ø¥Ø­Ø§Ù„Ø© Ù„Ø·Ø¨ÙŠØ¨</button>
                  <button class="btn small bad" data-action="admin:mark-critical" data-case-id="${esc(c.id)}">ğŸš¨ Ø­Ø±Ø¬Ø©</button>
                  <a class="btn small ghost" href="doctor.html">ÙØªØ­ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¨</a>
                </div>
              </div>
            `).join("");
          }
        }

        const box = $("#adminNotify");
        if(box){
          const DB = window.SSC?.db;
          const items = (DB.notifications || []).filter(n => n.toRole === "admin").slice(0,8);
          box.innerHTML = items.length
            ? items.map(n => `
              <div class="rowCard">
                <div class="rowTitle">${esc(n.title)}</div>
                <div class="rowMeta">${esc(n.message)} â€¢ <span class="subtle">${esc(n.at)}</span></div>
              </div>
            `).join("")
            : `<div class="subtle">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        render();
        window.bus?.on?.("case:update", render);
        window.bus?.on?.("visit:update", render);
        window.bus?.on?.("notify:update", render);
      });
    })();
  </script>

</body>
</html>
