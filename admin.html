<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุจูุงุจุฉ ุงูุฅุฏุงุฑุฉ โ Smart School Clinic OS</title>

  <link rel="stylesheet" href="app.css">

  <script src="js/bus.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/admin-heatmap.js"></script>
  <script src="js/audit-log.js"></script>
  <script src="actions.js"></script>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="logo">๐ซ</div>
    <div class="brandText">
      <div class="name">ุจูุงุจุฉ ุงูุฅุฏุงุฑุฉ</div>
      <div class="tagline">ูุคุดุฑุงุช โข ูุชุงุจุนุฉ โข ุณูุฏุงุช โข ุณุฌู ุฅุฌุฑุงุกุงุช</div>
    </div>
  </div>
  <div class="topActions">
    <button class="btn ghost" onclick="location.href='index.html'">โฌ๏ธ ุฑุฌูุน</button>
  </div>
</header>

<main class="container">

  <!-- KPIs -->
  <section class="panel">
    <div class="h">
      <h2>๐ ุงููุคุดุฑุงุช ุงูุนุงูุฉ</h2>
      <div class="muted">ูุธุฑุฉ ุณุฑูุนุฉ ุนูู ุงููุถุน ุงูุตุญู</div>
    </div>

    <div class="kpiGrid">
      <div class="kpi"><div class="k">Requests</div><div class="v" id="kReq">โ</div></div>
      <div class="kpi"><div class="k">Cases</div><div class="v" id="kCases">โ</div></div>
      <div class="kpi"><div class="k">Critical</div><div class="v" id="kCrit">โ</div></div>
      <div class="kpi"><div class="k">Follow-up</div><div class="v" id="kFollow">โ</div></div>
    </div>
  </section>

  <div class="sep"></div>

  <!-- Heatmap -->
  <section class="panel">
    <div class="h">
      <h2>๐ฅ ููุญุฉ ุงููุชุงุจุนุฉ (Heatmap)</h2>
      <div class="muted">ุชูุฒูุน ุงูุญุงูุงุช ุญุณุจ ุงูุดุฏุฉ ูุงูุญุงูุฉ</div>
    </div>
    <div id="heatmapBox"></div>
  </section>

  <div class="sep"></div>

  <!-- Latest Cases -->
  <section class="panel">
    <div class="h">
      <h2>๐๏ธ ุขุฎุฑ ุงูุญุงูุงุช</h2>
      <div class="muted">ูููุฑุงุฌุนุฉ ุงูุณุฑูุนุฉ</div>
    </div>
    <div id="casesList"></div>
  </section>

  <div class="sep"></div>

  <!-- Audit Log -->
  <section class="panel">
    <div class="h">
      <h2>๐ ุณุฌู ุงูุฅุฌุฑุงุกุงุช</h2>
      <div class="muted">ุชูุซูู ูู ุฅุฌุฑุงุก ุฅุฏุงุฑู</div>
    </div>
    <div id="auditList"></div>
  </section>

</main>

<script>
(function(){
  SCAUTH.requireRole("admin");
  const $ = (s)=>document.querySelector(s);

  function refresh(){
    const bus = SCBUS.load();
    const cases = bus.cases || [];
    const reqs  = bus.requests || [];

    $("#kReq").textContent = reqs.length;
    $("#kCases").textContent = cases.length;
    $("#kCrit").textContent = cases.filter(c=>c.priority==="CRIT").length;
    $("#kFollow").textContent = cases.filter(c=>c.status==="FOLLOW_UP").length;

    $("#casesList").innerHTML = cases.slice(0,6).map(c=>`
      <div class="sc-nav-item">
        <b>${c.studentName}</b>
        <div class="muted small">
          Case ${c.id} โข ${c.priority} โข ${c.status}
        </div>
      </div>
    `).join("") || `<div class="muted">ูุง ุชูุฌุฏ ุญุงูุงุช</div>`;

    // Heatmap
    window.SCHEAT && window.SCHEAT.render("heatmapBox");

    // Audit
    const rows = window.SCAUDIT?.list(10) || [];
    $("#auditList").innerHTML = rows.map(a=>`
      <div class="sc-nav-item">
        <b>${a.action}</b>
        <div class="muted small">
          ${new Date(a.at).toLocaleString("ar-SA")}
          โข ${a.actor || "system"}
        </div>
      </div>
    `).join("") || `<div class="muted">ูุง ููุฌุฏ ุณุฌู ุจุนุฏ</div>`;
  }

  refresh();
  setInterval(refresh, 2000);
})();
</script>
</body>
</html>
