<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ุจูุงุจุฉ ุงูุฅุฏุงุฑุฉ โ Smart School Clinic OS</title>

  <link rel="stylesheet" href="app.css" />

<script src="bus.js"></script>
<script src="auth.js"></script>
<script src="protocols.js"></script>
<script src="audit-log.js"></script>
<script src="admin-heatmap.js"></script>

<script src="actions.js"></script>
<script src="app-init.js"></script>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="logo">๐ซ</div>
    <div class="brandText">
      <div class="name">ุจูุงุจุฉ ุงูุฅุฏุงุฑุฉ</div>
      <div class="tagline">ูุคุดุฑุงุช โข ูุชุงุจุนุฉ โข ุณูุฏุงุช โข ุณุฌู ุฅุฌุฑุงุกุงุช</div>
    </div>
  </div>
  <div class="topActions">
    <button class="btn ghost" onclick="location.href='index.html'">โฌ๏ธ ุฑุฌูุน</button>
  </div>
</header>
  <main class="page admin-page">

  <section class="card">
    <div class="row between">
      <h3>๐ซ ููุญุฉ ุงูุฅุฏุงุฑุฉ</h3>
      <div class="row" style="gap:10px; flex-wrap:wrap;">
        <button class="btn ghost" data-action="admin.refresh">๐ ุชุญุฏูุซ</button>
        <button class="btn ghost" data-action="admin.exportAudit">๐งพ ุชุตุฏูุฑ ุณุฌู</button>
      </div>
    </div>

    <div class="grid-4" style="margin-top:10px;">
      <div class="kpi"><div class="label">Requests</div><div class="value" id="aRequests">โ</div></div>
      <div class="kpi"><div class="label">Cases</div><div class="value" id="aCases">โ</div></div>
      <div class="kpi"><div class="label">Critical</div><div class="value" id="aCritical">โ</div></div>
      <div class="kpi"><div class="label">Follow-up</div><div class="value" id="aFollowup">โ</div></div>
    </div>
  </section>

  <section class="card">
    <div class="row between">
      <h3>๐ฅ Heatmap (ูุฑุงุฌุนุฉ ุณุฑูุนุฉ)</h3>
      <button class="btn ghost" data-action="admin.buildHeatmap">๐งฉ ุฅุนุงุฏุฉ ุจูุงุก</button>
    </div>
    <div id="aHeatmap" class="heatmap muted">โ</div>
  </section>

  <section class="card">
    <div class="row between">
      <h3>๐ ุขุฎุฑ ุงูุญุงูุงุช</h3>
      <button class="btn ghost" data-action="admin.seedDemo">โจ ุชูููุฏ ุจูุงูุงุช ุชุฌุฑูุจูุฉ</button>
    </div>

    <div id="aCaseList" class="list">
      <div class="muted">ูุง ุชูุฌุฏ ุญุงูุงุช ุจุนุฏ.</div>
    </div>
  </section>

  <section class="card">
    <h3>๐งท ุชูุงุตูู ุงูุญุงูุฉ ุงููุฎุชุงุฑุฉ</h3>

    <div class="grid-3">
      <div><div class="label">ุงูุทุงูุจ</div><div class="value" id="aStudent">โ</div></div>
      <div><div class="label">ุงูุญุงูุฉ</div><div class="value" id="aStatus">โ</div></div>
      <div><div class="label">ุงููุฑุงุฑ</div><div class="value" id="aDecision">โ</div></div>
    </div>

    <div class="label" style="margin-top:10px;">ููุฎุต</div>
    <div class="box" id="aSummary">โ</div>

    <div class="row" style="margin-top:12px; gap:10px; flex-wrap:wrap;">
      <button class="btn warn" data-action="admin.notifyParent">๐จโ๐ฉโ๐ฆ ุฅุดุนุงุฑ ููู ุงูุฃูุฑ</button>
      <button class="btn ghost" data-action="admin.notifyDoctor">๐จโโ๏ธ ุฅุดุนุงุฑ ุงูุทุจูุจ</button>
      <button class="btn primary" data-action="admin.markFollowup">๐ ูุถุน ูุชุงุจุนุฉ</button>
      <button class="btn danger" data-action="admin.markCritical">๐จ ุชุตุนูุฏ Critical</button>
    </div>

    <div class="muted" id="aResult" style="margin-top:10px;"></div>
  </section>

</main>

<main class="container">

  <!-- KPIs -->
  <section class="panel">
    <div class="h">
      <h2>๐ ุงููุคุดุฑุงุช ุงูุนุงูุฉ</h2>
      <div class="muted">ูุธุฑุฉ ุณุฑูุนุฉ ุนูู ุงููุถุน ุงูุตุญู</div>
    </div>

    <div class="kpiGrid">
      <div class="kpi"><div class="k">Requests</div><div class="v" id="kReq">โ</div></div>
      <div class="kpi"><div class="k">Cases</div><div class="v" id="kCases">โ</div></div>
      <div class="kpi"><div class="k">Critical</div><div class="v" id="kCrit">โ</div></div>
      <div class="kpi"><div class="k">Follow-up</div><div class="v" id="kFollow">โ</div></div>
    </div>
  </section>

  <div class="sep"></div>

  <!-- Heatmap -->
  <section class="panel">
    <div class="h">
      <h2>๐ฅ ููุญุฉ ุงููุชุงุจุนุฉ (Heatmap)</h2>
      <div class="muted">ุชูุฒูุน ุงูุญุงูุงุช ุญุณุจ ุงูุดุฏุฉ ูุงูุญุงูุฉ</div>
    </div>
    <div id="heatmapBox"></div>
  </section>

  <div class="sep"></div>

  <!-- Latest Cases -->
  <section class="panel">
    <div class="h">
      <h2>๐๏ธ ุขุฎุฑ ุงูุญุงูุงุช</h2>
      <div class="muted">ูููุฑุงุฌุนุฉ ุงูุณุฑูุนุฉ</div>
    </div>
    <div id="casesList"></div>
  </section>

  <div class="sep"></div>

  <!-- Audit Log -->
  <section class="panel">
    <div class="h">
      <h2>๐ ุณุฌู ุงูุฅุฌุฑุงุกุงุช</h2>
      <div class="muted">ุชูุซูู ูู ุฅุฌุฑุงุก ุฅุฏุงุฑู</div>
    </div>
    <div id="auditList"></div>
  </section>

</main>

<script>
(function(){
  SCAUTH.requireRole("admin");
  const $ = (s)=>document.querySelector(s);

  function refresh(){
    const bus = SCBUS.load();
    const cases = bus.cases || [];
    const reqs  = bus.requests || [];

    $("#kReq").textContent = reqs.length;
    $("#kCases").textContent = cases.length;
    $("#kCrit").textContent = cases.filter(c=>c.priority==="CRIT").length;
    $("#kFollow").textContent = cases.filter(c=>c.status==="FOLLOW_UP").length;

    $("#casesList").innerHTML = cases.slice(0,6).map(c=>`
      <div class="sc-nav-item">
        <b>${c.studentName}</b>
        <div class="muted small">
          Case ${c.id} โข ${c.priority} โข ${c.status}
        </div>
      </div>
    `).join("") || `<div class="muted">ูุง ุชูุฌุฏ ุญุงูุงุช</div>`;

    // Heatmap
    window.SCHEAT && window.SCHEAT.render("heatmapBox");

    // Audit
    const rows = window.SCAUDIT?.list(10) || [];
    $("#auditList").innerHTML = rows.map(a=>`
      <div class="sc-nav-item">
        <b>${a.action}</b>
        <div class="muted small">
          ${new Date(a.at).toLocaleString("ar-SA")}
          โข ${a.actor || "system"}
        </div>
      </div>
    `).join("") || `<div class="muted">ูุง ููุฌุฏ ุณุฌู ุจุนุฏ</div>`;
  }

  refresh();
  setInterval(refresh, 2000);
})();
</script>
</body>
</html>
