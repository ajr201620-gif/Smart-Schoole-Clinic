<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© â€” Smart School Clinic OS</title>

  <link rel="stylesheet" href="assets/css/app.css"/>

  <script src="js/bus.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/visit-session.js"></script>

  <style>
    .vidGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    video{width:100%;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:#000}
    .bar{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
  </style>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <div class="logo">ğŸ¥</div>
    <div class="brandText">
      <div class="name">Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</div>
      <div class="tagline">Room â€¢ Doctor/Student/Parent Guest</div>
    </div>
  </div>
  <div class="topActions">
    <span class="pill" id="roleBadge">â€”</span>
    <button class="btn ghost" id="btnBack">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
  </div>
</header>

<main class="container">

  <section class="panel">
    <div class="bar">
      <div>
        <b>Room:</b> <span id="roomTxt">â€”</span>
        <div class="muted small" id="hint">â€”</div>
      </div>

      <div class="row">
        <button class="btn ghost" id="btnInviteParent">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ø¯Ø¹ÙˆØ© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</button>
        <button class="btn ghost" id="btnToggleCam">ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button class="btn ghost" id="btnToggleMic">ğŸ™ï¸ Ù…Ø§ÙŠÙƒ</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="vidGrid">
      <div>
        <div class="muted small">ğŸ“¹ Ø£Ù†Øª</div>
        <video id="localVid" autoplay playsinline muted></video>
      </div>
      <div>
        <div class="muted small">ğŸ§‘â€âš•ï¸ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± (Demo)</div>
        <video id="remoteVid" autoplay playsinline></video>
      </div>
    </div>

    <div class="sep"></div>

    <div class="muted small">
      Ù‡Ø°Ù‡ Ù†Ø³Ø®Ø© Demo Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ± WebRTC ÙƒØ§Ù…Ù„ (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨ÙŠÙ† Ø¬Ù‡Ø§Ø²ÙŠÙ†).
      Ø§Ù„Ù‡Ø¯Ù: Ø¹Ø±Ø¶ ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø© ÙˆØªÙˆØ«ÙŠÙ‚Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø¸Ø§Ù….
    </div>
  </section>

  <div class="sep"></div>

  <!-- Session Panel injected by visit-session.js -->
  <section class="panel">
    <div class="h">
      <h2>Ø¬Ù„Ø³Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h2>
      <div class="muted" id="vsStatus">â€”</div>
    </div>

    <div class="row">
      <span class="badge">â±ï¸ Timer: <b id="vsTimer">00:00</b></span>
      <button class="btn ghost" id="btnExportJSON">ğŸ’¾ ØªØµØ¯ÙŠØ± JSON</button>
      <button class="btn ghost" id="btnSaveNotes">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
      <button class="btn" id="btnEndVisit">âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø²ÙŠØ§Ø±Ø© + ØªÙ‚Ø±ÙŠØ±</button>
    </div>

    <div class="sep"></div>

    <div class="h">
      <h2>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨</h2>
      <div class="muted">ØªÙØ­ÙØ¸ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§Ù„Ø©</div>
    </div>

    <textarea id="vsNotes" rows="5" class="input"
      style="width:100%; border-radius:14px; padding:12px"
      placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ..."></textarea>
  </section>

</main>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const qs = new URLSearchParams(location.search);
  const room = qs.get("room") || "ROOM-DEMO";
  const role = (qs.get("role") || localStorage.getItem("SC_ROLE") || "student").toLowerCase();
  const isGuest = role === "parent";
  const isDoctor = role === "doctor";

  $("#roomTxt").textContent = room;
  $("#roleBadge").textContent =
    role==="doctor" ? "ğŸ‘¨â€âš•ï¸ Doctor" :
    role==="parent" ? "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parent (Guest)" :
    "ğŸ“ Student";

  $("#hint").textContent = isGuest
    ? "Guest Mode: Ø¹Ø±Ø¶ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ÙƒØ§Ù…ÙŠØ±Ø§/Ù…Ø§ÙŠÙƒ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§)"
    : "ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø§ÙŠÙƒ Ù„Ù„Ø¹Ø±Ø¶";

  $("#btnBack").addEventListener("click", ()=>{
    location.href = role==="doctor" ? "doctor.html" : role==="parent" ? "parent.html" : "student.html";
  });

  // Invite parent (open same room)
  $("#btnInviteParent").addEventListener("click", ()=>{
    const url = `visit.html?role=parent&room=${encodeURIComponent(room)}&autojoin=1`;
    window.open(url, "_blank");
  });
  if(!isDoctor) $("#btnInviteParent").style.display = "none";

  // Media
  const localVid = $("#localVid");
  const remoteVid = $("#remoteVid");
  let stream = null;
  let camOn = false;
  let micOn = false;

  async function startMedia(){
    try{
      const mediaOpts = isGuest ? { video:false, audio:false } : { video:true, audio:true };
      stream = await navigator.mediaDevices.getUserMedia(mediaOpts);
      localVid.srcObject = stream;

      camOn = !!mediaOpts.video;
      micOn = !!mediaOpts.audio;

      // Demo: remote shows same stream if exists
      remoteVid.srcObject = stream;

      updateBtns();
    }catch(e){
      $("#hint").textContent = "Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…ÙŠØ±Ø§/Ù…Ø§ÙŠÙƒ (Ø£Ùˆ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ø§ ÙŠØ¯Ø¹Ù…).";
      updateBtns();
    }
  }

  function updateBtns(){
    $("#btnToggleCam").textContent = camOn ? "ğŸ“· Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§" : "ğŸ“· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
    $("#btnToggleMic").textContent = micOn ? "ğŸ™ï¸ ÙƒØªÙ… Ø§Ù„Ù…Ø§ÙŠÙƒ" : "ğŸ™ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§ÙŠÙƒ";
    if(isGuest){
      $("#btnToggleCam").style.display = "none";
      $("#btnToggleMic").style.display = "none";
    }
  }

  function toggleTrack(kind, on){
    if(!stream) return;
    const tracks = kind==="video" ? stream.getVideoTracks() : stream.getAudioTracks();
    tracks.forEach(t=>t.enabled = on);
  }

  $("#btnToggleCam").addEventListener("click", ()=>{
    camOn = !camOn;
    toggleTrack("video", camOn);
    updateBtns();
  });

  $("#btnToggleMic").addEventListener("click", ()=>{
    micOn = !micOn;
    toggleTrack("audio", micOn);
    updateBtns();
  });

  // Notes editing only doctor
  setTimeout(()=>{
    const notes = $("#vsNotes");
    if(notes && !isDoctor){
      notes.setAttribute("readonly","readonly");
      notes.style.opacity = "0.9";
    }
    const saveBtn = $("#btnSaveNotes");
    if(saveBtn && !isDoctor) saveBtn.style.display = "none";
  }, 250);

  // Start session (BUS integration)
  window.SCVISIT && window.SCVISIT.mount();

  // Auto media
  startMedia();
})();
</script>
</body>
</html>
