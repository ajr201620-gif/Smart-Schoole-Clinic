<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุบุฑูุฉ ุงูุฒูุงุฑุฉ โ ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</title>
  <link rel="stylesheet" href="app.css" />
</head>

<body data-page="visit">

  <!-- Topbar -->
  <header class="topbar">
    <div class="inner">
      <div class="topbar_left">
        <a class="btn ghost" href="index.html">โฉ๏ธ ุงูุฑุฆูุณูุฉ</a>

        <div class="brand">
          <div class="brand__logo"></div>
          <div class="brand__txt">
            <div class="brand__name">ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ</div>
            <div class="brand__sub">ุบุฑูุฉ ุงูุฒูุงุฑุฉ โข ููุฏูู/ุตูุช โข Check-in</div>
          </div>
        </div>

        <div class="pill">
          <small>ุงูุฏูุฑ</small>
          <b data-user-role>visit</b>
        </div>
      </div>

      <div class="topbar_right">
        <div class="pill">
          <small>ุฌูุณุฉ</small>
          <b id="v_timer">00:00</b>
        </div>

        <button class="btn ghost" id="btnTheme" data-action="common:theme-toggle">๐</button>
        <button class="btn bad" id="btnLogout" data-action="common:logout">ุฎุฑูุฌ</button>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- Hero -->
    <section class="panel hero">
      <div class="heroRow">
        <div>
          <div class="heroTitle">๐ฅ ุฒูุงุฑุฉ ุงูุชุฑุงุถูุฉ (Demo)</div>
          <div class="heroDesc">
            ุชุดุบูู ุงููุงููุฑุง ูุงููุงูู ูุชู ูู ุฌูุงุฒู ูุจุงุดุฑุฉ.  
            *ูุฐู ูุณุฎุฉ ุนุฑุถ โุจุฏูู ุณูุฑูุฑโ โ ูุงุญููุง ูุถูู WebRTC ุญูููู ุฅุฐุง ุชุจุบู.*
          </div>

          <div class="heroActions mt12">
            <button class="btn primary" id="btnCheckin" data-action="visit:checkin">โ Check-in</button>
            <button class="btn" id="btnCompleteVisit" data-action="visit:complete">๐ ุฅููุงุก ุงูุฒูุงุฑุฉ</button>
            <button class="btn ghost" id="btnPrintSlip" data-action="visit:print-slip">๐งพ ุทุจุงุนุฉ ูููุฐุฌ</button>
            <button class="btn ghost" data-action="common:download-report">โฌ๏ธ ุชูุฑูุฑ</button>
          </div>

          <div class="subtle mt12">
            ุฅุฐุง ูุง ุธูุฑุช ุงููุงููุฑุง: ุชุฃูุฏ ูู ุตูุงุญูุงุช Safari/Chrome ุซู ุฌุฑูุจ ุชุญุฏูุซ ุงูุตูุญุฉ.
          </div>
        </div>

        <div class="kpiRow" style="min-width:320px;">
          <div class="kpi ok">
            <div class="kLabel">ุงูุญุงูุฉ</div>
            <div class="kVal" id="v_status">โ</div>
            <div class="kMeta">Case</div>
          </div>
          <div class="kpi">
            <div class="kLabel">ุงููุฑุงุฑ</div>
            <div class="kVal" id="v_decision">โ</div>
            <div class="kMeta">AI / Doctor</div>
          </div>
        </div>
      </div>
    </section>

    <div class="grid mt16">

      <!-- Video panel -->
      <section class="panel card col-8">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">๐น</span> ุงูุจุซ (ูุญูู)</div>
          <span class="chip warn">Local Media</span>
        </div>

        <div class="cardBody">
          <div class="rowCard" style="padding:10px;">
            <video id="video" autoplay playsinline muted style="width:100%; border-radius:16px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.2);"></video>
          </div>

          <div class="flex mt12">
            <button class="btn primary" id="btnCam">๐ท ุชุดุบูู ุงููุงููุฑุง</button>
            <button class="btn" id="btnMic">๐๏ธ ุชุดุบูู ุงููุงูู</button>
            <button class="btn bad" id="btnStop">โ ุฅููุงู ุงููู</button>

            <span class="pill right">
              <small>Cam</small> <b id="camState">OFF</b>
              <small style="margin-inline-start:10px;">Mic</small> <b id="micState">OFF</b>
            </span>
          </div>

          <div class="subtle mt8">
            ููุงุญุธุฉ: ุงูููุฏูู ููุง โูุญููโ ููุนุฑุถุ ูููุณ ููุงููุฉ ูุน ุงูุทุฑู ุงูุขุฎุฑ. ููุฏุฑ ูุทูุฑูุง ูู WebRTC ุฅุฐุง ุชุจุบู.
          </div>
        </div>
      </section>

      <!-- Case summary -->
      <section class="panel card col-4">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">๐งพ</span> ููุฎุต ุณุฑูุน</div>
          <span class="chip">Summary</span>
        </div>

        <div class="cardBody">
          <div class="rowCard">
            <div class="rowTitle">ุงูุทุงูุจ</div>
            <div class="rowMeta" id="v_owner">โ</div>
          </div>

          <div class="rowCard">
            <div class="rowTitle">ุงูุดููู</div>
            <div class="rowMeta" id="v_symptoms">โ</div>
          </div>

          <div class="rowCard">
            <div class="rowTitle">ููุงุณุงุช</div>
            <div class="rowMeta" id="v_vitals">โ</div>
          </div>

          <div class="hr"></div>
          <div class="flex">
            <a class="btn ghost" href="doctor.html">๐ฉบ ุงูุทุจูุจ</a>
            <a class="btn ghost" href="parent.html">๐จโ๐ฉโ๐งโ๐ฆ ููู ุงูุฃูุฑ</a>
            <a class="btn ghost" href="admin.html">๐ซ ุงูุฅุฏุงุฑุฉ</a>
          </div>
        </div>
      </section>

      <!-- Notes -->
      <section class="panel card col-12">
        <div class="cardHeader">
          <div class="cardTitle"><span class="ico">๐๏ธ</span> ููุงุญุธุงุช ุงูุฒูุงุฑุฉ</div>
          <span class="chip ok">Notes</span>
        </div>

        <div class="cardBody">
          <div class="field">
            <label>ููุงุญุธุงุช / ุชุนูููุงุช</label>
            <textarea id="visitNotes" class="input" rows="4" placeholder="ุงูุชุจ ููุงุญุธุงุช ุงูุฒูุงุฑุฉโฆ"></textarea>
          </div>
          <div class="subtle">
            *ูู ุงููุณุฎุฉ ุงููุงุฏูุฉ ูุฑุจุท ุงูููุงุญุธุงุช ุจุงูุญุงูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (Firestore).*
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Scripts -->
  <script src="./bus.js"></script>
  <script src="./auth.js"></script>

  <!-- Firebase init (module) -->
  <script type="module" src="./firebase-init.js"></script>

  <!-- Actions -->
  <script src="./actions.js"></script>

  <!-- Visit logic -->
  <script>
    (function(){
      "use strict";
      const $ = (s,r=document)=>r.querySelector(s);

      // Timer
      let t0 = null, timer = null;
      function startTimer(){
        if(timer) return;
        t0 = Date.now();
        timer = setInterval(()=>{
          const s = Math.floor((Date.now()-t0)/1000);
          const mm = String(Math.floor(s/60)).padStart(2,"0");
          const ss = String(s%60).padStart(2,"0");
          $("#v_timer").textContent = `${mm}:${ss}`;
        }, 250);
      }
      startTimer();

      // Render summary from SSC.db
      function renderSummary(){
        const DB = window.SSC?.db;
        if(!DB) return;
        const c = DB.cases?.[0];
        if(!c) return;

        $("#v_owner").textContent = c.owner?.name || "โ";
        $("#v_symptoms").textContent = c.symptoms || "โ";
        $("#v_status").textContent = c.status || "โ";
        $("#v_decision").textContent = c.decision || "โ";

        const v = c.vitals || {};
        $("#v_vitals").textContent =
          `HR: ${v.hr ?? "โ"} โข SpOโ: ${v.spo2 ?? "โ"} โข Temp: ${v.temp ?? "โ"} โข BP: ${v.bp ?? "โ"}`;
      }

      document.addEventListener("DOMContentLoaded", ()=>{
        renderSummary();
        window.bus?.on?.("case:update", renderSummary);
      });

      // Media controls (local only)
      const video = $("#video");
      const btnCam = $("#btnCam");
      const btnMic = $("#btnMic");
      const btnStop = $("#btnStop");
      const camState = $("#camState");
      const micState = $("#micState");

      let stream = null;

      async function ensureStream(wantVideo, wantAudio){
        if(stream) return stream;

        stream = await navigator.mediaDevices.getUserMedia({
          video: !!wantVideo,
          audio: !!wantAudio
        });
        return stream;
      }

      function applyToVideo(){
        if(video) video.srcObject = stream;
      }

      function updateStates(){
        const vOn = stream && stream.getVideoTracks().some(t=>t.enabled);
        const aOn = stream && stream.getAudioTracks().some(t=>t.enabled);
        camState.textContent = vOn ? "ON" : "OFF";
        micState.textContent = aOn ? "ON" : "OFF";
      }

      btnCam?.addEventListener("click", async ()=>{
        try{
          // create or add video
          if(!stream){
            await ensureStream(true, false);
          } else {
            const hasV = stream.getVideoTracks().length>0;
            if(!hasV){
              const s2 = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
              s2.getVideoTracks().forEach(t=>stream.addTrack(t));
            }
            stream.getVideoTracks().forEach(t=>t.enabled = true);
          }
          applyToVideo(); updateStates();
        } catch(e){ alert("ุชุนุฐุฑ ุชุดุบูู ุงููุงููุฑุง. ุชุญูู ูู ุงูุตูุงุญูุงุช."); console.error(e); }
      });

      btnMic?.addEventListener("click", async ()=>{
        try{
          if(!stream){
            await ensureStream(false, true);
          } else {
            const hasA = stream.getAudioTracks().length>0;
            if(!hasA){
              const s2 = await navigator.mediaDevices.getUserMedia({video:false, audio:true});
              s2.getAudioTracks().forEach(t=>stream.addTrack(t));
            }
            stream.getAudioTracks().forEach(t=>t.enabled = true);
          }
          applyToVideo(); updateStates();
        } catch(e){ alert("ุชุนุฐุฑ ุชุดุบูู ุงููุงูู. ุชุญูู ูู ุงูุตูุงุญูุงุช."); console.error(e); }
      });

      btnStop?.addEventListener("click", ()=>{
        if(!stream) return;
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
        if(video) video.srcObject = null;
        updateStates();
      });

      updateStates();
    })();
  </script>
<script type="module" src="./firebase-init.js"></script>
<script src="./rbac.js"></script>
<script src="./actions.js"></script>

</body>
</html>
