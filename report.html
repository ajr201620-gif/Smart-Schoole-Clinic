<!doctype html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Clinic OS โ ุชูุฑูุฑ ุงูุญุงูุฉ</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <div class="logo">SC</div>
      <div>
        <div class="brand-title">Smart Clinic OS</div>
        <div class="brand-sub">Case Report โ ุชูุฑูุฑ ุงูุญุงูุฉ</div>
      </div>
    </div>

    <div class="top-actions">
      <a class="btn ghost" href="index.html">๐ ุจูุงุจุฉ ุงูุฃุฏูุงุฑ</a>
      <a class="btn ghost" href="demo-hub.html">๐ฌ Demo Hub</a>
      <button class="btn ghost" id="btnTheme">๐</button>
      <button class="btn" id="btnRefresh">ุชุญุฏูุซ ุงูุชูุฑูุฑ</button>
    </div>
  </header>

  <div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="nav-title">ุงูุชูุฑูุฑ</div>
      <nav class="nav">
        <button class="nav-item active" id="navMain">
          <span class="ico">๐งพ</span><span>ุงูุชูุฑูุฑ</span>
        </button>
      </nav>

      <div class="sidebar-foot">
        <div class="pill">
          <span class="dot" id="dotLive"></span>
          <div>
            <div style="font-weight:1000;">Status</div>
            <div class="muted small" id="sysStatus">Ready</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="muted small" style="line-height:1.8;">
          โ ูุนุฑุถ ุขุฎุฑ Case ูู ุงููุธุงู (BUS).<br>
          ุฅุฐุง ูุง ููู Caseุ ูุนุฑุถ Demo ุงูุชุฑุงุถู.
        </div>

        <div class="divider"></div>

        <div class="muted small">
          ุชูููุญ: ุดุบูู ุงูุณููุงุฑูู ูู <b>demo-hub.html</b> ุซู ุงุฑุฌุน ููุง ูุดูู ุงูุชูุฑูุฑ.
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <section class="views">
        <section class="view show">
          <div class="section-head">
            <div>
              <h2>ุชูุฑูุฑ ุงูุญุงูุฉ</h2>
              <div class="muted">PDF-look + QR + ุชูููุน + Audit (Demo)</div>
            </div>
            <div class="section-actions">
              <button class="btn ghost" id="btnOpenLatest">ูุชุญ ุขุฎุฑ ุญุงูุฉ</button>
              <button class="btn ghost" id="btnOpenByHash">ูุชุญ ุญุณุจ ุงูุฑุงุจุท</button>
            </div>
          </div>

          <div class="card" id="reportMount"></div>
        </section>
      </section>
    </main>

  </div>

  <!-- Scripts -->
  <script src="bus.js"></script>
  <script src="report-kit.js"></script>
  <script src="role-switcher.js"></script>

  <script>
    (function(){
      const $ = (s,r=document)=>r.querySelector(s);

      function pulse(){
        $("#dotLive")?.classList.add("pulse");
        setTimeout(()=>$("#dotLive")?.classList.remove("pulse"), 900);
      }

      function setStatus(txt){
        const el = $("#sysStatus");
        if(el) el.textContent = txt;
      }

      // Theme
      $("#btnTheme")?.addEventListener("click", ()=>{
        const html = document.documentElement;
        html.dataset.theme = html.dataset.theme === "light" ? "dark" : "light";
      });

      // Build report using latest case
      function renderLatest(){
        pulse();
        const mount = $("#reportMount");
        if(!mount) return;

        // pull latest case if exists (report-kit also falls back)
        const bus = window.SCBUS?.load?.();
        const latest = bus?.cases?.[0];

        setStatus(latest ? ("Loaded: " + latest.id) : "No case found โ using demo");

        window.SCREPORT.renderInto(mount, {
          school: "ูุฏุฑุณุฉ A",
          doctorName: "ุฏ. ุณุฑุงุฌ (Demo)",
          parentName: "ููู ุฃูุฑ ุงูุทุงูุจ (Demo)",
          // override caseLink so QR opens this report page (clean for judges)
          caseLink: location.origin + location.pathname.replace(/\/[^\/]*$/, "/report.html") + "#case=" + encodeURIComponent(latest?.id || "CASE-DEMO-01"),
          title: "ุชูุฑูุฑ ุญุงูุฉ โ ุงูุนูุงุฏุฉ ุงููุฏุฑุณูุฉ ุงูุฐููุฉ"
        });

        try{ window.SCBUS?.audit?.("REPORT_PAGE_RENDER", { latest: latest?.id || null }); }catch(_){}
      }

      // Open case by URL hash: #case=CASE-XXXX
      function renderFromHash(){
        pulse();
        const mount = $("#reportMount");
        const bus = window.SCBUS?.load?.();
        const id = new URLSearchParams(location.hash.replace(/^#/, "")).get("case");

        if(!id){
          alert("ูุง ููู case ูู ุงูุฑุงุจุท. ูุซุงู:\nreport.html#case=CASE-XXXX");
          return;
        }

        const found = (bus?.cases || []).find(c => c.id === id) || null;

        setStatus(found ? ("Loaded: " + found.id) : ("Not found in bus: " + id + " โ demo"));

        // temporarily swap latest case by putting found at top if exists
        if(found && bus){
          bus.cases = [found].concat((bus.cases || []).filter(x=>x.id!==found.id));
          localStorage.setItem(window.SCBUS.KEY, JSON.stringify(bus));
          localStorage.setItem("sc_bus_ping", String(Date.now()));
        }

        renderLatest();
      }

      $("#btnRefresh")?.addEventListener("click", renderLatest);
      $("#btnOpenLatest")?.addEventListener("click", renderLatest);
      $("#btnOpenByHash")?.addEventListener("click", renderFromHash);

      // auto-refresh when BUS updates (live)
      window.addEventListener("sc:bus:update", ()=>{
        // ุฎููู: ูุง ูุนูุฏ ุฑุณู ุงูุชูุฑูุฑ ุฅุฐุง ุงููุณุชุฎุฏู ูุทุจุนุ ุจุณ ููุง ูุฎููู ููุนูุณ ููุฑูุง
        renderLatest();
      });

      // init
      renderLatest();
    })();
  </script>
  <!-- ุจุงูู ุณูุฑุจุชุงุชู -->
  <script src="./actions.js"></script>

  <!-- Firebase (ูุงุฒู ุขุฎุฑ ุดูุก ููุจู </body>) -->
  <script type="module" src="./firebase-init.js"></script>
</body>
</html>
